# Claude Code Guidelines for QBT Project

## 프로젝트 개요

QBT(Quant BackTest)는 주식 데이터 다운로드 및 관리를 위한 Python CLI 도구입니다.

**현재 상태**: 데이터 다운로드 기능에 집중한 간결한 프레임워크
**향후 계획**: 백테스팅 기능 추가 예정

### 핵심 디렉토리 구조

```
quant/
├── main.py              # CLI 진입점
├── src/qbt/             # 비즈니스 로직 패키지
│   ├── data/           # 데이터 도메인 (다운로드, 저장)
│   └── utils/          # 유틸리티 (로깅 등)
├── data/raw/           # CSV 데이터 저장소
└── pyproject.toml      # Poetry 프로젝트 설정
```

### 기술 스택

- **Python**: 3.10 이상 (Union 타입 구문 `str | None` 사용)
- **패키지 관리**: Poetry
- **데이터 처리**: pandas
- **데이터 소스**: Yahoo Finance (yfinance)
- **코드 품질**: Black (포맷터), Ruff (린터)

## 코딩 스타일 가이드라인

### 코드 포맷팅

- **코드 포맷터**: 이 프로젝트는 **Black** 포맷터를 사용합니다. 모든 Python 코드는 Black 스타일 가이드를 따라 작성되어야 합니다. **별도로 `black` 명령어를 실행하지 마세요**
- **린터**: Ruff를 사용하여 코드 품질을 검사합니다 (pycodestyle, pyflakes, isort, flake8-bugbear, pyupgrade 포함)
- **라인 길이**: 88자 (Black 기본값)
- **타겟 버전**: Python 3.10+

### 이모지 사용 금지

- 코드, 주석, 로그 메시지 등 모든 곳에서 이모지 사용을 피하세요
- 사용자 메시지는 한글로 작성하되, 이모지는 포함하지 않습니다

### 주석 작성 규칙

- **복잡한 로직**: 여러 단계의 처리 흐름이 있을 경우 넘버링 주석으로 단계별 설명
- **주석 업데이트**: 코드 수정 시 관련 주석도 함께 업데이트하여 불일치 방지
- **일반적 표현 사용**: 구체적 수치 대신 일반적 표현 사용 (예: "5회 재시도" → "임계값 초과 시 재시도")
- **소스코드 직접 언급 금지**: CLAUDE.md에는 특정 파일명, 함수명, 클래스명 등을 직접 언급하지 않음

### 코드 구조

- **패키지 구조**: `src/qbt/domain/module.py` 형식으로 도메인별 구분
- **모듈 분리**: 하나의 주요 기능당 하나의 모듈
- **CLI 로직**: 루트의 `main.py`에 위치
- **비즈니스 로직**: `src/qbt/` 패키지 내부에 위치
- **계층 분리**: CLI Layer → Business Logic Layer → External APIs 순으로 명확히 구분

### 네이밍 컨벤션

- **함수**: `snake_case`
- **클래스**: `PascalCase`
- **상수**: `UPPER_SNAKE_CASE`
- **Private 멤버**: `_leading_underscore`

### 타입 힌트

- **필수 적용**: 모든 함수 시그니처에 타입 힌트 작성
- **Python 3.10+ 문법 사용**: `str | None` (Union 타입)

### 문서화

- **Docstring**: 모든 public 함수와 클래스에 Google 스타일 docstring 작성
- **언어**: 한글 우선 (사용자 대상 프로젝트)
- **필수 항목**: Args, Returns, Raises (해당하는 경우)

### 파일 경로 처리

- **pathlib.Path 필수**: 모든 파일 작업에 `pathlib.Path` 사용, 문자열 경로 금지
- **하드코딩 금지**: 프로젝트 루트 기준 상대 경로 사용

### 에러 핸들링

QBT는 계층별로 명확한 에러 처리 책임을 가집니다:

#### CLI Layer (main.py)
- **로거 초기화**: 환경 변수를 읽어 로거 설정
- **최종 예외 처리**: try-except로 모든 예외를 캐치하여 사용자 친화적 에러 메시지 출력
- **종료 코드 반환**: 성공 시 0, 실패 시 1
- **책임 범위**: 커맨드 라우팅, 로깅 설정, 최종 예외 처리

#### Business Logic Layer (src/qbt/)
- **예외 재발생**: 에러 발생 시 로깅 없이 `raise`로 호출자에게 예외 전파
- **명시적 예외**: 가능한 경우 구체적인 예외 타입 사용
- **책임 범위**: 핵심 비즈니스 로직 수행, 데이터 검증

**중요**: 비즈니스 로직에서는 ERROR 레벨 로그를 남기지 않습니다. 에러 로깅은 CLI Layer에서만 수행하여 중복을 방지합니다.

## 개발 원칙

### YAGNI (You Aren't Gonna Need It)

- **사용하지 않는 코드는 미리 만들지 말 것**
- **필요할 때 추가**: 기능은 실제 필요성이 확인된 후에만 구현
- **향후 계획**: 주석으로 임시 처리 가능

### 단순성 우선

- **간결한 코드베이스 유지**: 불필요한 추상화 지양
- **명확한 의도**: 복잡한 패턴보다 읽기 쉬운 코드 우선
- **점진적 발전**: 작은 단위로 기능 추가 및 리팩토링

## 로깅 정책

### 로그 레벨

QBT 프로젝트는 **세 가지 로그 레벨만** 사용합니다:

- **DEBUG**: 개발 중 상세 정보 및 디버깅 메시지
  - 데이터 처리 과정
  - 변수 값 확인
  - 함수 실행 흐름
- **WARNING**: 경고성 메시지
  - 잠재적 문제 상황
  - 권장하지 않는 사용법
- **ERROR**: 에러 발생 시
  - 예외 처리
  - 치명적 오류

**INFO 레벨은 사용하지 않습니다.** 일반 정보는 DEBUG로 처리합니다.

### 사용 방법

- Logger 가져오기: `from qbt.utils import get_logger`
- 로그 레벨 제어: 환경 변수 `QBT_LOG_LEVEL` 사용 (DEBUG, WARNING, ERROR)
- 런타임 레벨 변경: `set_log_level()` 함수 사용

### 로깅 가이드라인

- **메시지는 한글로 작성**: 사용자 대상 프로젝트이므로 한글 사용
- **이모지 사용 금지**: 로그 메시지에 이모지 포함하지 않음
- **간결하고 명확하게**: 불필요한 장황한 설명 지양
- **함수명 자동 포함**: 로그 포맷에 `funcName`이 포함되므로 메시지에 중복 기재 불필요

## 데이터 처리 규칙

### CSV 데이터 저장

- **위치**: `data/raw/` 디렉토리
- **파일명 규칙**:
  - `{TICKER}_max.csv` (전체 기간)
  - `{TICKER}_{START}_{END}.csv` (기간 지정)
  - `{TICKER}_{START}_latest.csv` (시작일만 지정)
- **저장 컬럼**: Date, Open, Close, Volume (4개만)

### 데이터 정제

- **최근 데이터 제외**: 오늘 기준 2일 전까지만 포함 (Yahoo Finance 데이터 안정성 확보)
- **날짜 형식**: Python `date` 객체로 변환
- **불필요한 컬럼 제거**: High, Low, Dividends, Stock Splits 등

## CLI 설계

### 서브커맨드 구조

- **구조**: `python main.py <subcommand> [options]`
- **현재 구현**: `download` (주식 데이터 다운로드)
- **향후 예정**: `backtest` (백테스팅 실행)

### 계층 구조

QBT CLI는 단순한 2계층 구조를 사용합니다:

1. **CLI Layer** (`main.py`)
   - 로거 초기화 (환경 변수 기반)
   - 커맨드 파싱 (argparse)
   - 비즈니스 로직 직접 호출
   - 최종 예외 처리 및 종료 코드 반환

2. **Business Logic Layer** (`src/qbt/`)
   - 핵심 기능 수행
   - 데이터 검증
   - 예외 재발생

main.py는 단순한 커맨드 라우터 역할을 하며, 별도의 커맨드 핸들러 함수 없이 비즈니스 로직을 직접 호출합니다.

## 의존성 관리

### 프로덕션 의존성

- `pandas ^2.0.0`: 데이터 분석 및 조작
- `yfinance ^0.2.0`: Yahoo Finance API 클라이언트

### 개발 의존성

- `black ^23.0.0`: 코드 포맷터 (수동 실행 금지)
- `ruff ^0.8.0`: 린터

## 프로젝트 철학

1. **간결성**: 필요한 것만 구현
2. **확장성**: 도메인별 모듈 분리로 기능 추가 용이
3. **가독성**: 명확한 주석과 타입 힌트
4. **사용자 중심**: 한글 메시지, 직관적인 CLI

## 참고사항

- 이 가이드라인은 프로젝트 발전에 따라 업데이트됩니다
- 새로운 도메인 추가 시 `src/qbt/` 아래에 패키지 생성
- 복잡한 기능은 여러 모듈로 분리하되, 과도한 분리는 지양
