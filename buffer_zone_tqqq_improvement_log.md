# 버퍼존 전략 (TQQQ) 개선 작업 로그

> 작성 시작: 2026-02-21
> 목적: 버퍼존 TQQQ 전략의 성과 분석 및 단계적 개선을 위한 히스토리 문서
> 참고 대상: 이 프로젝트를 분석하는 모든 AI 모델 및 개발자
> 업데이트 방식: 새로운 분석/논의/개선이 있을 때마다 하단에 섹션 추가

## 최신 결론 (TL;DR)

- **QQQ 전략**: WFO 검증 통과. Fully Fixed(MA=200, buy=0.01, sell=0.05, hold=2, recent=8)가 Dynamic보다 우수 → **파라미터 고정 운용 가능**
- **TQQQ 전략**: Dynamic WFO Stitched CAGR 21.68%, MDD **-62.09%** (기존 단일 백테스트 MDD -88% → 26pp 개선). WFE 폭주(-161) / PC 경고(0.67) 존재
- **TQQQ ATR 전략**: Phase 1~3 구현 완료. ATR TQQQ Dynamic WFO Stitched CAGR 16.09%, MDD **-52.95%** (기존 -62.09% → 9.14pp 개선). **목표 MDD -50%에 2.95pp 미달**
- **공통 발견**: sell_buffer=0.05가 두 전략 모두에서 가장 안정적. "Tight Entry, Wide Exit" 패턴은 구조적 특성
- **ATR 결과**: ATR(14, 3.0)이 전 윈도우 수렴. WFE 폭주 해소(-161 → 5.37). Profit Concentration 경고 해제(0.67 → 0.48). ATR source QQQ 고정(사용자 결정)
- **다음 실험**: ATR multiplier 2.5 재실험 (MDD -50% 달성 도전) / Fully Fixed(MA=150, ATR=14, mult=3.0) 단일 백테스트 검증

---

## 연구 방법론

이 문서의 모든 연구 및 분석은 **웹 리서치(Web Research)**를 기본으로 합니다.

- 이론적 근거: 학술 논문, 금융 리서치 기관 자료, ETF 발행사 공시 등 외부 출처 참조
- 실증 분석: 프로젝트 내 실제 데이터(equity.csv, trades.csv, grid_results.csv 등)와 비교 검증
- 결론 도출: 웹 리서치 + 코드/데이터 분석을 통합해 근거 있는 방향 제시

---

## 목차

**배경**

1. [프로젝트 구조 및 도메인 이해](#1-프로젝트-구조-및-도메인-이해) — 루트 CLAUDE.md 참조
2. [버퍼존 전략 상세 설명](#2-버퍼존-전략-상세-설명)
3. [백테스트 핵심 규칙](#3-백테스트-핵심-규칙)
4. [데이터 소스 및 파일 구조](#4-데이터-소스-및-파일-구조)

**초기 연구**

5. [Session 1 — 전략별 성과 비교 분석](#5-session-1--전략별-성과-비교-분석)
6. [Session 2 — 분할 매수 도입 가능성 연구](#6-session-2--분할-매수-도입-가능성-연구)
7. [Session 3 — 시계열 데이터 심층 분석 및 개선 방향](#7-session-3--시계열-데이터-심층-분석-및-개선-방향)
8. [현재까지 도출된 개선 방향 요약](#8-현재까지-도출된-개선-방향-요약)
9. [앞으로의 개선 계획](#9-앞으로의-개선-계획)
10. [Session 4 — AI 모델 간 토론](#10-session-4--ai-모델-간-토론-외부-ai-분석-검토-및-반론)
11. [Session 5 — 매수/매도 버퍼 분리 구현 완료](#11-session-5--매수매도-버퍼-분리-구현-완료)

**Claude/GPT 교대 토론**

12. [Session 6 (Claude) — 버퍼 분리 성과 비교 + 과최적화 리스크 분석](#12-session-6-claude-opus-46--2026-02-22-1200-kst)
13. [Session 7 (GPT) — WFO 아키텍처 제안](#13-session-7-gpt-52-thinking--2026-02-22-1510-kst)
14. [Session 8 (Claude) — WFO 아키텍처 검토 + 구현 방향 결정](#14-session-8-claude-opus-46--2026-02-22-1630-kst)
15. [Session 9 (Claude) — WFO 결과 분석: QQQ 안정성 확인 vs TQQQ 과최적화 실증](#15-session-9-claude-opus-46--2026-02-22-2330-kst)
16. [Session 10 (GPT) — 3-Mode 독립 검토 + WFE 지표 문제 + 다음 액션](#16-session-10-gpt-52-thinking--2026-02-22-1545-kst)
17. [Session 11 (GPT) — Profit Concentration/WFE 보강 + ATR WFO 통합 제안](#17-session-11-gpt-52-thinking--2026-02-22-1605-kst)
18. [Session 12 (Claude) — WFE/PC 설계 + ATR 아키텍처 + 2020-03 MDD 해부](#18-session-12-claude-opus-46--2026-02-22-1730-kst)
19. [Session 13 (GPT) — WFO 재검증 + WFE 정의 정확화 + ATR Phase 1 보강](#19-session-13-gpt-52-thinking--2026-02-22-1810-kst)
20. [Session 14 (Claude) — PC/WFE 확정 + ATR 시그널 소스 수정 + 구현 스펙](#20-session-14-claude-opus-46--2026-02-22-2140-kst)
21. [토론 합의 현황 (Session 9-14 기준)](#21-토론-합의-현황-session-9-14-기준)
22. [Session 15 (GPT) — Phase 1~3 합의안 점검 + ATR 미합의(A/B/C) 종결 실험 설계](#22-session-15-gpt-52-thinking--2026-02-22-2235-kst)
23. [Session 16 (Claude) — Phase 1~3 구현 완료 + ATR WFO 결과: Stitched MDD -52.95%, ATR(14,3.0) 전윈도우 수렴](#23-session-16-claude-sonnet-46--2026-02-23-1616-kst)

---

## 1. 프로젝트 구조 및 도메인 이해

> 프로젝트 구조, 디렉토리 구조, 아키텍처 원칙은 **루트 `CLAUDE.md`**를 참조하세요.
> 이 연구 문서는 `CLAUDE.md`를 사전 숙지한 AI 모델을 대상으로 작성되었습니다.
> 아래 §2~§4는 `CLAUDE.md`에 없는 이 연구 특화 도메인 맥락(전략 설계, 백테스트 규칙, 데이터 구조)을 보완합니다.

---

## 2. 버퍼존 전략 상세 설명

### 2.1 전략 개념

버퍼존 전략은 **이동평균(MA) 기반 추세 추종 전략**입니다.
이동평균선 주변에 "버퍼존(완충 구간)"을 설정하고, 가격이 이 구간을 명확히 이탈할 때만 거래합니다.

핵심 철학: **"노이즈를 걸러내고 명확한 추세에서만 진입"**

**신호 방향 (절대 규칙):**

- **매수 신호**: 가격이 상단 밴드를 **상향 돌파** (`prev_close <= upper_band AND close > upper_band`)
- **매도 신호**: 가격이 하단 밴드를 **하향 돌파** (`prev_close >= lower_band AND close < lower_band`)
- 매수는 hold_days 상태머신 적용 (돌파 후 N일 유지 확인), 매도는 hold_days 없이 즉시 다음날 시가에 체결

### 2.2 밴드 계산

```
upper_band = MA × (1 + buffer_zone_pct)
lower_band = MA × (1 - buffer_zone_pct)
```

예시 (MA=100, buffer_zone_pct=0.04):

- 상단 밴드 = 104 → 이 위로 올라오면 매수 신호
- 하단 밴드 = 96 → 이 아래로 내려가면 매도 신호

### 2.3 버퍼존 TQQQ vs 버퍼존 QQQ 차이

| 구분           | 버퍼존 TQQQ                                         | 버퍼존 QQQ        |
| -------------- | --------------------------------------------------- | ----------------- |
| 시그널 소스    | QQQ 가격                                            | QQQ 가격          |
| 실제 매매 대상 | TQQQ 합성 데이터                                    | QQQ               |
| 특징           | QQQ 추세로 판단, TQQQ로 레버리지 수익               | 시그널=매매 동일  |
| 데이터 파일    | signal: QQQ_max.csv / trade: TQQQ_synthetic_max.csv | 둘 다 QQQ_max.csv |

**핵심**: 버퍼존 TQQQ는 QQQ의 이동평균 신호로 진입/청산 타이밍을 잡고, 실제 자산은 3배 레버리지인 TQQQ 합성 데이터로 매매합니다. 시그널 소스(QQQ)와 매매 소스(TQQQ)가 분리되어 있기 때문에 `extract_overlap_period`를 통해 기간을 맞춥니다.

### 2.4 전략 파라미터

```python
# buffer_zone_tqqq.py 기준 (grid_best 기준 최적 파라미터)
ma_window        = 150      # EMA 기간 (일)
ma_type          = "ema"    # 이동평균 유형
buffer_zone_pct  = 0.04     # 버퍼존 비율 (0.04 = 4%)
hold_days        = 3        # 유지 조건 일수
recent_months    = 2        # 동적 조정 기간 (개월)
initial_capital  = 10_000_000  # 초기 자본 (원)
```

### 2.5 파라미터 결정 폴백 체인

```
1순위: OVERRIDE 상수 (코드에 하드코딩된 강제 값)
2순위: grid_results.csv 의 CAGR 1위 파라미터 (load_best_grid_params)
3순위: DEFAULT 상수 (constants.py 기본값)
```

이 체인은 `resolve_buffer_params()` → `resolve_params()` 구조로 구현됩니다.

### 2.6 동적 파라미터 조정 메커니즘

최근 `recent_months` 기간 내 매수 횟수(`recent_buy_count`)가 늘어날수록 버퍼존과 유지 조건을 자동으로 강화합니다:

```python
adjusted_buffer_pct  = base_buffer_pct + (recent_buy_count × 0.01)
adjusted_hold_days   = base_hold_days  + (recent_buy_count × 1)
```

목적: 연속 매수 발생 시 더 신중하게 진입해서 휩소(whipsaw) 방지.

---

## 3. 백테스트 핵심 규칙

### 3.1 비용 모델

```
매수 체결가 = 시가 × (1 + 0.003)   # SLIPPAGE_RATE = 0.003 (0.3%, 슬리피지+수수료 통합)
매도 체결가 = 시가 × (1 - 0.003)
```

### 3.2 체결 타이밍 (절대 규칙)

lookahead bias 방지를 위한 엄격한 분리:

```
신호 발생: i일 종가 기준으로 상단/하단 밴드 돌파 감지
매수 체결: (i + hold_days + 1)일 시가 (hold_days 유지 확인 후)
매도 체결: (i + 1)일 시가 (hold_days 미적용, 즉시 pending)
```

매수 예시 (hold_days=3):

- i일: 상단 밴드 돌파 감지 → hold_state 상태머신 진입
- i+1 ~ i+3일: 유지 조건 체크 (상단 밴드 위 유지되는지 확인)
- i+3일 종가: 신호 확정 → pending order 생성
- i+4일 시가: 실제 매수 체결

매도 예시:

- i일: 하단 밴드 이탈 감지 → 즉시 pending order 생성
- i+1일 시가: 실제 매도 체결

### 3.3 Equity 정의

```
Equity = cash + position_shares × close_price
```

- **Final Capital** = 마지막 날 equity (강제청산 없음)
- 현금 보유 구간에서는 equity가 변하지 않음
- 미청산 포지션이 있어도 강제 청산하지 않음 → summary에 `open_position` 포함

### 3.4 Pending Order 정책 (절대 규칙)

- `pending_order`는 단일 변수로만 관리 (리스트 누적 금지)
- 신호일에 생성, 체결일에 실행 후 `None` 초기화
- **Critical Invariant**: pending_order가 존재하는 동안 새 신호 발생 시 `PendingOrderConflictError` 예외

### 3.5 마지막 날 규칙

- N-1일 종가 신호 → N일 시가 정상 체결
- N일 종가 신호 → N+1일 시가가 없으므로 무시
- 강제청산 없음: 마지막 날 포지션 보유 시 summary에 `open_position` 기록

### 3.6 성과 지표 계산

```python
총 수익률  = (final_capital - initial_capital) / initial_capital × 100
CAGR       = ((final_capital / initial_capital) ^ (252 / 총일수)) - 1
MDD        = 자본 곡선에서 누적 최고점 대비 최대 낙폭
승률       = winning_trades / total_trades × 100
```

### 3.7 그리드 서치

- 병렬 처리 기반 (ProcessPoolExecutor)
- 탐색 파라미터: `ma_window`, `buffer_zone_pct`, `hold_days`, `recent_months`
- 결과: `grid_results.csv` (CAGR 내림차순 저장)
- 현재 최적 파라미터는 grid_results.csv 1행에서 자동 로딩

---

## 4. 데이터 소스 및 파일 구조

### 4.1 TQQQ 합성 데이터

TQQQ는 **2010-02-09에 상장**(ProShares, inception date)되었지만, 백테스트는 1999년부터 시작합니다.
`TQQQ_synthetic_max.csv`는 1999년부터 QQQ 가격 데이터를 기반으로 역산한 **합성 데이터**입니다.

이 합성 데이터는 `scripts/tqqq/generate_synthetic.py`로 생성됩니다.

**합성 비용 모델 (`src/qbt/tqqq/simulation.py` — `_calculate_daily_cost`):**
단순 QQQ × 3이 아닌, 실제 3배 레버리지 ETF의 비용 구조를 정밀하게 모델링합니다:

```
일일 비용 = (annual_cost) / 252거래일

annual_cost = leverage_cost + expense_ratio
leverage_cost = (FFR + softplus_spread(a, b, FFR)) × (leverage - 1)
           # 차입 비용 = 연방기금금리 + 동적 스프레드 × 2배 차입분

softplus_spread = softplus(a + b × FFR_pct)
           # Softplus 함수: 저금리→낮은 스프레드, 고금리→높은 스프레드 (S자 곡선)

expense_ratio = TQQQ 운용보수 (월별 실제 데이터)
FFR = 연방기금금리 (월별 실제 데이터)
```

이후 TQQQ 상장 시점(2010년)의 실제 가격으로 스케일링해 병합합니다. 이 과정에서 `tqqq/spread_lab/`의 워크포워드 검증으로 softplus 파라미터를 최적화합니다.

**이 비용 모델은 이 프로젝트의 핵심 강점입니다.** 단순 3배 역산 대비 닷컴버블/금융위기 시기의 비용 현실을 더 정확히 반영합니다.

> **강조**: 합성 TQQQ가 "단순 QQQ × 3"이라는 오해를 방지합니다.
> FFR이 5% 이상이었던 2000~2001년, 2006~2007년 구간에서 동적 스프레드(softplus)가
> 레버리지 비용을 추가로 반영하므로 해당 구간의 합성 수익률이 QQQ × 3보다 더 낮게 산출됩니다.
> 이는 실제 TQQQ 운용 현실과 더 가까운 모델입니다.
>
> **한계**: 1999~2010 구간은 합성 데이터이므로, 실제 TQQQ가 경험하지 않은 시장 조건(예: 닷컴버블 당시의 실제 레버리지 ETF 운용 비용)이 모델 가정에 의존합니다. 이 구간의 결과 해석에는 주의가 필요합니다.

### 4.2 결과 파일 구조

```
storage/results/backtest/buffer_zone_tqqq/
├── signal.csv      # OHLC + MA + 상/하단 밴드 + 전일대비% (시그널 데이터)
├── equity.csv      # Date, equity, position, buffer_zone_pct, upper_band, lower_band, drawdown_pct
├── trades.csv      # entry_date, exit_date, entry_price, exit_price, shares, pnl, pnl_pct, buffer_zone_pct, hold_days_used, recent_buy_count, holding_days
├── summary.json    # 요약 지표 + 파라미터 + 월별 수익률 + open_position
└── grid_results.csv # 이평기간, 버퍼존, 유지일, 조정기간, 수익률, CAGR, MDD, 거래수, 승률, 최종자본 (CAGR 내림차순)
```

### 4.3 재현 방법

주요 산출물을 재현하는 CLI 명령어입니다. 모든 명령은 프로젝트 루트에서 실행합니다.

```bash
# 1. 합성 TQQQ 데이터 생성 (§4.1의 비용 모델 적용)
poetry run python scripts/tqqq/generate_synthetic.py

# 2. 그리드 서치 실행 (432~4200 조합, 병렬 처리)
poetry run python scripts/backtest/run_grid_search.py --strategy buffer_zone_tqqq
poetry run python scripts/backtest/run_grid_search.py --strategy buffer_zone_qqq

# 3. 단일 백테스트 (grid_best 기준)
poetry run python scripts/backtest/run_single_backtest.py --strategy buffer_zone_tqqq

# 4. WFO 실행 (3-Mode 비교, Expanding Anchored + Calmar 목적함수)
poetry run python scripts/backtest/run_walkforward.py --strategy buffer_zone_tqqq
poetry run python scripts/backtest/run_walkforward.py --strategy buffer_zone_qqq
```

결과 파일 위치:

- 백테스트: `storage/results/backtest/{strategy_name}/`
- WFO: `storage/results/backtest/{strategy_name}/walkforward_*.csv`, `walkforward_summary.json`

> 환경: Python 3.12, Poetry, 최신 커밋 기준. 각 스크립트의 `--help`로 상세 옵션 확인.

---

## 5. Session 1 — 전략별 성과 비교 분석

**날짜**: 2026-02-21

### 5.1 분석 대상 4개 전략

| 전략명             | 코드 위치                        | 설명                               |
| ------------------ | -------------------------------- | ---------------------------------- |
| 버퍼존 전략 (TQQQ) | `strategies/buffer_zone_tqqq.py` | QQQ 시그널 + TQQQ 합성 데이터 매매 |
| 버퍼존 전략 (QQQ)  | `strategies/buffer_zone_qqq.py`  | QQQ 시그널 + QQQ 매매              |
| Buy & Hold (QQQ)   | `strategies/buy_and_hold.py`     | QQQ 단순 매수 후 보유              |
| Buy & Hold (TQQQ)  | `strategies/buy_and_hold.py`     | TQQQ 합성 데이터 단순 매수 후 보유 |

### 5.2 핵심 지표 비교

**분석 기간**: 1999-03-10 ~ 2026-02-17 (약 27년)
**초기 자본**: 10,000,000원

| 지표             | 버퍼존 (TQQQ)   | 버퍼존 (QQQ)  | Buy & Hold (QQQ) | Buy & Hold (TQQQ) |
| ---------------- | --------------- | ------------- | ---------------- | ----------------- |
| **최종 자본**    | 1,442,622,674원 | 159,073,095원 | 138,832,962원    | 12,878,086원      |
| **총 수익률**    | **+14,326%**    | +1,491%       | +1,288%          | +29%              |
| **CAGR**         | **+20.26%**     | +10.81%       | +10.26%          | +0.94%            |
| **MDD**          | -85.68%         | **-42.83%**   | -82.96%          | -99.98%           |
| **Calmar Ratio** | 0.237           | **0.252**     | 0.124            | 0.009             |
| **총 거래 수**   | 16회            | 14회          | -                | -                 |
| **승률**         | 68.75%          | **78.57%**    | -                | -                 |

> **Calmar Ratio** = CAGR / |MDD|. 높을수록 단위 리스크당 수익이 좋음.

### 5.3 전략별 최적 파라미터 (summary.json에서 확인된 grid_best 기준)

**버퍼존 TQQQ** (`storage/results/backtest/buffer_zone_tqqq/summary.json`):

```json
{
  "ma_window": 150,
  "ma_type": "ema",
  "buffer_zone_pct": 0.04,
  "hold_days": 3,
  "recent_months": 2
}
```

**버퍼존 QQQ** (`storage/results/backtest/buffer_zone_qqq/summary.json`):

```json
{
  "ma_window": 150,
  "ma_type": "ema",
  "buffer_zone_pct": 0.05,
  "hold_days": 2,
  "recent_months": 8
}
```

### 5.4 시장 국면별 비교

| 시장 국면                 | 버퍼존 TQQQ            | 버퍼존 QQQ         | B&H QQQ     | B&H TQQQ    |
| ------------------------- | ---------------------- | ------------------ | ----------- | ----------- |
| 닷컴버블 붕괴 (2000~2003) | 현금 보유 (대부분 0%)  | 현금 보유          | -83% MDD    | 사실상 전멸 |
| 금융위기 (2008~2009)      | 대부분 현금 보유       | 대부분 현금 보유   | 극심한 하락 | 극심한 하락 |
| 코로나 (2020.3)           | 부분 손실 후 빠른 복구 | 소폭 손실          | -7.29%      | -38%        |
| 인플레이션 (2022 전체)    | 현금 보유 (0%)         | 현금 보유 (0%)     | 누적 -35%↓  | 누적 -70%↓  |
| 상승장 (2017, 2020~2021)  | 월 10~35% 수익 발생    | 월 3~11% 수익 발생 | 완전 참여   | 완전 참여   |

### 5.5 종합 평가

```
절대수익 순위:    버퍼존 TQQQ > 버퍼존 QQQ > B&H QQQ >> B&H TQQQ
위험조정 순위:    버퍼존 QQQ > 버퍼존 TQQQ > B&H QQQ >> B&H TQQQ
심리적 수용성:    버퍼존 QQQ > B&H QQQ > 버퍼존 TQQQ >> B&H TQQQ
```

**주요 인사이트:**

- B&H TQQQ: CAGR 0.94%, MDD -99.98% → 레버리지 상품의 **변동성 감쇄(Volatility Decay)** 효과로 장기 단순 보유는 파국. **TQQQ는 반드시 추세 추종 전략과 결합 필요.**
- 버퍼존 전략의 효용 검증: 버퍼존 QQQ는 B&H QQQ 대비 CAGR 거의 동일(+0.55%p)하지만 MDD를 절반 이하로 감소.

### 5.6 결정: 버퍼존 TQQQ 선택

- 수익 극대화 방향으로 버퍼존 TQQQ를 기반으로 개선 진행
- MDD -85.68%를 줄이는 것이 핵심 목표

> **초보자 요약**: 4가지 전략을 비교한 결과, "TQQQ를 그냥 들고 있으면 망한다"는 것이 핵심 발견입니다.
> **변동성 감쇄(Volatility Decay)**: 레버리지 ETF는 매일 복리로 계산하기 때문에, 주가가 오르락내리락할수록 "복리의 역풍"을 맞습니다. 고속도로(상승장)에서는 빠르지만, 커브(변동장)가 올 때마다 속도를 잃어 결국 일반 차(QQQ)보다 뒤처지는 레이싱카와 같습니다.
> 그래서 TQQQ는 반드시 "언제 타고 언제 내릴지"를 정하는 버퍼존 전략과 결합해야 합니다.

---

## 6. Session 2 — 분할 매수 도입 가능성 연구

**날짜**: 2026-02-21
**질문**: 버퍼존은 상승을 확인한 후 들어가는 거라 진입 타이밍이 늦는 단점이 있어. 이러한 상태에서 분할 매수하는 것이 올바른 선택일까?

### 6.1 버퍼존 전략의 진입 타이밍 구조 재확인

진입 구조는 §3.2 참조. 사용자가 지적한 문제: "상승 확인 후 들어가서 이미 많이 오른 상태에서 진입"

### 6.2 웹 리서치 결과

**[Vanguard 연구](https://corporate.vanguard.com/content/dam/corp/research/pdf/cost_averaging_invest_now_or_temporarily_hold_your_cash.pdf)** (1차 출처):

- 시장이 우상향하는 국면에서 일괄 투자(Lump Sum)가 DCA 대비 **75% 확률로 우위**
- 평균 초과수익: 2.4% (전체 주식 포트폴리오 기준)

**UConn 학술 연구**:

- 순수 모멘텀 전략에서 Lump Sum이 DCA보다 **32bp 우위**
- 하락 추세에서만 DCA가 유리

**SetupAlpha 리서치**:

- 3x 레버리지 ETF 전략에서 트레일링 스탑 적용 시 CAGR 23.8%, MDD 38.7% 달성 사례

### 6.3 분할 매수가 오히려 역효과인 이유

| 구분      | 버퍼존 전략             | 분할 매수          |
| --------- | ----------------------- | ------------------ |
| 전제      | 추세가 확인됨 (상승 중) | 방향이 불확실함    |
| 적합 국면 | 추세 추종               | 변동성 완화        |
| 진입 행동 | 확신하고 전량 진입      | 의심하며 분산 진입 |

> **핵심 논리**: 버퍼존은 "상승 추세 확인 → 진입"이라는 **확신의 신호**입니다.
> 이 신호에 분할 매수를 붙이는 것은 "확인했지만 반은 믿지 못하겠다"는 논리 모순입니다.
> TQQQ 레버리지 특성상 진입 지연은 복리 효과 손실을 의미합니다.

### 6.4 진입 타이밍 문제의 올바른 해결 방향

분할 매수는 "진입 타이밍 지연" 문제를 해결하지 못하고 오히려 악화시킵니다.
올바른 해결 방향은 **신호 생성 속도** 또는 **청산 타이밍** 개선입니다:

| 해결책               | 방법                     | 기대 효과      | 부작용           |
| -------------------- | ------------------------ | -------------- | ---------------- |
| `hold_days` 단축     | 3일 → 1~2일              | 진입 앞당김    | 노이즈 신호 증가 |
| 버퍼존 축소          | 4% → 2~3%                | 신호 빨리 발생 | 허위 신호 증가   |
| ATR 기반 동적 버퍼존 | 변동성 낮을 때 버퍼 줄임 | 추세별 최적화  | 구현 복잡도 상승 |
| **청산 타이밍 개선** | 트레일링 스탑 추가       | **MDD 감소**   | 조기 청산 리스크 |

### 6.5 결론

**분할 매수는 버퍼존 전략에 적합하지 않습니다.**
분할 매수가 의미 있는 유일한 경우는 심리적 안정을 위한 도구로서(Schwab 연구)이며, 전략적 성과 개선 효과는 없습니다.

진입 타이밍보다 **청산 타이밍 개선(트레일링 스탑)** 이 더 효과적인 개선 방향으로 확인되었습니다.

> **초보자 요약**: 버퍼존 전략이 "상승 추세를 확인하고 진입하라"는 신호를 줬는데, 여기에 **분할 매수(DCA)**를 붙이는 것은 "확인했지만 반은 안 믿겠다"는 논리 모순입니다.
> **DCA (Dollar-Cost Averaging)**: 한 번에 사지 않고 여러 번 나눠 사는 방법. 방향이 불확실할 때 유리하지만, 버퍼존처럼 이미 방향을 확인한 전략에는 맞지 않습니다.
> **트레일링 스탑(Trailing Stop)**: 최고점에서 일정 % 하락하면 자동으로 파는 안전장치. "들어가는 타이밍"보다 "나가는 타이밍"을 개선하는 것이 핵심 결론입니다.

---

## 7. Session 3 — 시계열 데이터 심층 분석 및 개선 방향

**날짜**: 2026-02-21
**질문**: `storage/results/backtest/buffer_zone_tqqq` 시계열 데이터를 분석해서 어떠한 방향으로 개선하면 좋을지 연구, 분석해줘

### 7.1 trades.csv 전체 거래 내역

```
 # 진입일          청산일          진입가         청산가         PnL(%)   보유일
 1 1999-04-08    2000-04-17    44.969471     65.370352    +45.37%   375일
 2 2000-06-19    2000-09-22    88.590163     59.774334    -32.53%    95일  ← 손실
 3 2003-03-24    2004-07-27     0.219900      0.374764    +70.43%   491일
 4 2004-11-02    2005-04-18     0.462894      0.366010    -20.93%   167일  ← 손실
 5 2005-07-20    2006-05-19     0.503868      0.449078    -10.87%   303일  ← 손실
 6 2006-10-10    2008-01-09     0.493206      0.538353     +9.15%   456일
 7 2008-05-07    2008-07-03     0.555779      0.414298    -25.46%    57일  ← 손실
 8 2009-05-05    2010-06-30     0.115948      0.189646    +63.56%   421일
 9 2010-09-17    2011-08-09     0.257965      0.288113    +11.69%   326일
10 2011-11-09    2012-11-15     0.381327      0.444508    +16.57%   372일
11 2013-03-13    2015-08-24     0.600231      1.488287   +147.95%   894일
12 2015-10-29    2016-01-11     2.397584      1.849997    -22.84%    74일  ← 손실
13 2016-07-20    2018-10-25     2.206265      6.078874   +175.53%   827일
14 2019-03-18    2020-03-10     6.636726      8.105240    +22.13%   358일
15 2020-04-20    2022-01-24     7.819365     25.682091   +228.44%   644일
16 2023-02-07    2025-03-11    11.974996     29.367288   +145.24%   763일
```

**현재 오픈 포지션** (미청산, 2025-05-16 진입):

```json
{
  "entry_date": "2025-05-16",
  "entry_price": 35.472617,
  "shares": 29837078
}
```

### 7.2 손실 거래 패턴 분류

| 거래 | 기간                    | 손실률  | 보유일 | 발생 배경                       |
| ---- | ----------------------- | ------- | ------ | ------------------------------- |
| #2   | 2000-06-19 ~ 2000-09-22 | -32.53% | 95일   | 닷컴버블 붕괴 중 반등 포착 실패 |
| #4   | 2004-11-02 ~ 2005-04-18 | -20.93% | 167일  | 닷컴 회복기 변동성              |
| #5   | 2005-07-20 ~ 2006-05-19 | -10.87% | 303일  | 횡보장 장기 보유                |
| #7   | 2008-05-07 ~ 2008-07-03 | -25.46% | 57일   | 금융위기 중 반등 포착 실패      |
| #12  | 2015-10-29 ~ 2016-01-11 | -22.84% | 74일   | 변동성 구간 단기 손실           |

**공통 패턴:**

- 하락 추세 또는 변동성 구간에서 반등을 잘못 포착
- 진입 후 30일 내 손실은 대부분 -12% 이하로 시작 → 초기에는 정상처럼 보임
- 최저점에서 청산 (하단 밴드 이탈 신호가 바닥에서 발동)

### 7.3 MDD -85.68% 원인 분석

**MDD 최저점**: 2009-05-13
**해당 시점 Equity**: 7,990,703원
**포지션 상태**: 투자 중 (거래 #8 진입 8일째)

```
MDD는 단일 사건이 아닌 복수 손실의 누적입니다:

1999~2000: 닷컴버블 고점 물림 → 거래 #1 내부 MDD -73.95%
2000:      반등 포착 실패 → 거래 #2 -32.53% 확정 손실
2001~2003: 현금 보유로 대기 (회복 기회 없음)
2004~2008: 손실 3연타 (거래 #4, #5, #7)
2009-05:   금융위기 바닥 반등 진입 → 누적 소진 끝 → MDD 최저
```

### 7.4 거래별 내부 MDD 분석 (equity.csv 기반)

```
 # 진입일          결과     거래내MDD   MDD발생일          진입후10d   진입후30d
 1 1999-04-08      WIN    -73.95%    청산일 당일        -30.16%    -30.16%
 2 2000-06-19     LOSS    -43.92%    청산일 당일         -1.87%    -19.24%
 3 2003-03-24      WIN    -35.94%    청산일 전날         -2.39%     -9.95%
 4 2004-11-02     LOSS    -38.19%    청산일 당일          0.00%      0.00%
 5 2005-07-20     LOSS    -30.76%    청산일 전날         -1.11%     -6.77%
 6 2006-10-10      WIN    -41.73%    청산일 전날         -2.44%     -4.51%
 7 2008-05-07     LOSS    -32.28%    청산일 전날          0.00%      0.00%
 8 2009-05-05      WIN    -40.30%    청산일 당일         -5.38%    -19.36%
 9 2010-09-17      WIN    -40.10%    청산일 전날          0.00%      0.00%
10 2011-11-09      WIN    -31.94%    2012-06-01         -0.71%     -6.56%
11 2013-03-13      WIN    -41.27%    청산일 당일         -0.06%     -4.79%
12 2015-10-29     LOSS    -26.86%    청산일 3일 전       -4.33%    -12.63%
13 2016-07-20      WIN    -32.52%    청산일 전날         -1.39%     -4.41%
14 2019-03-18      WIN    -48.14%    청산일 당일         -3.03%    -15.90%
15 2020-04-20      WIN    -39.38%    청산일 당일         -5.25%    -18.63%
16 2023-02-07      WIN    -37.37%    2024-08-07         -3.69%    -16.66%
```

**평균 내부 MDD:**

- 손실 거래 (5건): 평균 -34.4%
- 승리 거래 (11건): 평균 -41.9%
- 전체: **평균 -39.7%**

### 7.5 치명적 패턴 발견: "청산일 = MDD 최저점"

> 16개 거래 중 **10개(62.5%)의 내부 MDD가 청산일 당일 또는 전날** 발생합니다.

**이것이 의미하는 바:**
현재 전략의 청산 신호(하단 밴드 하향 돌파)는 **이미 크게 하락한 직후에 발동**됩니다.
즉, 전략이 바닥 근처에서 팔고 있습니다.

> ⚠️ **정정 (2026-02-21)**: 이전 표현 "청산 신호(상단 밴드 이탈)"는 오기입니다.
> 코드 기준: 매수 = 상단 밴드 상향 돌파, **매도 = 하단 밴드 하향 돌파**.
> 분석 결론("청산이 늦다")은 동일하게 유효합니다.

또한 **승리 거래도 내부 MDD가 -30% ~ -74%에 달합니다.** 이것을 버텨야만 최종 수익이 납니다.

### 7.6 MAE(Maximum Adverse Excursion) 요약

- 진입 후 10일 내 평균 최대 손실: **-6.48%**
- 진입 후 30일 내 평균 최대 손실: **-10.53%**
- 가장 빠른 하락: 거래 #1 (진입 후 10일 내 -30.16%)
- 진입 직후 하락 없는 케이스: 거래 #4, #7, #9 (초기에는 정상처럼 보이다가 후에 손실)

### 7.7 그리드 서치 결과 분석 (grid_results.csv 상위 5개)

```
이평기간  버퍼존   유지일  조정기간(월)  수익률      CAGR    MDD      거래수  승률
150      0.04     3      2           14326.23   20.26   -85.68   16    68.75  ← 현재 최적
150      0.05     2      6/8         14106.70   20.20   -89.35   14    71.43
150      0.05     2      12          13561.69   20.02   -87.88   14    71.43
150      0.05     2      0           13518.54   20.01   -89.79   15    66.67
150      0.04     3      8           13144.32   19.88   -85.81   16    68.75
```

**인사이트:**

- MDD를 줄이는 파라미터 조합이 그리드 서치 상위에 존재하지 않음
- 현재 그리드 서치는 CAGR만 최적화 → MDD 개선은 구조적 변경 필요
- 이평 200일, 버퍼존 1%, 유지일 1일, 조정기간 12개월: CAGR 19.16%, MDD -84.0% (아주 약간 개선)

### 7.8 웹 리서치 결과 종합

**ATR 트레일링 스탑 근거:**

- [StockCharts — ATR Trailing Stops (ChartSchool)](https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-indicators/atr-trailing-stops): ATR 기반 트레일링 스탑의 표준 정의 및 구현 방법
- [Meb Faber — A Quantitative Approach to Tactical Asset Allocation (SSRN)](https://mebfaber.com/wp-content/uploads/2016/05/SSRN-id962461.pdf): 200일/10개월 이동평균 추세 필터의 이론적 근거
- [SetupAlpha - 3x Leveraged ETF Strategy](https://medium.com/@setupalpha.capital/3x-leveraged-etf-strategy-2-600-return-with-38-drawdown-trading-strategy-rules-f4dad806bc25): 3x 레버리지 ETF에 트레일링 스탑 적용 → **CAGR 23.8%, MDD 38.7%** 달성 사례

**MAE 기반 손절 근거:**

- [AnalyzingAlpha - MAE](https://analyzingalpha.com/maximum-adverse-excursion): John Sweeney의 연구 — 승리 거래의 80% MAE 이내 손절선 설정 시 불필요한 손실 70~80% 차단 가능
- [QuantifiedStrategies - MAE/MFE](https://www.quantifiedstrategies.com/maximum-adverse-excursion-and-maximum-favorable-excursion/)

### 7.9 개선 방향 도출

#### 방향 1: ATR 트레일링 스탑 (최우선 권장)

**기존 청산 조건**: 하단 밴드 하향 돌파 시에만 다음 시가 청산
**추가 청산 조건**: 보유 중 고점 대비 `k × ATR` 하락 시 조기 청산

```
stop_price = highest_close_since_entry - (k × ATR(n))
→ 종가가 stop_price 아래로 내려가면 다음 시가에 청산
```

| 기대 효과    | 현재    | 개선 후 (추정) |
| ------------ | ------- | -------------- |
| MDD          | -85.68% | -40% 수준      |
| CAGR         | 20.26%  | 소폭 감소 가능 |
| Calmar Ratio | 0.237   | 상승 예상      |

**근거:** 16개 거래 중 10개가 청산일에 MDD 최저점 → 트레일링 스탑은 이 손실을 사전에 차단 가능

#### 방향 2: MAE 기반 하드 스탑 (제한적 효과)

현재 데이터에서 도출된 기준:

- 손실 거래 내부 MDD 범위: -26% ~ -43%
- 승리 거래 내부 MDD 범위: -30% ~ -74%

> **문제점**: 승리 거래도 -30% 이상 MDD를 감수해야 합니다.
> TQQQ 3배 레버리지 특성 때문에 너무 좁은 손절선은 오히려 승리 거래를 조기 청산해 역효과.
> 적절한 구간이 있다면 **-35% ~ -40%** 수준이지만, 검증 필요.

#### 방향 3: 변동성 기반 포지션 사이징

```
포지션 크기 = 목표위험액 / (ATR × 배율)
→ ATR이 클 때(고변동성) → 적게 투자
→ ATR이 작을 때(저변동성) → 많이 투자
```

**현재 맹점:** 100% 투자 또는 0% 현금의 이분법 → 고변동성 구간 진입 시 리스크 급증

### 7.10 개선 방향 우선순위

| 순위    | 방법                      | 예상 MDD 개선    | 예상 CAGR 영향          | 구현 난이도 |
| ------- | ------------------------- | ---------------- | ----------------------- | ----------- |
| **1위** | ATR 트레일링 스탑         | -85% → -40% 수준 | 소폭 감소 가능          | 중          |
| **2위** | 변동성 기반 포지션 사이징 | -85% → -55% 수준 | 감소 최소화             | 중          |
| **3위** | MAE 기반 하드 스탑        | 제한적           | TQQQ 특성상 역효과 위험 | 낮          |

> **초보자 요약**: 이 세션은 실제 거래 데이터를 해부한 결과입니다. 안전벨트 없이 레이싱카를 모는 상황과 같습니다 — 직선(상승장)에서는 빠르지만, 커브(하락장)에서는 무방비입니다.
> **MAE (Maximum Adverse Excursion)**: 거래 중 겪은 최악의 순간. "이 투자에서 가장 힘들었던 날의 손실률"입니다.
> **ATR (Average True Range)**: 최근 N일간의 평균 변동폭. 시장이 얼마나 출렁이는지를 숫자로 표현한 것입니다.
> **Calmar Ratio**: CAGR(연평균 수익률) / |MDD(최대 손실)|. "1원의 위험을 감수하고 얼마를 벌었는가?"를 나타내며, 높을수록 좋습니다.
> 핵심 발견: 16개 거래 중 10개(62.5%)에서 "가장 많이 떨어진 날 = 팔은 날"이었습니다. 즉, 전략이 바닥에서 팔고 있다는 뜻이며, ATR 트레일링 스탑("자동 브레이크")이 가장 시급한 개선입니다.

---

## 8. 현재까지 도출된 개선 방향 요약

> **이 섹션은 Session 1~3(§5~§7) 결과를 기반으로 작성된 초기 요약입니다.**
> 최신 현황은 문서 상단 **TL;DR** 및 최신 세션의 우선순위 테이블을 참조하세요.

**핵심 한 줄**: 전략이 돈은 잘 벌지만, 청산이 항상 너무 늦어 큰 손실을 겪는다 (단일 백테스트 MDD -85.68%).

**전략의 강점**: 닷컴버블·금융위기에서 현금 보유로 손실 회피 / 거래 횟수 최소화 / 장기 추세 포착 / QQQ 시그널 분리.

**개선 필요**: 청산 신호 지연 / 거래 내 MDD 평균 -39.7% / 100% 투자 or 현금의 이분법적 구조.

**당시 목표**: ATR 트레일링 스탑으로 MDD -85% → -50% 달성 (→ Session 16에서 구현 완료, -52.95% 달성).

---

## 9. 앞으로의 개선 계획

> **이 섹션은 Session 3(§7) 시점의 초기 목표 및 평가 기준입니다.**
> 최신 현황은 문서 상단 **TL;DR** 및 최신 세션의 우선순위 테이블을 참조하세요.

**초기 목표 기준값** (Session 3 당시): CAGR 18% 이상 유지 / MDD -50% 이하 / Calmar 0.35 이상 / 승률 70% 이상.

**당시 검토 예정 개선 사항**: ATR 트레일링 스탑 / 변동성 기반 포지션 사이징 / Calmar 목적함수 / 시장 레짐 필터.

**현재 진행 상태**: ATR 트레일링 스탑은 Session 16에서 구현 완료. 나머지 항목은 TL;DR의 다음 실험 참조.

---

## 10. Session 4 — AI 모델 간 토론 (외부 AI 분석 검토 및 반론)

**날짜**: 2026-02-21
**형식**: 외부 AI 모델이 이 문서를 분석한 결과를 검토하고, 코드 기반으로 팩트체크 후 동의/수정/반론을 정리

---

### 10.1 코드 기반 팩트체크 결과

#### ✅ (A) "TQQQ 합성 = QQQ × 3 단순 역산" — 과소설명 맞음, 수정 완료

`src/qbt/tqqq/simulation.py`의 `_calculate_daily_cost` 함수 확인:

```python
# simulation.py 실제 구현
annual_cost = leverage_cost + expense_ratio
leverage_cost = (FFR + softplus_spread(a, b, FFR)) × (leverage - 1)
daily_cost = annual_cost / 252
```

단순 3배 역산이 아닌, FFR + 동적 스프레드(softplus) + 운용보수를 모두 반영한 정밀 모델입니다.
4.1절에 이 강점을 명시하도록 수정 완료.

#### ✅ (B) "청산 신호 = 상단 밴드 이탈" 오기 — 수정 완료

코드 확인 결과 매수=상단 상향 돌파, 매도=하단 하향 돌파 (§2.1 참조). 7.5절 및 8.1절 표현 정정 완료. 분석 결론("청산이 늦다")은 동일하게 유효.

#### ✅ (C) "recent_buy_count → 진입 직후 자동 밴드 확장" — 지적이 정확, 추가 발견 있음

동적 조정 메커니즘(§2.6 참조)의 코드를 검증한 결과, 진입 직후 60일간 `recent_buy_count=1`이 유지되어 하단 밴드가 `MA × 0.95`까지 낮아지는 구조적 문제를 확인.

**추가 발견**: `recent_months=0`(비활성)은 MDD가 오히려 더 나쁨 (CAGR 20.01%, MDD -89.79% vs 현재 최적 CAGR 20.26%, MDD -85.68%).

**핵심 진단**:

- 동적 조정 **자체**가 나쁜 게 아니라, `adjusted_buffer_pct`가 **upper/lower 밴드를 동시에** 조정하는 설계가 문제
- 개선 방향: 매도 밴드에는 적용하지 않거나 반대 방향으로 적용 → **Session 5에서 구현 완료**

---

### 10.2 외부 AI와 견해가 다른 부분

#### 🔄 "sell 버퍼 분리가 구현 난이도 낮음" — 난이도 재평가 필요

현재 `_compute_bands`는 단일 `buffer_zone_pct`로 upper/lower를 동시에 결정하므로(§2.2 참조), 분리 시 TypedDict, 동적 조정, 그리드 서치 등 연쇄 변경 발생. 난이도는 "낮음"이 아닌 "중간". 방향성 자체는 동의 — **Session 5에서 구현 완료**.

#### 🔄 "ATR 스탑을 레버리지 축소(3x→1x)로 시작" — 현재 아키텍처와 불일치

현재 코드는 이분법적 포지션 모델입니다 (전량 매수 또는 전량 매도, 중간 없음):

```python
# run_buffer_strategy: position_shares는 전량 또는 0
position_shares = available_cash / buy_price  # 전량 매수
# or
position_shares = 0  # 전량 청산
```

TQQQ→QQQ 전환이나 포지션 비율 관리를 도입하면:

- `position_shares` 대신 포트폴리오 비율 관리 체계 필요
- equity 계산 방식 전면 개편
- 이는 현재 전략 철학(추세 확인 후 전량 진입/청산) 자체를 바꾸는 수준

**제안**: 전량 ATR 스탑을 먼저 구현하고 성과를 검증한 후, 레버리지 축소 방식 검토.

---

### 10.3 내가 추가하는 관점

#### 매도 신호의 hold_days 부재와 62.5% 패턴의 연결

코드 확인: 매도 신호에는 hold_days 검증이 없음 (매수만 hold_days 상태머신 적용, §2.1 참조). 그럼에도 16개 거래 중 10개(62.5%)에서 청산일 당일/전날에 내부 MDD 최저점 발생.

**진단**: 매도가 "느린 것"이 아니라, **하단 밴드 자체의 위치가 너무 낮습니다** (MA × 0.95). 레버리지 3배 상품에서 QQQ가 5% 하락하면 TQQQ는 이미 상당한 손실이 확정된 상태. 문제의 핵심은 "청산 집행이 느리다"가 아니라 **"청산 트리거 조건 자체가 너무 관대하다"**입니다.

#### 워크포워드 인프라 이식 가능성

16회 거래 데이터로 grid_best를 확정하는 것은 통계적으로 불안정합니다.
단, 이 프로젝트는 `scripts/tqqq/spread_lab/validate_walkforward.py` 형태로
워크포워드 인프라가 이미 다른 도메인(`tqqq/`)에 구현되어 있습니다.
`src/qbt/tqqq/walkforward.py`의 구조를 참고해 백테스트 도메인으로 이식하는 것이 현실적입니다.

---

### 10.4 외부 AI 제안 수용 및 개선 우선순위 최종 조정

외부 AI 분석과 코드 검토를 통합한 우선순위:

| 순위  | 방법                                             | 근거                                                                    | 예상 난이도 | 상태      |
| ----- | ------------------------------------------------ | ----------------------------------------------------------------------- | ----------- | --------- |
| **1** | **recent_months 실험** (=0 vs =2 grid 비교)      | ~~코드 변경 없이 즉시 검증~~ → **검증 완료** (10.5(3) 참조)             | 낮음        | ✅ 완료   |
| **2** | **sell/buy 버퍼 분리 + recent_sell_count 도입**  | 진행 확정 (사용자 결정). 청산 밴드 타이트 + 재진입 억제 메커니즘 재설계 | 중간        | 진행 예정 |
| **3** | **ATR 트레일링 스탑** (전량 청산형, 이분법 유지) | 청산 트리거 조건 개선, 기존 아키텍처와 일관성                           | 중간        | 대기      |
| **4** | **그리드 서치 목적함수 → Calmar**                | CAGR 단독 최적화로는 MDD 개선 불가                                      | 중간        | 대기      |
| **5** | **워크포워드 검증**                              | tqqq 도메인 인프라 재활용, 과최적화 논쟁 해소                           | 중간        | 대기      |

**§7.10 대비 변경점**: ATR 트레일링 스탑이 3순위로 하락, sell/buy 버퍼 분리(2순위)와 Calmar 목적함수(4순위), 워크포워드(5순위) 신규 추가. 변동성 기반 포지션 사이징은 후순위로 이동.

---

### 10.5 사용자 추가 의견 및 즉시 검증

#### (1) sell 버퍼 분리 — 진행 확정

> **사용자 결정**: sell 버퍼 분리(buy_buffer ≠ sell_buffer)는 진행한다.

외부 AI가 "구현 난이도 낮음"으로 평가했고, 본 문서(10.2절)에서 "중간"으로 재평가했으나,
방향성에는 양측이 동의합니다. 청산 밴드를 더 타이트하게 하는 것이 MDD 문제를 직접 겨냥합니다.
개선 우선순위 4순위에서 진행 확정으로 격상합니다.

---

#### (2) recent_buy_count 타이밍 설계 오류 — 사용자 지적

> **사용자 지적**: 진입 직후 밴드가 확장되어 보유 중 lower_band가 낮아지는 것이 문제.
> 매도 후에 밴드를 확장하여 재진입을 억제하는 것이 올바른 방향.

**핵심 설계 철학 차이:**

- 기존: "진입 직후 더 오래 버텨라" → lower_band 낮아져 MDD 악화 부작용
- 변경: "방금 팔았으면 바로 사지 마라" → 보유 중 밴드 변화 없음, 재진입 판단에만 보수성 추가

**구현 완료** (Session 5, §11에 기록)

---

#### (3) recent_months 즉시 검증 — grid_results.csv 분석 결과

> **코드 변경 없이 기존 grid_results.csv 데이터로 검증 완료.**

동일 파라미터(ma=150, buffer=0.04, hold=3)에서 recent_months만 변경한 결과:

| recent_months | CAGR       | MDD         | 거래수 | 승률       | 비고                 |
| ------------- | ---------- | ----------- | ------ | ---------- | -------------------- |
| 0             | 17.01%     | -88.46%     | **19** | 57.89%     | 동적 조정 없음, 최악 |
| **2**         | **20.26%** | **-85.68%** | **16** | **68.75%** | **현재 최적**        |
| 4             | 19.88%     | -85.81%     | 16     | 68.75%     | 4/6/8 동일 결과      |
| 6             | 19.88%     | -85.81%     | 16     | 68.75%     |                      |
| 8             | 19.88%     | -85.81%     | 16     | 68.75%     |                      |
| 10            | 19.26%     | -86.99%     | 16     | 68.75%     |                      |
| 12            | 19.16%     | -87.29%     | 16     | 68.75%     |                      |

**검증 결과 해석:**

1. **recent_months=0 (비활성)**: 거래수 19회 (vs 다른 경우 16회) → 동적 조정이 없으면 3회 추가 휩소 진입 발생
2. **CAGR 격차**: 17.01% vs 20.26%, 무려 3.25%p 차이 → 휩소 방지 효과가 CAGR에 크게 기여
3. **MDD 격차**: -88.46% vs -85.68%, 2.78%p 차이 → MDD 개선 효과도 있음
4. **4/6/8개월 동일**: 거래 패턴이 동일하다는 의미 → 해당 구간에서는 recent_months가 실제 결정에 영향을 주지 않음
5. **12개월 이상에서 악화**: 과거 진입 이력이 너무 오래 기억되어 정상 신호도 억제

**결론**: 현재 recent_months=2 설정이 이 파라미터 조합에서 최적입니다.
단, 위(2)에서 지적한 대로 **기준 날짜를 진입일 → 청산일로 변경**하면 같은 2개월 설정이더라도 전혀 다른 결과를 낼 수 있습니다.
sell/buy 버퍼 분리 구현과 함께 이 변경을 적용한 후 재검증이 필요합니다.

---

### 10.6 DCA 결론 프레이밍 수정 (외부 AI 제안 수용)

외부 AI 제안: "DCA가 틀렸다"보다 "이 전략의 목표함수(CAGR/Calmar)를 높이려면 DCA는 도구가 아니다"가 더 정확.

**기존 6.5절 결론은 유지하되, 아래 보완 추가**:

> DCA가 유의미한 유일한 맥락은 **심리적 안정(후회 최소화, regret minimization)** 목적입니다.
> 수익 극대화 또는 위험조정수익(Calmar) 개선이 목표라면 DCA는 도구가 되지 않습니다.
> 버퍼존 TQQQ의 개선 목표가 "Calmar Ratio 향상"이므로, DCA는 검토 대상에서 제외합니다.

> **초보자 요약**: 이 세션은 논문 심사(peer review)와 같습니다. 외부 AI가 이 문서를 읽고 지적한 내용을 코드로 직접 확인하면서 동의/반론을 정리했습니다. 이 과정에서 "매수 버퍼와 매도 버퍼를 분리하자"는 아이디어가 구체화되었고, 이것이 다음 Session 5의 구현으로 이어집니다.

---

## 11. Session 5 — 매수/매도 버퍼 분리 구현 완료

**날짜**: 2026-02-21
**상태**: 구현 완료 (코드레벨 검증 통과)

### 11.1 구현 배경

10.5절에서 도출된 두 가지 설계 이슈를 해결하기 위해 구현을 진행했습니다:

1. **매수/매도 버퍼가 단일 값으로 공유되는 문제**: `buffer_zone_pct` 하나로 upper_band(매수)와 lower_band(매도)를 동시에 결정하여, 동적 조정 시 lower_band도 같이 변해 MDD를 악화시킴
2. **동적 조정 타이밍 오류**: `entry_dates`(매수일) 기반으로 계산하여, 진입 직후부터 밴드가 확장되는 구조적 문제

### 11.2 핵심 변경 사항

#### (1) 매수/매도 버퍼 분리

- `buffer_zone_pct` 단일값 → `buy_buffer_zone_pct` + `sell_buffer_zone_pct` 분리
- `upper_band = MA × (1 + buy_buffer_zone_pct)` (동적 확장 가능)
- `lower_band = MA × (1 - sell_buffer_zone_pct)` (항상 고정 — 보유 중 불필요한 하단 밴드 하락 제거)

#### (2) 동적 조정 기준 변경 (entry → exit)

- `_calculate_recent_buy_count`(진입일 기반) → `_calculate_recent_sell_count`(청산일 기반) 변경
- 효과: "진입 직후 밴드 확장(보유 중 MDD 악화)" → "청산 후 upper_band만 확장(재진입 억제)"

#### (3) 전체 rename + 그리드 서치 확장

- 프로젝트 전체에서 `buffer_zone_pct` → `buy_buffer_zone_pct` rename (상수, TypedDict, 함수, CSV 스키마 등 11개 파일)
- 그리드 서치 탐색 공간: 840 → 4,200 조합 (`sell_buffer_zone_pct` 축 추가)

### 11.3 검증 결과

코드레벨 검증 84항목 전체 통과. 기존 이름(`buffer_zone_pct`, `recent_buy_count` 등) 완전 제거 확인.

### 11.5 다음 단계

이 구현은 10.4절 우선순위 2번(sell/buy 버퍼 분리)에 해당합니다.
그리드 서치 재실행 후 새로운 최적 파라미터로 성과를 비교해야 합니다:

- 기존: `buffer_zone_pct=0.04` (매수/매도 동일)
- 신규: `buy_buffer_zone_pct=?`, `sell_buffer_zone_pct=?` (독립 탐색)

재실행 후 다음 항목을 확인해야 합니다:

1. 새 최적 파라미터에서의 CAGR/MDD/Calmar Ratio 변화
2. `sell_buffer_zone_pct`가 `buy_buffer_zone_pct`보다 작은 값(타이트한 매도)이 최적으로 선택되는지
3. `recent_sell_count` 기반 동적 조정이 기존 대비 어떤 차이를 만드는지

이후 우선순위:

- 3순위: ATR 트레일링 스탑 (전량 청산형, 이분법 유지)
- 4순위: 그리드 서치 목적함수 변경 (CAGR → Calmar)
- 5순위: 워크포워드 검증 (tqqq 도메인 인프라 재활용)

> **초보자 요약**: 기존에는 매수/매도에 같은 "문 크기"(buffer_zone_pct)를 썼는데, 이제는 "들어오는 문(buy_buffer)"과 "나가는 문(sell_buffer)"을 따로 설정할 수 있게 바꿨습니다. 또한 동적 조정 기준을 "매수일"에서 "청산일"로 바꿔서, 진입 직후 불필요하게 밴드가 변하는 문제를 해결했습니다.

---

### 12. Session 6 [Claude Opus 4.6] — 2026-02-22 12:00 (KST)

주제: 매수/매도 버퍼 분리 구현 후 성과 비교 분석 + 과최적화 리스크 경고

#### 1. 구현 완료 사항

PLAN_sell_buffer_separation.md 계획서가 실행되어, `run_grid_search.py`와 `run_single_backtest.py`가 재실행되었습니다.
핵심 변경: `buffer_zone_pct` 단일값 → `buy_buffer_zone_pct` + `sell_buffer_zone_pct` 분리, 동적 조정 기준을 `entry_dates` → `exit_dates` 기반으로 변경.

#### 2. 성과 비교: 기존 vs 변경

##### 버퍼존 TQQQ

| 지표              | 기존 (단일 버퍼)              | 변경 (분리 버퍼)                      | 변화                          |
| ----------------- | ----------------------------- | ------------------------------------- | ----------------------------- |
| **최적 파라미터** | buffer=0.04, hold=3, recent=2 | buy=0.01, sell=0.05, hold=5, recent=2 | 진입 4x 타이트, 청산 25% 관대 |
| **CAGR**          | 20.26%                        | **23.40%**                            | **+3.14%p**                   |
| **MDD**           | -85.68%                       | -87.97%                               | -2.29%p (악화)                |
| **Calmar Ratio**  | 0.237                         | **0.266**                             | **+12.2% 개선**               |
| **총 거래수**     | 16회                          | 16회                                  | 동일                          |
| **승률**          | 68.75%                        | 62.50%                                | -6.25%p (하락)                |
| **최종 자본**     | 14.4억원                      | **28.9억원**                          | **+100.1%**                   |
| **진입일 (최초)** | 1999-04-08                    | 1999-04-05                            | 3일 빠름                      |

##### 버퍼존 QQQ

| 지표              | 기존 (단일 버퍼)              | 변경 (분리 버퍼)                      | 변화                      |
| ----------------- | ----------------------------- | ------------------------------------- | ------------------------- |
| **최적 파라미터** | buffer=0.05, hold=2, recent=8 | buy=0.01, sell=0.05, hold=5, recent=2 | 진입 5x 타이트, 청산 동일 |
| **CAGR**          | 10.81%                        | **11.92%**                            | **+1.11%p**               |
| **MDD**           | -42.83%                       | -45.34%                               | -2.51%p (악화)            |
| **Calmar Ratio**  | 0.252                         | **0.263**                             | **+4.4% 개선**            |
| **총 거래수**     | 14회                          | 16회                                  | +2회                      |
| **승률**          | 78.57%                        | 68.75%                                | -9.82%p (하락)            |
| **최종 자본**     | 1.59억원                      | **2.08억원**                          | **+30.6%**                |

#### 3. 거래 내역 변화 분석 (TQQQ)

기존과 변경의 trades.csv를 비교한 결과, 핵심 차이는 다음과 같습니다:

**(1) 새로 발생한 휩소 거래**

변경된 전략에서 **거래 #3** (2002-11-29 ~ 2002-12-16, 17일, -30.32%)이 새로 발생했습니다.
기존에는 없던 짧은 손실 거래로, `buy_buffer=0.01`의 매우 타이트한 진입 조건이 노이즈 신호를 포착한 결과입니다.

**(2) 초기 진입이 빨라짐**

- 첫 거래: 1999-04-08 → 1999-04-05 (3일 빠름)
- 2019년 거래: 2019-03-18 → 2019-02-21 (25일 빠름)

`buy_buffer=0.01`은 MA 위 1%만 돌파해도 매수 신호가 발생하므로, 추세 초기를 더 빨리 포착합니다.

**(3) 장기 추세 포착 극대화**

변경된 거래 #11 (2011-10-18 ~ 2015-08-25, **1,407일**, +371.23%)은 기존 #11+#10 합산(894+372=1,266일)보다 더 긴 단일 추세를 포착했습니다.
매도 버퍼 0.05의 관대한 청산 조건이 중간 조정을 버티고 장기 추세를 한 번에 잡았습니다.

**(4) 후반부 복리 효과 극대화**

기존 거래 #15의 shares: 16,804,696 → 변경 거래 #15: 35,024,698 (약 2.1배)
거래 #16의 pnl: 기존 6.27억 → 변경 12.03억 (약 1.9배)

초기 추세를 빠르게 잡고 장기 보유하면서 복리 효과가 누적되어, 후반부 거래에서 투입 가능한 자본이 크게 증가했습니다.

#### 4. 핵심 발견: "Tight Entry, Wide Exit" 패턴

두 전략(TQQQ, QQQ) 모두 최적 파라미터가 **동일**하게 수렴했습니다:

```
buy_buffer_zone_pct = 0.01  (1%, 매우 타이트한 진입)
sell_buffer_zone_pct = 0.05  (5%, 관대한 청산)
hold_days = 5
recent_months = 2
```

이는 학술 문헌에서 **Hysteresis Band** (이력 현상 밴드)로 잘 알려진 패턴입니다:

- CSEF Working Paper No. 287: 포트폴리오 리밸런싱에서 매수/매도 트리거 사이의 비대칭 갭(이력 밴드)이 거래 비용보다 **훨씬 큰 수준**에서 최적이며, 거래 비용이 0에 수렴해도 이력 밴드는 더 느리게 수렴한다.
- Leland의 최적 리밸런싱 연구: 최적 정책은 목표 비율 주변에 **no-trade region**을 설정하고, 비율이 이 구간을 벗어날 때만 경계로 되돌리는 것이 정기적 리밸런싱 대비 거래 빈도를 50% 감소시킨다.

버퍼존 전략 맥락에서 해석:

- **buy_buffer 0.01**: MA 위 1% 돌파 = "추세 시작 직후 즉시 진입" → 복리 효과 극대화
- **sell_buffer 0.05**: MA 아래 5% 이탈 = "중간 조정은 버티고 확실한 추세 전환에서만 청산" → 장기 추세 포착
- **hold_days 5**: 기존 3일에서 5일로 증가 → 진입은 빠르되 확인 기간은 더 길게

#### 5. 과최적화 리스크 경고 (Critical)

> **이 결과를 액면 그대로 신뢰해서는 안 됩니다.**

##### (1) 탐색 공간 5배 확장 문제

Bailey & Lopez de Prado의 **Deflated Sharpe Ratio** 프레임워크에 따르면:

```
기존: 840 조합 → Expected Max SR under null ≈ sqrt(2 × ln(840)) ≈ 3.67
변경: 4,200 조합 → Expected Max SR under null ≈ sqrt(2 × ln(4200)) ≈ 4.09
```

**순수 노이즈에서도 기대 최대 Sharpe Ratio가 ~11% 상승**합니다.
CAGR 3.14%p 개선이 진정한 구조적 개선인지, 탐색 공간 확장에 의한 통계적 인공물(artifact)인지 구분할 수 없습니다.

참고: Bailey, Borwein, Lopez de Prado, Zhu (2014). "Pseudo-Mathematics and Financial Charlatanism: The Effects of Backtest Overfitting on Out-of-Sample Performance."
https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2326253

##### (2) Probability of Backtest Overfitting (PBO) 미검증

현재 그리드 서치는 전체 기간(1999~2026)에 대해 CAGR을 최적화하고 있으며, out-of-sample 검증이 없습니다.
4,200개 조합에서 최적을 선택하면, **backtest overfitting 확률(PBO)이 비선형적으로 증가**합니다.

PBO를 계산하려면 Combinatorially Symmetric Cross-Validation (CSCV)을 적용해야 합니다:

- R 패키지: `pbo` (CRAN)
- Python 패키지: `pypbo` (GitHub: esvhd/pypbo)

##### (3) 두 전략의 최적 파라미터 완전 일치 — 우연인가 과적합인가

TQQQ와 QQQ가 **동일한 최적 파라미터**(buy=0.01, sell=0.05, hold=5, recent=2)로 수렴한 것은 두 가지로 해석 가능합니다:

- **긍정적 해석**: QQQ 시그널 소스가 동일하므로, 최적 시그널 파라미터가 일치하는 것은 자연스러움
- **부정적 해석**: 과적합된 파라미터가 두 전략 모두에서 "우연히 가장 좋은 백테스트 성과"를 보이는 것

특히 `buy_buffer=0.01`은 탐색 범위의 **최솟값**입니다. 최적값이 탐색 범위의 경계에 위치한다는 것은:

- 탐색 범위가 충분히 넓지 않거나 (0.005까지 탐색하면 더 좋은 값이 있을 수 있음)
- 또는 "진입을 최대한 빠르게"가 과최적화의 결과일 수 있음

##### (4) 승률 하락의 의미

TQQQ 승률 68.75% → 62.50%, QQQ 승률 78.57% → 68.75%.

타이트한 진입이 휩소 거래를 증가시키는 것은 명확합니다.
변경된 TQQQ에서 새로 발생한 17일짜리 -30.32% 손실 거래(#3)가 이를 증명합니다.
현재는 다른 승리 거래의 수익이 이 추가 손실을 상쇄하지만, **미래에도 동일한 패턴이 유지될 보장이 없습니다.**

#### 6. MDD 목표 대비 평가

9.2절에서 설정한 평가 지표 대비 현재 상태:

| 지표         | 목표          | 기존    | 변경    | 달성 여부         |
| ------------ | ------------- | ------- | ------- | ----------------- |
| CAGR         | 18% 이상 유지 | 20.26%  | 23.40%  | **달성**          |
| MDD          | -50% 이하     | -85.68% | -87.97% | **미달성 (악화)** |
| Calmar Ratio | 0.35 이상     | 0.237   | 0.266   | **미달성**        |
| 승률         | 70% 이상      | 68.75%  | 62.50%  | **미달성 (악화)** |

**MDD는 오히려 악화**되었습니다. 매수/매도 버퍼 분리는 CAGR 개선에는 효과적이었으나, MDD 감소라는 핵심 목표에는 기여하지 못했습니다.
이는 7.5절에서 진단한 "청산 트리거 조건 자체가 너무 관대하다"는 구조적 문제가 여전히 해결되지 않았음을 의미합니다.

#### 7. 제안: 다음 단계

##### (1) 워크포워드 검증 — 최우선 격상 필요

현재 결과는 in-sample 최적화만 수행된 상태입니다.
4,200개 조합의 탐색 공간에서 나온 결과를 신뢰하려면, **워크포워드 검증이 반드시 선행**되어야 합니다.

구체적 방법:

- 기존 `src/qbt/tqqq/walkforward.py` 인프라를 백테스트 도메인으로 이식
- 5~7년 단위 expanding window로 in-sample 최적화 → 후속 1~2년 out-of-sample 테스트
- 워크포워드 효율(Walk-Forward Efficiency)이 0.5 이상이면 과최적화 리스크 낮음

##### (2) PBO 분석 도입

grid_results.csv의 4,200개 결과를 CSCV 방법으로 분석하여, 현재 최적 파라미터의 PBO를 정량화해야 합니다.
PBO > 0.5이면 "해당 최적 파라미터가 out-of-sample에서 중앙값 이하 성과를 낼 확률이 50% 이상"을 의미합니다.

##### (3) ATR 트레일링 스탑 — MDD 해결의 핵심

매수/매도 버퍼 분리로는 MDD를 줄일 수 없음이 실증적으로 확인되었습니다.
MDD -50% 이하 목표를 달성하려면, **보유 중 조기 청산 메커니즘**(ATR 트레일링 스탑)이 불가피합니다.

##### (4) 그리드 서치 목적함수 변경

현재 CAGR 단독 최적화는 MDD를 무시합니다.
Calmar Ratio (CAGR / |MDD|) 또는 MDD 패널티 항을 추가하면, MDD를 개선하는 파라미터 조합이 상위에 올라올 수 있습니다.

#### 8. 우선순위 최종 재조정

**§10.4 대비 변경점**: 워크포워드 검증이 1순위로 최우선 격상 (과최적화 리스크 해소 필수). sell/buy 분리는 완료. ATR(2순위), Calmar 목적함수(3순위), PBO(4순위) 순.

참고 자료:

- Bailey & Lopez de Prado (2014). "Pseudo-Mathematics and Financial Charlatanism." https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2326253
- CSEF Working Paper No. 287 — Hysteresis Bands. https://www.csef.it/WP/wp287.pdf
- Newfound Research — Leverage and Trend Following. https://blog.thinknewfound.com/2018/05/leverage-and-trend-following/
- arXiv (2025) — Compounding Effects in Leveraged ETFs. https://arxiv.org/html/2504.20116v1
- Sukhani — Whipsaws in Trend Following. https://s2analytics.com/blog/whipsaws-in-trend-following-systems/
- QuantConnect — Leveraged ETFs with Systematic Risk Management. https://www.quantconnect.com/research/15351/leveraged-etfs-with-systematic-risk-management/
- Deflated Sharpe Ratio. https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2460551

다음 모델에게: 워크포워드 검증 구현을 설계할 때, 기존 `src/qbt/tqqq/walkforward.py`의 expanding window 방식을 백테스트 도메인에 어떻게 이식할 것인지 구체적인 아키텍처를 제안해 주세요. 특히 4,200개 파라미터 조합의 워크포워드는 계산 비용이 매우 높으므로, 탐색 공간을 사전에 줄이는 방법(예: buy_buffer 범위 제한, 상관관계 높은 파라미터 그룹핑)도 함께 고려해 주세요.

> **초보자 요약**: 이 세션의 핵심 메시지는 "시험 답안지를 보고 공부한 학생의 만점은 신뢰할 수 없다"입니다.
> **IS (In-Sample)**: 파라미터를 훈련시키는 과거 데이터. "교과서로 공부하는 기간"입니다.
> **OOS (Out-of-Sample)**: 훈련에 쓰지 않은 미래 데이터. "실전 시험"입니다.
> **과최적화 (Overfitting)**: 과거에만 잘 맞고 미래에는 안 맞는 파라미터를 고르는 것. 교과서를 외웠지만 응용문제를 못 푸는 것과 같습니다.
> **다중검정 (Multiple Testing)**: 4,200개 조합을 시도하면, 순전히 운으로도 좋은 결과가 나올 확률이 높아집니다. 복권을 4,200장 사면 당첨 확률이 올라가는 것과 같은 통계적 함정입니다.
> **DSR (Deflated Sharpe Ratio)**: 이런 "운빨 당첨"을 걸러내는 통계 도구입니다.
> **Tight Entry, Wide Exit**: buy=0.01(빠른 진입), sell=0.05(느린 청산) 패턴. "문은 좁게 들어가고 넓게 나간다"는 뜻으로, 추세 초기를 빨리 잡고 중간 조정은 버티는 전략입니다.
> 이 결과가 진짜인지 확인하려면 WFO(워크포워드 검증)가 필요하다는 것이 최종 결론입니다.

---

### 13. Session 7 [GPT-5.2 Thinking] — 2026-02-22 15:10 (KST)

주제: 백테스트 도메인 워크포워드 검증(WFO) 아키텍처 제안 + 과최적화(PBO/DSR) 방지 프레임 + 계산비용 절감 아이디어

공유 문서의 최신 결론(매수/매도 버퍼 분리 후 CAGR↑, 그러나 MDD 목표 미달 + 탐색공간 확대에 따른 과최적화 리스크 경고)을 전제로, **"결과를 신뢰할 수 있게 만드는 검증 파이프라인"**을 먼저 세우는 쪽으로 제안을 정리합니다.

#### 1) 왜 지금 WFO가 1순위인가: "탐색공간 확장 + 단일 전체기간 최적화"의 구조적 취약점

- 파라미터 조합이 늘어날수록 **선택편향/다중검정** 리스크 증가 (DSR/PBO 프레임워크에 대해서는 Session 6 §5 참조)
  → 결론: "다음 기능(ATR 스탑 등)"을 붙이기 전에, **WFO로 파라미터가 OOS에서 유지되는지**부터 확인하는 게 순서상 안전합니다.

#### 2) 백테스트 도메인에 WFO를 이식하는 권장 아키텍처 (tqqq/walkforward.py 패턴 재사용)

tqqq 도메인은 이미 "Train/Test 윈도우 반복 + stitched 결과 + 요약" 패턴이 확립돼 있습니다(특히 stitched RMSE 계산). 이 패턴을 backtest에도 그대로 옮기되, **핵심은 '상태 연속성'**입니다.

**A. 권장 설계: "파라미터만 롤링 업데이트"하는 단일 연속 시뮬레이션(= stitched equity)**

- WFO 루프는 "각 리밸런스(재최적화) 시점 t에서, t 이전 데이터만으로 최적 파라미터를 고르고 → (t, t+Δ] 구간은 그 파라미터로 실제 거래를 진행"을 반복합니다.
- 이 방식은 매 구간을 독립 백테스트로 리셋하지 않으므로,
  - **포지션/현금/미체결(pending)/hold_state**가 자연스럽게 이어지고
  - **recent_sell_count(청산 기반 동적조정)**도 실제처럼 누적됩니다.

- 구현적으로는 `run_buffer_strategy()`를 그대로 "구간별 호출"하면 상태가 끊기므로, 아래 중 하나가 필요합니다.
  1. **Engine 객체화**: `BufferStrategyEngine.step()`로 일 단위 진행, `update_params()`로 구간 경계에서 파라미터만 교체
  2. **resume 가능한 run 함수**: `run_buffer_strategy_segment(..., initial_state) -> (segment_dfs, final_state)` 형태 추가

- tqqq의 `_simulate_stitched_periods` 아이디어를 backtest로 이식하는 느낌이 가장 자연스럽습니다("구간별 결과를 잇는다"는 점에서). ([TradingBrokers.com][3])

**B. 최소 구현(차선): 구간 독립 리셋형 WFO**

- 빠르게 "과최적화 경향"만 보고 싶다면, 테스트 구간 시작 시 포지션을 0으로 두고 매번 리셋하는 WFO도 가능합니다.
- 단점: 실전에서 흔한 "훈련 마지막에 잡은 포지션이 OOS로 넘어가는 상황"을 반영 못 해, 결과가 보수적/왜곡될 수 있습니다.
  → 가능하면 A(상태 연속) 권장.

**C. 파일/결과물 제안(프로젝트 규칙 준수 관점)**

- 비즈니스 로직: `src/qbt/backtest/walkforward.py` (신규)
- CLI: `scripts/backtest/run_walkforward.py` (신규) — 스크립트 계층은 "옵션 최소화" 원칙 유지 ([Flirting with Models][4]) (원칙 근거는 코드가 아니라 가이드지만, 운영상 최소 옵션이 맞음)
- 저장: `storage/results/backtest/walkforward_{strategy}/` 아래
  - `walkforward_windows.csv` (각 구간: train_start/end, test_start/end, best params, IS/OOS metric)
  - `equity_stitched.csv` (Date, equity, dd, active_params_id 등)
  - `summary.json` (CAGR/MDD/Calmar + WFE 등)

- 코드 변경은 plan 선행(루트/ docs 규칙) 필요하니, 실제 구현 단계에서는 `docs/plans/PLAN_backtest_walkforward.md`부터 시작하면 프로젝트 운영 규칙에 정합적입니다.

#### 3) WFO의 목적함수(= 파라미터 선택 기준) 추천

현재 grid는 CAGR 단독 최적화였고, MDD 목표(-50%)와 충돌했습니다. 다음 중 하나로 "선택 기준"을 바꾸는 걸 권장합니다.

- **(1) Calmar 기반**: `Calmar = CAGR / |MDD|`
  - 목적이 "MDD를 줄이면서 CAGR 유지"일 때 직관적.

- **(2) DSR 기반(권장)**: 선택편향/비정규성을 교정해 "통계적으로 의미 있는 성과인지"를 보려면 DSR이 맞습니다. ([David H Bailey][1])
  - 현실적으로는 "Calmar로 랭킹 → 상위 K개에 대해 DSR로 재검정" 같은 2단계도 가능.

추가로, 시계열 데이터에서 일반 k-fold는 정보누수 위험이 있어, purging/embargo 개념이 널리 쓰입니다. ([위키백과][5])
(다만 여기서는 ML 라벨링이 아니라 룰 기반 트레이딩이라, WFO 자체가 누수 방지에 1차적으로 충분하고, purged CV는 "추가 안전장치/연구 확장" 정도로 두면 됩니다.)

#### 4) 계산비용(4,200 조합 × 다수 구간) 줄이는 현실적 방법

상태 연속 WFO를 제대로 하면, "각 구간에서 파라미터 탐색"이 병목이 됩니다. 다음을 조합하는 게 실용적입니다.

1. **후보 풀(candidate pool) 전략**
   - 전체기간(혹은 긴 초기기간)에서 Calmar 상위 N(예: 50~200)만 뽑고, WFO 각 구간은 이 후보 풀만 재평가
   - 장점: 구현 단순, 병렬 그대로 활용 가능

2. **Random Search로 그리드 일부만 샘플링**
   - 그리드 전수보다 랜덤 시도가 더 효율적일 수 있다는 고전 결과가 있습니다. ([Machine Learning Research][6])
   - 특히 지금처럼 "최적이 경계값(예: buy=0.01)"에 붙는 상황은, 전수탐색보다 "범위 재정의 + 랜덤 탐색"이 더 빨리 답을 줄 수 있습니다.

3. **Successive Halving/Hyperband류의 '예산 기반 조기 탈락'**
   - 예: train 구간을 전부 쓰기 전에, 최근 1~2년 성과로 1차 컷 → 살아남은 소수만 전체 train으로 재평가
   - Hyperband가 이런 프레임을 정리한 대표 논문입니다. ([Machine Learning Research][7])
   - 금융은 레짐 변화가 커서 "짧은 예산 평가"가 편향될 수 있으니, 컷 기준은 Calmar 같은 리스크 반영 지표가 더 안전합니다.

#### 5) (참고) 왜 "레버리지+추세추종/리스크관리" 조합이 합리적인가

- 레버리지 ETF의 장기 성과는 단순히 "변동성 드래그"만이 아니라 **수익률 자기상관(추세 vs 평균회귀)**에 크게 좌우된다는 최근 연구가 있습니다. ([arXiv][8])
- 따라서 "추세 구간에서 레버리지로 수익을 키우고, 비추세/급락 구간의 손상(permanent impairment)을 관리한다"는 논리는 Newfound의 레버리지+추세추종 관점과도 결이 같습니다. ([Flirting with Models][4])
- ATR 기반 트레일링 스탑은 변동성 적응형 청산 규칙의 대표적 구현체입니다. ([chartschool.stockcharts.com][9])
  → 다만, ATR 스탑을 붙이기 전/후 모두 **WFO로 OOS에서 일관되게 MDD가 줄어드는지**를 검증해야 "진짜 개선"이라고 말할 수 있습니다.

참고 자료:

```text
https://www.davidhbailey.com/dhbpapers/backtest-prob.pdf
https://www.davidhbailey.com/dhbpapers/deflated-sharpe.pdf
https://blog.thinknewfound.com/2018/05/leverage-and-trend-following/
https://blog.thinknewfound.com/2018/01/levered-etfs-long-run/
https://arxiv.org/abs/2504.20116
https://jmlr.org/papers/volume13/bergstra12a/bergstra12a.pdf
https://jmlr.org/papers/volume18/16-558/16-558.pdf
https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-indicators/atr-trailing-stops
https://www.quantifiedstrategies.com/atr-trailing-stop/
https://escholarship.org/uc/item/4w1110bb
https://skfolio.org/generated/skfolio.model_selection.CombinatorialPurgedCV.html
```

다음 모델에게:

1. WFO를 "구간 리셋형(단순)" vs "상태 연속 stitched형(권장)" 중 어떤 방식으로 1차 구현할지, **프로젝트의 목표(신뢰성 vs 구현속도)** 관점에서 우선순위를 정해 주세요.
2. stitched형으로 간다면, `run_buffer_strategy()`를 **Engine 객체화**할지, 아니면 **resume 가능한 segment-run 함수**를 추가할지(침투 범위/테스트 난이도 포함) 아키텍처 결정을 제안해 주세요.
3. WFO 목적함수는 1차로 **Calmar**로 갈지, 아니면 곧바로 **DSR/PBO**까지 포함한 "검정 기반 선택"으로 갈지, 운영 복잡도 대비 효용을 어떻게 보시는지도 의견 부탁합니다.

[1]: https://www.davidhbailey.com/dhbpapers/deflated-sharpe.pdf "THE DEFLATED SHARPE RATIO: CORRECTING FOR SELECTION BIAS, BACKTEST ... - David H. Bailey"
[2]: https://www.davidhbailey.com/dhbpapers/backtest-prob.pdf "THE PROBABILITY OF BACKTEST OVERFITTING - David H. Bailey"
[3]: https://tradingbrokers.com/walk-forward-analysis/ "Walk Forward Optimization - TradingBrokers.com"
[4]: https://blog.thinknewfound.com/2018/05/leverage-and-trend-following/ "Leverage and Trend Following - Flirting with Models"
[5]: https://en.wikipedia.org/wiki/Purged_cross-validation "Purged cross-validation"
[6]: https://jmlr.org/papers/volume13/bergstra12a/bergstra12a.pdf "Random Search for Hyper-Parameter Optimization"
[7]: https://jmlr.org/papers/volume18/16-558/16-558.pdf "Hyperband: A Novel Bandit-Based Approach to Hyperparameter Optimization"
[8]: https://arxiv.org/abs/2504.20116 "Compounding Effects in Leveraged ETFs: Beyond the Volatility Drag Paradigm"
[9]: https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-indicators/atr-trailing-stops "ATR Trailing Stops | ChartSchool | StockCharts.com"

> **초보자 요약**: 이 세션에서 **WFO(Walk-Forward Optimization)**가 본격적으로 등장합니다. "공부 → 시험 → 더 공부 → 다시 시험"을 반복하는 학습법입니다.
> **Expanding Anchored Window**: 시작점(1999년)을 고정하고 공부 범위만 점점 넓히는 방식. 2000~2005년으로 공부 → 2006~2007년 시험, 2000~2007년으로 공부 → 2008~2009년 시험 ... 이렇게 반복합니다.
> **Stitched Equity**: 각 "시험 기간"의 성적표를 시간순으로 이어 붙인 것. "만약 WFO를 실전에 적용했다면 내 돈이 어떻게 됐을까?"를 보여주는 가상 라이브 트레이딩 곡선입니다.
> **params_schedule**: 각 시험 구간에서 어떤 파라미터를 쓸지 미리 정해둔 시간표.
> **PBO (Probability of Backtest Overfitting)**: 백테스트 결과가 "운빨"일 확률. 낮을수록 신뢰할 수 있습니다.
> **목적함수**: "어떤 기준으로 최적 파라미터를 고를 것인가?" 기존에는 CAGR(수익률)만 봤지만, 이제는 Calmar(수익/손실 비율)로 바꿔서 "수익도 높고 손실도 적은" 파라미터를 고릅니다.

---

### 14. Session 8 [Claude Opus 4.6] — 2026-02-22 16:30 (KST)

주제: GPT-5.2 WFO 아키텍처 제안에 대한 코드 기반 검토 + 3가지 질문에 대한 구체적 답변

#### 0. GPT-5.2 제안 요약 및 동의하는 부분

GPT-5.2의 핵심 제안 — "WFO가 ATR 스탑보다 먼저"라는 순서 결정 — 에 **전적으로 동의**합니다.
탐색 공간 4,200에서 선택한 최적 파라미터(buy=0.01, sell=0.05)가 진짜인지 가짜인지 모르는 상태에서,
추가 기능(ATR 스탑)을 붙이면 "검증 안 된 토대 위에 검증 안 된 구조를 추가"하는 셈입니다.

아래는 GPT-5.2가 던진 3가지 질문에 대해, **코드를 직접 조사한 결과**를 근거로 답변합니다.

---

#### 1. [질문 1] 구간 리셋형 vs 상태 연속 stitched형 — 어떤 것을 1차로?

**결론: 1차는 구간 리셋형(segment-independent reset). 2차로 stitched형 추가.**

##### 근거: run_buffer_strategy()의 상태 복잡도

`buffer_zone_helpers.py`의 `run_buffer_strategy()`를 조사한 결과, 일일 루프 내에서 관리되는 가변 상태가 **15개 이상**입니다:

| 상태 분류 | 변수                                                              | 비고                      |
| --------- | ----------------------------------------------------------------- | ------------------------- |
| 포지션    | `position`, `capital`, `entry_price`, `entry_date`                | 매수/매도 시 변경         |
| 주문 슬롯 | `pending_order: PendingOrder \| None`                             | 단일 슬롯, 신호→체결 분리 |
| 상태머신  | `hold_state: HoldState \| None`                                   | hold_days 카운트다운      |
| 이력      | `all_exit_dates: list[date]`                                      | 동적 조정 기준 (누적)     |
| 밴드      | `prev_upper_band`, `prev_lower_band`                              | 돌파 감지용 전일값        |
| 결과      | `trades: list[TradeRecord]`, `equity_records: list[EquityRecord]` | 누적                      |

이 복잡한 상태를 "구간 경계에서 직렬화/역직렬화"하는 것은 **1차 구현에 부적절**합니다. 이유:

1. **PendingOrder가 구간 경계를 넘는 경우**: i일 종가에서 매수 신호 발생 → hold_state 카운트 중 → 구간 경계 → 다음 구간에서 체결. 이를 정확히 이어 붙이려면 `hold_state.days_passed`, `pending_order.signal_date` 등의 직렬화가 필요
2. **all_exit_dates의 누적 의존성**: 동적 조정(`recent_sell_count`)이 과거 청산일 전체를 참조. 구간마다 리셋하면 이 이력이 끊김
3. **equity 연속성**: 자본금이 구간마다 리셋되면, 복리 효과를 정확히 반영하지 못함

**그러나 WFO의 1차 목적은 "과최적화 여부 검증"이지, "완벽한 stitched equity curve 생성"이 아닙니다.**

구간 리셋형의 한계(포지션 리셋, 자본금 초기화)가 있지만, 핵심 질문인 **"IS에서 선택한 파라미터가 OOS에서도 유사한 성과를 내는가?"**에 답하기에는 충분합니다.

##### tqqq/walkforward.py 선례

기존 tqqq 워크포워드도 **구간 독립(stateless)** 패턴을 사용합니다:

- 각 윈도우에서 독립적으로 `find_optimal_softplus_params()` → `simulate()` 실행
- `a_prev`, `b_prev`만 다음 윈도우로 전달 (lookahead 최적화용, 진정한 상태가 아님)
- stitched RMSE는 **별도의 연속 시뮬레이션**으로 사후 계산

백테스트 도메인도 동일한 접근이 가능합니다:

1. **1차**: 각 윈도우에서 IS 최적화 → OOS 독립 실행 → WFE/PBO 계산
2. **2차**: 윈도우별 최적 파라미터를 "params_schedule"로 모아서, 단일 연속 `run_buffer_strategy()`를 실행

##### 1차 구현 제안

```
Expanding Window (Anchored) 방식:
- 27년 데이터 (1999~2026)
- IS 시작: 고정 (1999-03)
- OOS 단위: 2년
- 첫 IS: 1999-03 ~ 2004-12 (약 6년)
- 첫 OOS: 2005-01 ~ 2006-12
- 두 번째 IS: 1999-03 ~ 2006-12 (약 8년)
- 두 번째 OOS: 2007-01 ~ 2008-12
- ... 반복 (~10~12 윈도우)

각 윈도우:
  1. IS 데이터로 그리드 서치 → CAGR 1위 파라미터 선택
  2. OOS 데이터로 독립 백테스트 실행 (initial_capital 고정, 포지션 리셋)
  3. IS/OOS 성과 기록: CAGR, MDD, Calmar, 거래수, 승률
```

**Anchored(expanding) 윈도우를 권장하는 이유:**

- 추세추종 전략은 장기 데이터에서 더 안정적인 파라미터를 찾음 (Interactive Brokers WFA 가이드 참고)
- Rolling 방식은 초기 데이터를 버리므로, 닷컴버블/금융위기 같은 핵심 레짐을 학습하지 못할 위험
- OOS 2년 단위: 16회 거래 / 27년 = 연 0.6회이므로, 1년 OOS로는 거래가 0~1회뿐일 수 있음. 2년이면 1~2회 거래가 포함될 가능성이 높아짐

---

#### 2. [질문 2] Engine 객체화 vs Resume 가능한 segment-run 함수

**결론: 둘 다 아님. "params_schedule" 방식을 제안합니다.**

##### 3가지 선택지 비교

| 방식                       | 변경 범위                                         | 테스트 난이도               | 상태 연속성 | 구현 비용 |
| -------------------------- | ------------------------------------------------- | --------------------------- | ----------- | --------- |
| **Engine 객체화**          | run_buffer_strategy 200+ 라인을 클래스로 리팩토링 | 기존 테스트 전면 수정       | 완벽        | 매우 높음 |
| **Resume segment-run**     | 상태 직렬화/역직렬화 + 새 함수                    | checkpoint 구조 테스트 필요 | 완벽        | 높음      |
| **params_schedule** (제안) | run_buffer_strategy에 파라미터 1개 추가           | 기존 테스트 영향 최소       | 완벽        | **중간**  |

##### params_schedule 방식 상세

현재 `run_buffer_strategy()`는 `params: BufferStrategyParams` 하나를 받아 전체 기간 동일한 파라미터를 사용합니다.
이를 확장하여:

```python
def run_buffer_strategy(
    signal_df: pd.DataFrame,
    trade_df: pd.DataFrame,
    params: BufferStrategyParams,
    params_schedule: dict[date, BufferStrategyParams] | None = None,  # 신규
    ...
) -> ...:
```

- `params_schedule`이 `None`이면 기존과 동일 (전체 기간 단일 파라미터)
- `params_schedule`이 주어지면, 루프 내에서 `current_date >= schedule_date`일 때 `params`를 교체
- **기존 코드 변경 최소화**: 루프 시작 부분에 3줄 추가 (`if params_schedule and current_date >= next_switch_date: params = params_schedule[next_switch_date]`)
- **포지션/현금/pending/hold_state 모두 자연스럽게 연속**: 파라미터만 바뀌지, 상태는 끊기지 않음
- **기존 테스트 영향 없음**: `params_schedule=None` (기본값)이면 기존 동작과 완전히 동일

이 방식이면:

1. WFO에서 각 윈도우별 최적 파라미터를 구한 후
2. `params_schedule = {OOS_start_1: params_1, OOS_start_2: params_2, ...}`를 구성
3. 단일 `run_buffer_strategy(signal_df, trade_df, params_initial, params_schedule=schedule)`로 stitched equity를 한 번에 생성

**Engine 객체화가 부적절한 구체적 이유:**

코드 조사 결과, `run_buffer_strategy()`의 일일 루프는 6단계 고정 순서를 따릅니다:

1. 동적 파라미터 계산 (recent_sell_count 기반)
2. pending order 체결 (시가)
3. 밴드 계산
4. equity 기록
5. 신호 감지 + pending/hold 상태 관리
6. prev_band 업데이트

이 순서가 `step()` 메서드로 추출되면, 각 단계의 의존 관계가 메서드 호출 순서에 의존하게 되어
"step을 잘못된 순서로 호출"하는 버그가 가능해집니다.
현재의 단일 함수 구조가 **순서 불변성을 강제**하므로 더 안전합니다.

---

#### 3. [질문 3] WFO 목적함수: Calmar vs DSR/PBO

**결론: 1차 Calmar, 2차 PBO (별도 분석). DSR은 WFO 목적함수가 아닌 사후 검정 도구.**

##### 역할 구분이 핵심

| 도구       | 역할                          | WFO 내부?                               | 입력                   |
| ---------- | ----------------------------- | --------------------------------------- | ---------------------- |
| **Calmar** | 파라미터 선택 기준 (목적함수) | **예** — IS에서 Calmar 1위를 OOS에 적용 | 단일 백테스트 결과     |
| **WFE**    | WFO 품질 진단                 | 아니오 — WFO 완료 후 계산               | IS/OOS 성과 비율       |
| **PBO**    | 과최적화 확률 추정            | 아니오 — WFO 완료 후 계산               | 전체 grid_results 행렬 |
| **DSR**    | 다중검정 보정 Sharpe          | 아니오 — 사후 검정                      | Sharpe + 시행 횟수     |

##### Calmar이 1차 목적함수로 적합한 이유

1. **프로젝트 목표와 직접 정렬**: 9.2절 목표가 "CAGR 18% 이상 유지 + MDD -50% 이하"이므로, CAGR/|MDD|를 최적화하는 Calmar가 가장 자연스러움
2. **추세추종에 적합**: "Calmar is the stricter measure of downside than the Sortino Ratio" — 단일 최악 드로다운을 직접 패널티 (ResearchGate 비교 연구)
3. **구현 단순**: 기존 `calculate_summary()`가 이미 CAGR/MDD를 반환하므로, `calmar = cagr / abs(mdd)` 한 줄 추가

##### PBO는 별도 분석 파이프라인으로

PBO(CSCV)는 "그리드 서치 전체 결과 행렬"에 대해 작동하므로, WFO 목적함수에 내장할 수 없습니다.
대신 다음과 같은 별도 분석이 적절합니다:

```
[기존] grid_results.csv (4,200 행)
   ↓
PBO 분석 스크립트 (pypbo 또는 자체 구현)
   ↓
p_bo 값 출력: "현재 최적 파라미터가 OOS에서 중앙값 이하일 확률"
```

이 분석은 WFO와 **독립적으로** 실행 가능하며, WFO보다 먼저 실행할 수도 있습니다.
기존 grid_results.csv가 이미 있으므로, PBO 분석은 **코드 변경 없이** 즉시 가능합니다.

##### DSR의 한계

DSR은 Sharpe 보정 도구이나 (Session 6 §5(1) 참조), 현재 핵심 문제는 Sharpe가 아닌 **MDD**이므로 Calmar + PBO 조합이 더 직접적. 1차에서는 제외 권장.

---

#### 4. GPT-5.2 제안에 대한 추가 의견

##### (1) 후보 풀 전략 — 동의하되 수정 제안

GPT-5.2의 "전체기간 Calmar 상위 N(50~200) → WFO에서 이 풀만 탐색"은 합리적이나,
**전체기간 데이터로 후보를 고르면 OOS 데이터가 후보 선정에 영향**을 미칩니다 (미래 정보 누출).

수정 제안: **첫 번째 IS 윈도우(1999~2004)에서 상위 200개를 추출**하여 후보 풀을 고정.
이후 윈도우에서는 이 200개만 평가. 이러면 후보 선정에 미래 데이터가 포함되지 않습니다.

##### (2) buy_buffer=0.01이 경계값인 문제

현재 최적 `buy_buffer=0.01`은 탐색 범위 `[0.01, 0.02, 0.03, 0.04, 0.05]`의 최솟값입니다.
WFO 이전에 먼저 **탐색 범위를 확장**(예: `[0.005, 0.01, 0.015, 0.02, ...]`)하여
0.01이 진짜 최적인지, 아니면 범위 제한에 의한 인공물인지 확인하는 것을 권장합니다.

만약 0.005가 0.01보다 더 좋다면, "진입을 최대한 빠르게"가 과최적화의 징후가 아닌 구조적 패턴일 가능성이 높아집니다.
반대로, 0.005에서 성과가 급락하면, 0.01은 노이즈 경계에서의 우연한 최적값일 수 있습니다.

##### (3) 3-Mode 비교 패턴 — 적극 채택 권장

tqqq 워크포워드의 "동적 WF / b 고정 WF / a,b 고정 WF" 3모드 비교 패턴은 백테스트에도 그대로 적용 가능합니다:

| 모드                 | 설명                                       | 진단 목적                   |
| -------------------- | ------------------------------------------ | --------------------------- |
| **동적 WFO**         | 모든 파라미터 IS 최적화                    | 기본 WFO                    |
| **sell_buffer 고정** | sell_buffer=0.05 고정, 나머지 최적화       | sell_buffer 과최적화 여부   |
| **전체 고정**        | buy=0.01, sell=0.05, hold=5, recent=2 고정 | 파라미터 전체 과최적화 여부 |

3모드 간 OOS 성과 차이가 작으면 → 파라미터가 안정적 (과최적화 리스크 낮음)
3모드 간 OOS 성과 차이가 크면 → 동적 최적화가 노이즈를 추종 (과최적화 리스크 높음)

---

#### 5. 구현 우선순위 최종 제안

**Session 6 대비 변경점**: PBO 분석(1순위)과 buy_buffer 범위 확장(2순위)을 WFO 구현 전에 선행. WFO는 구간 리셋형(3순위) → params_schedule stitched(4순위) → 3-Mode 비교(5순위) 순으로 단계적 확장.

참고 자료:

- Interactive Brokers — Walk-Forward Analysis. https://www.interactivebrokers.com/campus/ibkr-quant-news/the-future-of-backtesting-a-deep-dive-into-walk-forward-analysis/
- VectorBT WFO Pattern. https://github.com/polakowo/vectorbt/blob/master/examples/WalkForwardOptimization.ipynb
- TradeStation WFO — WFE >= 50% 기준. https://help.tradestation.com/09_01/tswfo/topics/about_wfo.htm
- GA + WFO + Calmar 목적함수 연구 (2024). https://journals.adbascientific.com/iteb/article/view/126
- Pardo's Walk-Forward Analysis methodology. https://www.amazon.com/Evaluation-Optimization-Trading-Strategies/dp/0470128011
- Backtest Overfitting in ML Era (2024) — CPCV > WF for false discovery prevention. https://www.sciencedirect.com/science/article/abs/pii/S0950705124011110

다음 모델에게:

1. PBO 분석을 기존 `grid_results.csv`에 바로 적용하는 것이 가능한지, `pypbo` 패키지의 API와 필요한 데이터 변환(현재 CSV 구조 → CSCV 입력 행렬)을 구체적으로 설계해 주세요.
2. buy_buffer 범위를 `[0.005, 0.01, 0.015]`로 확장할 경우, `MIN_BUY_BUFFER_ZONE_PCT` 상수 변경과 그리드 서치 탐색 공간 증가(4,200 → 6,300+)의 트레이드오프를 어떻게 보시는지 의견 부탁합니다.
3. WFO OOS 단위를 2년으로 제안했는데, 연 0.6회 거래 빈도를 감안하면 3년이 더 적절할 수도 있습니다. 통계적 유의성 관점에서 OOS 윈도우 크기에 대한 의견을 부탁합니다.

> **초보자 요약**: 이 세션에서 WFO를 실제로 어떻게 구현할지 기술 결정을 합니다. 결론만 보려면 각 질문의 **결론:** 부분을 확인하세요.
> **3-Mode 비교**: "과최적화 탐지기"입니다. Dynamic(매번 새로 최적화) / Sell Fixed(sell_buffer만 고정) / Fully Fixed(모두 고정) 세 버전을 비교합니다. 마치 학생 3명이 같은 시험을 보는데 — 한 명은 매번 새로 공부하고, 한 명은 핵심만 고정하고, 한 명은 아예 안 바꿉니다. "안 바꾼 학생이 잘 봤다면 원래 실력이 좋은 것(파라미터 안정), 매번 공부한 학생만 잘 봤다면 시험에 맞춰 공부한 것(과최적화 의심)"입니다.
> **WFE (Walk-Forward Efficiency)**: OOS 성과 / IS 성과. "공부한 것이 시험에서도 통했는가?"를 숫자로 표현합니다. WFE > 0.5(50%)이면 합격, WFE < 0이면 공부가 역효과를 낸 것입니다.

---

### 15. Session 9 [Claude Opus 4.6] — 2026-02-22 23:30 (KST)

주제: WFO 구현 완료 후 결과 분석 — QQQ 파라미터 안정성 확인 vs TQQQ 과최적화 경고 실증

#### 0. 구현 완료 사항

`PLAN_backtest_walkforward.md` 계획서가 전체 실행 완료되었습니다 (4 Phase, passed=340, failed=0, skipped=0).

핵심 구현:

- `src/qbt/backtest/walkforward.py`: WFO 비즈니스 로직 (Expanding Anchored + Calmar 목적함수)
- `scripts/backtest/run_walkforward.py`: CLI 스크립트 (3-Mode 비교)
- `run_buffer_strategy()`에 `params_schedule` 파라미터 추가 (Stitched Equity 지원)
- 11개 윈도우 × 432개 파라미터 조합 × 3모드 × 2전략 = 전체 파이프라인 자동화

**WFE 정의 (이 프로젝트 기준):**

```
WFE = OOS Calmar / IS Calmar  (현재 구현)
```

- Pardo(2008)와 TradeStation은 **WFE = OOS annualized profit / IS annualized profit** (수익률 기반)을 사용하며, WFE >= 50%를 "실전 적용 가능" 기준으로 제시
- 이 프로젝트는 Calmar 비율(CAGR/|MDD|) 기반이므로, **IS Calmar가 0 근처이거나 음수일 때 값이 폭주**하는 문제가 있음 (Session 9 GPT §4에서 상세 분석)
- 개선안: `WFE_CAGR = OOS_CAGR / IS_CAGR` 또는 `IS-OOS gap(median)` 방식으로 교체/보강 필요 (미구현)

#### 1. 3-Mode WFO 결과 요약

##### 1.1 TQQQ 전략 — 3-Mode 비교

| 지표                  | Dynamic     | Sell Fixed | Fully Fixed |
| --------------------- | ----------- | ---------- | ----------- |
| **OOS CAGR 평균**     | 30.02%      | 28.31%     | 15.93%      |
| **OOS CAGR 표준편차** | 49.31%      | 46.56%     | 41.26%      |
| **OOS MDD 평균**      | -42.74%     | -45.64%    | -35.96%     |
| **OOS MDD 최악**      | -67.22%     | -67.22%    | -49.42%     |
| **OOS Calmar 평균**   | 0.97        | 0.92       | 0.62        |
| **OOS 총 거래수**     | 18          | 14         | 29          |
| **OOS 승률 평균**     | 32.58%      | 32.58%     | 40.91%      |
| **WFE 평균**          | **-161.66** | -10.20     | -2.27       |
| **WFE 중앙값**        | -0.40       | -0.40      | -2.22       |
| **Stitched CAGR**     | **21.68%**  | 20.77%     | 6.97%       |
| **Stitched MDD**      | -62.09%     | -70.06%    | -61.10%     |
| **Stitched Calmar**   | **0.349**   | 0.296      | 0.114       |
| **Stitched 총수익률** | 6,018%      | 5,125%     | 311%        |

##### 1.2 QQQ 전략 — 3-Mode 비교

| 지표                  | Dynamic | Sell Fixed | Fully Fixed |
| --------------------- | ------- | ---------- | ----------- |
| **OOS CAGR 평균**     | 12.47%  | 11.97%     | **13.40%**  |
| **OOS CAGR 표준편차** | 15.59%  | 16.20%     | 16.10%      |
| **OOS MDD 평균**      | -17.14% | -17.88%    | **-17.36%** |
| **OOS MDD 최악**      | -31.26% | -31.75%    | -31.38%     |
| **OOS Calmar 평균**   | 1.03    | 1.01       | **1.10**    |
| **OOS 총 거래수**     | 10      | 11         | 10          |
| **OOS 승률 평균**     | 40.91%  | 39.39%     | 40.91%      |
| **WFE 평균**          | 4.96    | 4.89       | **5.44**    |
| **WFE 중앙값**        | 2.09    | 2.09       | **2.61**    |
| **Stitched CAGR**     | 11.81%  | 11.15%     | **12.02%**  |
| **Stitched MDD**      | -29.70% | -36.30%    | **-29.70%** |
| **Stitched Calmar**   | 0.398   | 0.307      | **0.405**   |
| **Stitched 총수익률** | 938%    | 817%       | **980%**    |

---

#### 2. 핵심 발견 — QQQ 파라미터 극도의 안정성

**QQQ의 Fully Fixed 모드가 Dynamic 모드를 능가하는 것은 매우 중요한 신호입니다.**

##### 2.1 QQQ 파라미터 안정성 분석

윈도우별 Dynamic 최적 파라미터를 추적하면:

| 윈도우       | MA  | Buy Buffer | Sell Buffer | Hold  | Recent |
| ------------ | --- | ---------- | ----------- | ----- | ------ |
| 0 (IS:~2005) | 200 | 0.01       | 0.05        | 2     | 8      |
| 1 (IS:~2007) | 200 | 0.01       | 0.05        | 2     | 8      |
| 2 (IS:~2009) | 200 | 0.01       | 0.05        | 2     | 8      |
| 3 (IS:~2011) | 200 | 0.01       | 0.05        | 2     | 8      |
| 4 (IS:~2013) | 200 | **0.03**   | 0.05        | **3** | **0**  |
| 5~10         | 200 | 0.03       | 0.05        | 3     | 0      |

**관찰:**

- **MA=200**: 11개 윈도우 전체에서 **단 한 번도 변하지 않음**
- **sell_buffer=0.05**: 11개 윈도우 전체에서 **단 한 번도 변하지 않음**
- **buy_buffer**: 0.01 → 0.03으로 한 번 전환 후 안정 (4번째 윈도우, IS에 2013년 데이터 포함 시점)
- **hold_days**: 2 → 3으로 한 번 전환 후 안정
- **recent_months**: 8 → 0으로 한 번 전환 후 안정

이 수준의 파라미터 안정성은 **과최적화가 아닌 구조적 패턴**임을 강하게 시사합니다.

특히 Fully Fixed (MA=200, buy=0.01, sell=0.05, hold=2, recent=8)가 OOS에서 Dynamic보다 오히려 좋은 성과를 내는 것은, **파라미터 변경 자체가 오히려 노이즈를 도입**하고 있다는 의미입니다.

##### 2.2 "Tight Entry, Wide Exit" 패턴 — QQQ에서 실증 확인

이전 세션(Session 6)에서 제기한 과최적화 우려, 특히 "buy=0.01과 sell=0.05가 두 전략에서 동일하게 수렴한 것이 과적합의 증거"라는 경고에 대해, QQQ WFO 결과는 **명확한 반증**을 제공합니다:

1. **첫 IS 윈도우(1999-2005, 6년)부터 동일 패턴 발견**: 데이터가 6년밖에 없는 상태에서도 MA=200, sell=0.05가 Calmar 최적
2. **OOS에서 일관된 양(+) WFE**: 전체 WFE 평균 4.96~5.44 → IS 대비 OOS 성과가 유지됨
3. **Fully Fixed가 Dynamic을 이기는 역설**: 파라미터를 바꾸지 않는 것이 더 나음 → 원래 파라미터가 진정한 최적

Newfound Research의 레버리지+추세추종 연구에서도 "200일 이동평균이 추세 필터로 가장 안정적"이라는 결론이 나와 있으며, QQQ WFO는 이를 실증적으로 뒷받침합니다.

---

#### 3. 핵심 발견 — TQQQ 과최적화 경고 실증

##### 3.1 WFE 해석

TQQQ Dynamic의 WFE 평균 -161.66은 **극단적으로 나쁜 수치**입니다. Pardo(2008)와 TradeStation 가이드에 따르면 WFE > 0.5 (50%)이면 "실전 적용 가능", WFE < 0이면 "IS 최적화가 OOS에서 역효과"를 의미합니다.

그러나 이 수치를 곧바로 "전략 실패"로 해석해서는 안 됩니다. 이유:

1. **Window 2 이상값**: IS Calmar -0.0017 (거의 0), OOS Calmar 3.162 → WFE = 3.162 / -0.0017 = **-1835**. 이 단일 이상값이 평균을 왜곡
2. **WFE 중앙값 -0.40**: 평균보다 훨씬 온건하며, OOS가 IS의 40% 수준에서 역전된 정도
3. **Stitched Equity가 말해주는 진실**: Stitched CAGR 21.68%, 총수익률 6,018% → 파라미터가 불안정하더라도 **자본곡선은 장기적으로 우상향**

##### 3.2 TQQQ 파라미터 불안정성 상세

| 윈도우          | MA      | Buy Buffer | Sell Buffer | Hold | Recent |
| --------------- | ------- | ---------- | ----------- | ---- | ------ |
| 0 (IS:~2005)    | 100     | 0.03       | **0.01**    | 3    | 12     |
| 1 (IS:~2007)    | 100     | 0.01       | **0.01**    | 0    | 4      |
| 2 (IS:~2009)    | 100     | 0.01       | **0.03**    | 5    | 4      |
| 3 (IS:~2011)    | 100     | 0.01       | **0.03**    | 5    | 4      |
| 4 (IS:~2013)    | **200** | 0.01       | **0.05**    | 3    | 8      |
| 5~7 (IS:~2019)  | 200     | 0.01       | 0.05        | 3    | 8      |
| 8~10 (IS:~2026) | **150** | **0.03**   | 0.05        | 3    | **0**  |

**관찰:**

- **sell_buffer**: 0.01 → 0.03 → **0.05로 수렴** (윈도우 4 이후 고정) — **이것이 가장 안정적인 파라미터**
- **MA window**: 100 → 200 → 150으로 진동 — **불안정**
- **buy_buffer**: 0.03 → 0.01 → 0.03으로 진동 — **불안정**
- **recent_months**: 12 → 4 → 8 → 0으로 변동 — **불안정**

##### 3.3 Fully Fixed 모드의 함정

TQQQ Fully Fixed의 Stitched CAGR이 6.97%로 매우 낮은 이유는 **첫 IS 윈도우의 최적 파라미터가 구조적으로 부적절**하기 때문입니다:

- 첫 IS(1999-2005): sell_buffer=**0.01**, MA=100 선택
- sell_buffer 0.01은 "MA 아래 1%만 내려가도 즉시 청산" → 3배 레버리지 상품에서 빈번한 휩소 유발
- 결과: OOS 총 거래 29회 (Dynamic 18회의 1.6배), 대부분 손실 거래

이는 **6년 데이터로는 TQQQ(3x 레버리지)의 최적 파라미터를 찾기 어렵다**는 것을 의미합니다. 레버리지가 변동성을 증폭시키므로, 더 긴 학습 기간이 필요합니다.

---

#### 4. QQQ vs TQQQ — 왜 이렇게 다른가

##### 4.1 레버리지 증폭 효과

| 현상                   | QQQ (1x)                  | TQQQ (3x)                  |
| ---------------------- | ------------------------- | -------------------------- |
| 파라미터 안정성        | 극도로 높음 (MA=200 고정) | 낮음 (MA 100→200→150 진동) |
| WFE                    | 양수 (4.96~5.44)          | 음수 (-161.66)             |
| 3-Mode 간 차이         | 작음 (±1.5%p CAGR)        | 큼 (6.97~21.68% CAGR)      |
| Fully Fixed vs Dynamic | Fully Fixed 승리          | Dynamic 압도적 승리        |
| OOS CAGR 표준편차      | 15.59%                    | **49.31%**                 |

arXiv(2504.20116)의 최근 연구에 따르면, 레버리지 ETF의 장기 성과는 **수익률 자기상관(return autocorrelation)**에 크게 좌우됩니다. 추세가 명확한 구간에서는 레버리지가 수익을 증폭시키지만, 추세가 불분명하거나 평균회귀 구간에서는 **변동성 드래그가 3배로 증폭**됩니다.

이 차이가 파라미터 최적화에 미치는 영향:

- QQQ: 가격 변동이 상대적으로 완만 → 넓은 파라미터 범위에서 안정적 성과 → 최적 파라미터 안정
- TQQQ: 가격 변동이 3배 증폭 → 파라미터 민감도 극도로 높음 → 최적 파라미터 불안정

##### 4.2 실전 시사점

**QQQ 전략: 고정 파라미터 운용 가능**

- MA=200, buy=0.01~0.03, sell=0.05, hold=2~3
- WFO 결과가 고정 파라미터의 안정성을 뒷받침
- 추가 최적화의 한계비용 > 한계이득

**TQQQ 전략: 동적 최적화 필요하나 주기적 재검증 필수**

- Dynamic 모드의 Stitched CAGR(21.68%)이 Fully Fixed(6.97%)의 3배 → 최적화의 가치가 있음
- 단, sell_buffer=0.05는 고정하고 나머지만 최적화하는 **Sell Fixed 모드가 실전 운용에 가장 적합**할 수 있음
- Sell Fixed의 Stitched CAGR(20.77%)은 Dynamic(21.68%)과 유사하면서 구현 복잡도가 낮음

---

#### 5. sell_buffer=0.05의 범용 안정성 확인

이번 WFO에서 가장 중요한 발견은 **sell_buffer=0.05가 두 전략(QQQ, TQQQ) 모두에서 범용적으로 안정적**이라는 것입니다:

- QQQ: 11개 윈도우, 3개 모드 전체에서 0.05 고정
- TQQQ Dynamic: 윈도우 4 이후(IS에 2013년 데이터 포함 시점부터) 0.05 고정
- TQQQ Sell Fixed: 0.05 강제 고정이 Dynamic과 유사한 성과

이는 "MA 아래 5%까지 하락해야 청산"이라는 규칙이 **추세추종 전략에서 구조적으로 합리적**임을 의미합니다. 청산이 너무 빠르면(sell=0.01~0.03) 정상 조정을 휩소로 잘못 판단하여 장기 추세를 놓칩니다.

---

#### 6. 이전 과최적화 경고(Session 6)에 대한 업데이트된 평가

| 경고 항목                  | Session 6 판단   | WFO 실증 결과                                           | 수정된 판단                                                |
| -------------------------- | ---------------- | ------------------------------------------------------- | ---------------------------------------------------------- |
| buy=0.01이 탐색 경계       | 과최적화 의심    | QQQ에서 0.01이 안정적, 이후 0.03으로 자연 전환          | **구조적 패턴** (경계값이지만 유효)                        |
| sell=0.05가 두 전략 동일   | 우연의 일치 가능 | 11윈도우 × 2전략 모두 0.05 수렴                         | **범용 최적값**                                            |
| CAGR 3.14%p 개선이 인공물  | 높은 가능성      | QQQ Stitched로 검증: 12.02% (Fixed) vs 11.81% (Dynamic) | **QQQ에서는 진짜, TQQQ에서는 추가 검증 필요**              |
| 두 전략 파라미터 완전 일치 | 과적합 징후      | QQQ는 안정, TQQQ는 IS 기간에 따라 변동                  | **시그널(QQQ) 파라미터는 안정, 레버리지 차이는 별도 문제** |

---

#### 7. 제안: 다음 단계

##### (1) TQQQ WFO 개선 — 초기 윈도우 IS 기간 확장 검토

현재 초기 IS 72개월(6년)은 QQQ에는 충분하지만, TQQQ에는 부족한 것으로 보입니다. 첫 윈도우에서 sell_buffer=0.01을 선택하는 것이 이후 성과를 크게 좌우합니다.

검토 사항:

- 초기 IS를 96개월(8년)로 확장하면 첫 윈도우가 닷컴 버블 회복기(2003-2007)까지 포함
- 이 경우 sell_buffer=0.05가 첫 윈도우에서도 선택될 가능성이 높아짐
- 단, 윈도우 수가 11 → 10으로 감소

##### (2) Sell Fixed 모드를 TQQQ 실전 운용 기준으로 고려

TQQQ에서 sell_buffer=0.05를 고정하고 나머지만 최적화하는 Sell Fixed 모드가 실전에 적합할 수 있습니다:

- Dynamic 대비 CAGR 차이 작음 (21.68% vs 20.77%)
- 구현 복잡도 낮음 (1개 파라미터 고정)
- sell_buffer의 범용 안정성이 이미 확인됨

##### (3) PBO 분석 — 여전히 필요하나 우선순위 조정

QQQ에서 Fully Fixed가 Dynamic을 이기는 결과는 PBO가 낮음을 간접적으로 시사합니다.
그러나 TQQQ에서는 여전히 PBO가 높을 가능성이 있으므로, TQQQ grid_results.csv에 대한 CSCV 분석은 유효합니다.

##### (4) ATR 트레일링 스탑 — MDD 해결 여전히 필요

WFO Stitched 결과에서도 MDD 목표(-50%)는 미달성:

- TQQQ Dynamic Stitched MDD: -62.09%
- QQQ Dynamic Stitched MDD: -29.70% (QQQ는 목표 달성)

TQQQ의 MDD를 줄이려면, 보유 중 조기 청산 메커니즘(ATR 트레일링 스탑)이 여전히 필수입니다.
단, WFO 인프라가 이미 구축되었으므로 ATR 스탑 추가 후 동일한 WFO 파이프라인으로 검증이 가능합니다.

##### (5) 우선순위 재조정

| 순위  | 방법                            | 근거                           | 상태      |
| ----- | ------------------------------- | ------------------------------ | --------- |
| **1** | **WFO 구현**                    | ✅ 완료                        | **Done**  |
| **2** | **ATR 트레일링 스탑**           | TQQQ MDD -62% → 목표 -50% 이하 | 다음 진행 |
| **3** | **PBO 분석 (TQQQ)**             | TQQQ 과최적화 정량 검증        | 대기      |
| **4** | **TQQQ 초기 IS 기간 확장 실험** | 첫 윈도우 sell_buffer 안정화   | 대기      |

참고 자료:

- Pardo, R.E. (2008). "The Evaluation and Optimization of Trading Strategies" — WFE >= 50% 기준
- arXiv (2504.20116) — 레버리지 ETF 수익률 자기상관과 복리 효과
- Newfound Research — Leverage and Trend Following. https://blog.thinknewfound.com/2018/05/leverage-and-trend-following/
- Unger Academy — Walk-Forward Analysis 해석. https://ungeracademy.com/posts/how-to-use-walk-forward-analysis-you-may-be-doing-it-wrong
- Interactive Brokers — Walk-Forward Analysis 가이드. https://www.interactivebrokers.com/campus/ibkr-quant-news/the-future-of-backtesting-a-deep-dive-into-walk-forward-analysis/
- QuantPedia — Leveraged ETFs in Low-Volatility Environments. https://quantpedia.com/leveraged-etfs-in-low-volatility-environments/
- Lambrospetrou — MACD 기반 QQQ/TQQQ 전략 백테스트. https://www.lambrospetrou.com/articles/investing-leveraged-qqq-macd/
- TradeStation WFO 가이드. https://help.tradestation.com/09_01/tswfo/topics/about_wfo.htm
- Surmount — Walk-Forward Analysis vs Backtesting. https://surmount.ai/blogs/walk-forward-analysis-vs-backtesting-pros-cons-best-practices

다음 모델에게:

1. QQQ에서 Fully Fixed가 Dynamic을 이기는 결과에 대해, 이것이 **"simple is better"** 원칙의 실증인지, 아니면 QQQ 데이터의 특수성(낮은 변동성, 장기 우상향 추세)에 기인하는 것인지 의견 부탁합니다.
2. TQQQ에서 sell_buffer=0.05를 고정하고 나머지를 최적화하는 Sell Fixed 모드를 실전 운용 기준으로 채택하는 것에 대해, **거래 비용/슬리피지 측면**에서 Dynamic 대비 실질적 우위가 있는지 분석해 주세요.
3. ATR 트레일링 스탑 구현 시, WFO 파이프라인에 어떻게 통합할 것인지 (ATR 파라미터도 IS에서 최적화? 아니면 고정값?) 설계 방향을 제안해 주세요.
4. TQQQ 첫 IS 윈도우에서 sell_buffer=0.01이 선택되는 문제를 해결하기 위해, 초기 IS 기간을 늘리는 것 외에 **"Calmar + 최소 거래수 제약"** 같은 목적함수 변형이 더 적절할 수도 있습니다. 이에 대한 의견을 부탁합니다.

---

### 16. Session 10 [GPT-5.2 Thinking] — 2026-02-22 15:45 (KST)

주제: Backtest-WFO(stitched) 구현 완료 후 결과 분석 — TQQQ/QQQ 3-Mode 비교 + 다음 액션

먼저 정정합니다. 제가 직전에 `quant.tar.gz` 안에 WFO 결과/코드가 없다고 말했는데, **다시 압축을 풀고 경로를 재검증하니 요청하신 파일들이 모두 존재**했습니다(특히 `src/qbt/backtest/walkforward.py`, `scripts/backtest/run_walkforward.py`, `tests/test_backtest_walkforward.py`, 그리고 `storage/results/backtest/buffer_zone_{tqqq,qqq}/walkforward_*`). 혼선을 드려 죄송합니다.

아래 분석은 “공유 문서”는 **별도 첨부본**을 기준으로 맥락을 잡고(목표: MDD -50 등), 실제 수치/결론은 **아카이브의 WFO 산출물(walkforward_summary.json + window csv + stitched equity csv)**을 기반으로 작성합니다.

---

## 1) WFO 구현(Expanding Anchored + Stitched) 설계가 의도대로 동작하는지

- **윈도우 구성**: 초기 IS 72개월(6년), 이후 OOS 24개월(2년)씩 전진하는 **Expanding Anchored WFO** (총 11개 OOS 윈도우) — 마지막 OOS는 2025-03-01 ~ 2026-02-17까지 포함.
- **IS 최적화 목적함수**: 각 윈도우에서 **Calmar(CAGR/|MDD|)** 기준으로 그리드 서치 → OOS 독립 평가.
- **Stitched equity**: `params_schedule`로 OOS 구간 시작일마다 파라미터를 전환하며 **연속 자본곡선을 생성(= stitched)**. 이 방식이 WFO의 핵심이며 “OOS 구간을 이어 붙인 라이브 유사 시뮬레이션” 개념과 일치합니다. ([THE ROBUST TRADER][1])

또한 WFO가 전략의 일반화 여부를 보기 위한 표준적 방법론이라는 “골드 스탠다드” 관점은 문서/외부 리서치와도 정합적입니다. ([Quantammsim][2])

---

## 2) 핵심 결론 요약(3-Mode): “QQQ는 고정이 이기고, TQQQ는 동적이 이김”

> 3-Mode 상세 수치는 §14의 1절 참조. 아래는 GPT-5.2의 해석입니다.

- **TQQQ**: Dynamic이 Stitched CAGR/Calmar 1등. 기존 MDD -87.97% → **-62.09%로 약 26%p 개선** (WFO + Calmar 목적함수의 효과)
- **QQQ**: Fully Fixed가 1등. 파라미터가 매우 안정적이라 재최적화가 오히려 불필요

---

## 3) “Sell Fixed(0.05)”가 TQQQ에서 깨지는 이유가 데이터로 보임

- QQQ Dynamic에서는 **sell=0.05가 11/11 윈도우에서 선택**됨 → 그래서 QQQ는 “sell 고정”이 합리적(안정성 강함).
- TQQQ Dynamic에서는 **sell=0.05가 7/11**이고, 나머지 4개 윈도우는 **sell=0.01 또는 0.03**을 선택 → 즉, TQQQ는 특정 구간에서 **더 타이트한 청산 밴드가 필요**했던 흔적이 분명합니다.

이게 그대로 stitched 결과에 반영되어,

- **TQQQ Sell Fixed의 최악 MDD(-70.06)는 2009-05-13(금융위기 바닥 부근)에서 발생**
- 반면 **TQQQ Dynamic의 최악 MDD(-62.09)는 2020-03-12(코로나 쇼크)에서 발생**
  → Dynamic은 최소한 “2009식 파국”을 상당 부분 회피했지만, “2020 급락”은 여전히 크게 맞았습니다.

---

## 4) WFE 지표 해석 주의점(현재 구현은 “Calmar 비율”이라 폭주 가능)

현재 구현된 WFE는 `WFE = OOS Calmar / IS Calmar` 입니다. (코드/산출물에서 확인)

문제:

- IS Calmar가 **0 근처거나 음수**가 되는 윈도우가 있으면, WFE가 **부호가 뒤집히거나(음수), 값이 폭주**합니다.
- 실제로 TQQQ Dynamic에서 `is_calmar=-0.0017` 같은 윈도우가 있어 WFE 평균이 **의미 없는 값(큰 음수)**로 망가집니다.

일반적인 WFE 정의는 “OOS의 연환산 성과 / IS의 연환산 성과” (보통 annualized profit 기준)처럼 **수익 기반 비율**로 설명되는 경우가 많습니다. ([Unger Academy][3])
➡️ 제안: 다음 중 하나로 교체/보강하는 게 좋아 보입니다.

1. `WFE_CAGR = OOS_CAGR / IS_CAGR` (IS_CAGR≈0이면 예외 처리)
2. **비율 대신 차이**: `OOS_calmar - IS_calmar`의 **median**을 “IS-OOS gap”으로 사용(폭주 방지)
3. `IS_calmar <= 0`인 윈도우는 WFE 계산에서 제외하고 median만 사용(robust)

---

## 5) MDD -50 목표 관점의 다음 액션(“WFO로 검증 끝났으니, 이제 MDD를 직접 때려야 함”)

공유 문서에서 목표가 **MDD -50 이하**로 명확합니다.
이번 WFO 결과는 “버퍼 분리만으론 MDD 해결이 어렵다”는 이전 결론을 뒤집지는 못했지만, **MDD를 -88 → -62로 큰 폭 개선**시켰고, 이제 남은 갭(-12%p)을 줄이려면 아래 순서가 현실적입니다.

### (1) TQQQ 한정: Sell Fixed 상수 재실험(0.05 말고)

TQQQ는 구간별로 sell이 0.01/0.03로 내려가는 윈도우가ell_fixed=0.03’ / ‘sell_fixed=0.01’로 2회 추가\*\*하면,

- 계산비용은 거의 그대로(오히려 더 적음)
- “sell을 고정해도 MDD가 유지되는 고정값”을 찾을 가능성이 큼
  → 이게 성공하면, 앞으로 탐색공간 자체를 더 줄여 과최적화/비용을 동시에 줄일 수 있습니다(다중검정 리스크 완화). ([davidhbailey.com][4])

### (2) ATR 트레일링 스탑(Phase 1)로 “2020류 급락”을 직접 겨냥

Dynamic의 최악 MDD가 2020-03-12에 발생했다는 점은, “하단 밴드 기반 청산만으로는 급락 구간에서 늦게 판다”는 기존 진단과 맞물립니다.
따라서 다음 개선은 공유 문서 우선순위에서도 언급된 **ATR 트레일링 스탑**이 가장 직접 타격입니다.

### (3) 목적함수(제약) 강화: “Calmar 최대”가 아니라 “MDD 제약 + Calmar”

이번 WFO가 Calmar로도 MDD를 크게 줄였지만, 아직 -50을 못 넘겼으니:

- **최적화에서 “MDD <= -50이면 큰 패널티”** 같은 **제약형 목적함수**를 한 번 실험해볼 만합니다포기하고 MDD를 더 줄이는” 방향이 목표와 일치합니다.

---

참고URL)

```text
https://quantammsim.readthedocs.io/en/latest/tutorials/walk_forward_analysis.html
https://en.wikipedia.org/wiki/Walk_forward_optimization
https://ungeracademy.com/posts/how-to-use-walk-forward-analysis-you-ma :contentReference[oaicite:14]{index=14}ttps://www.davidhbailey.com/dhbpapers/backtest-prob.pdf
https://www.davidhbailey.com/dhbpapers/deflated-sharpe.pdf
https://therobusttrader.com/walk-forward-analysis-testing-optimization-wfa/
```

다음 모델에게:

1. **TQQQ 추가 모드 2 실험 제안**: `sell_fixed=0.03`, `sell_fixed=0.01` 두 번 더 돌려서 stitched MDD/CAGR/Calmar를 비교해 주세요. (TQQQ는 sell=0.05 고정이 명백히 손해였음)
2. **WFE 지표 개선 PR/제안**: 현재 `Calmar 비율` WFE가 TQQQ에서 폭주하니, `WFE_CAGR` 또는 `IS-OOS gap(median)`로 교체/추가하는 방안을 코드레벨로 제안해 주세요. ([Unger Academy][3])
3. Dynamic TQQQ에서 MDD가 **2020-03-12**에 찍힌 원인을 equity/position 관점에서 짧게 해부(“왜 이 구간에서 못 피했는지”)해 주면, ATR 스탑 설계(어떤 형태가 맞는지)로 바로 연결하겠습니다.

[1]: https://therobusttrader.com/walk-forward-analysis-testing-optimization-wfa/ "https://therobusttrader.com/walk-forward-analysis-testing-optimization-wfa/"
[2]: https://quantammsim.readthedocs.io/en/latest/tutorials/walk_forward_analysis.html "https://quantammsim.readthedocs.io/en/latest/tutorials/walk_forward_analysis.html"
[3]: https://ungeracademy.com/posts/how-to-use-walk-forward-analysis-you-may-be-doing-it-wrong "https://ungeracademy.com/posts/how-to-use-walk-forward-analysis-you-may-be-doing-it-wrong"
[4]: https://www.davidhbailey.com/dhbpapers/backtest-prob.pdf "https://www.davidhbailey.com/dhbpapers/backtest-prob.pdf"

> **초보자 요약**: 이 세션은 WFO 연구의 최종 성적표입니다.
> **QQQ**: 한 번 정한 파라미터(MA=200, sell=0.05)를 27년간 바꾸지 않아도 잘 동작합니다. 한 번 배운 수영 실력이 20년이 지나도 유효한 것과 같습니다. Fully Fixed(모두 고정)가 Dynamic(매번 재최적화)보다 오히려 더 좋은 성적을 냈으므로, "파라미터를 바꾸지 않는 것이 최선"이라는 매우 드문 결과입니다.
> **TQQQ**: QQQ와 달리 파라미터가 불안정하여 주기적으로 업데이트가 필요합니다. 하지만 MDD가 -88% → -62%로 크게 개선되었고, 나머지 -12%p를 줄이려면 ATR 트레일링 스탑이 다음 과제입니다.
> **공통 발견**: sell_buffer=0.05는 두 전략 모두에서 가장 안정적인 값으로, 이것은 우연이 아닌 구조적 특성입니다.
> GPT-5.2의 추가 분석에서는, WFE 지표가 Calmar 비율 기반이라 IS 값이 0에 가까울 때 나눗셈이 폭주하는 문제(예: 3.16 / -0.001 = -3,160)가 발견되어, CAGR 기반 WFE로 교체를 제안했습니다.

---

### 17. Session 11 [GPT-5.2 Thinking] — 2026-02-22 16:05 (KST)

주제: **WFO 구현 완료 후 결과 분석(3-Mode) + “신뢰도 진단 지표(Profit Concentration/WFE) 보강” + 다음 단계(ATR 스탑 WFO 통합)**

아래 내용은 `storage/results/backtest/buffer_zone_{tqqq,qqq}/walkforward_summary.json` 및 `walkforward_{dynamic,sell_fixed,fully_fixed}.csv`, `walkforward_equity_*.csv` 기준으로 정리했습니다. (WFO는 Expanding Anchored + Stitched 방식으로 “현업형 검증”에 가까운 구성입니다. ([위키피디아][1]))

## 1) 3-Mode WFO 핵심 결론(요약)

### 1.1 QQQ: **파라미터가 “극도로 안정” → Fully Fixed가 최고**

- **Stitched(전체 OOS 이어붙임)**
  - Dynamic: CAGR **11.81%**, MDD **-29.70%**, Calmar **0.398**
  - Sell Fixed: CAGR **11.15%**, MDD **-36.30%**, Calmar **0.307**
  - **Fully Fixed: CAGR 12.02%**, **MDD -29.70%**, **Calmar 0.405** _(최고)_

- 해석: **“튜닝이 이득이 아니라 노이즈”**인 상태. 즉 QQQ는 “고정 파라미터 운영”이 합리적이며, 추가 최적화의 한계효용이 낮습니다.

### 1.2 TQQQ: **파라미터 불안정 → Dynamic이 최고(하지만 MDD 목표는 미달)**

- **Stitched**
  - **Dynamic: CAGR 21.68%**, MDD **-62.09%**, **Calmar 0.349** _(최고)_
  - Sell Fixed(sell=0.05 고정): CAGR 20.77%, MDD -70.06%, Calmar 0.296
  - Fully Fixed(초기 IS 최적 파라미터 고정): CAGR 6.97%, MDD -61.10%, Calmar 0.114

- 해석: TQQQ는 레버리지 특성상 레짐 민감도가 커서(변동성/추세 구조 변화) **윈도우별 최적 파라미터가 크게 흔들리고**, 그 결과 **동적 재최적화의 가치가 실제로 존재**합니다. 다만 **목표 MDD(-50)**까지는 아직 약 **12%p 갭**이 남아 있어, 다음 단계는 “추가 리스크 관리(특히 보유 중 조기 청산)”가 필요합니다.

## 2) 파라미터 안정성 관찰: “sell=0.05는 구조적 후보”

- QQQ Dynamic: **sell=0.05가 11/11 윈도우 고정**, MA=200도 11/11 고정 → 구조적 안정 패턴.
- TQQQ Dynamic: sell이 **0.01→0.03→0.05로 수렴**, 특히 **2013년 이후는 0.05가 사실상 고정**.
- 실전적 제안: **향후 탐색공간 축소(계산비용↓/다중검정↓)**를 위해,
  - QQQ는 *sell 고정(0.05) + MA=200 고정*을 기본 전제로 두고,
  - TQQQ도 “sell=0.05 고정”을 강하게 후보로 두되, **리스크는 ATR 스탑으로 처리**하는 방향이 자연스럽습니다.
    (탐색공간이 커질수록 선택편향이 커지므로, 이후 단계에서 DSR 같은 보정 관점도 함께 보는 게 좋습니다. ([David H Bailey][2]))

## 3) (중요) WFE 해석 문제: 현재 `wfe_calmar`는 “폭주/왜곡” 가능

현재 구현/결과의 WFE는 `WFE = OOS_Calmar / IS_Calmar` 형태인데, IS Calmar가 0 근처/음수면 **부호 반전·폭주**가 발생합니다(실제로 TQQQ에서 `is_calmar=-0.0017`로 WFE 평균이 -161 같은 형태로 망가짐).

- TradeStation은 WFE를 “rule-of-thumb”으로 다루면서 **50% 이상**을 성공 기준으로 언급하고, **수익/손실/거래의 분포가 고르지 않거나 특정 기간이 전체 순이익의 50%+를 차지하면 WFA가 무효화될 수 있다**고 경고합니다. ([TradeStation 도움말][3])
- 또한 WFE는 흔히 “IS 대비 OOS 성과 비율”로 설명되며(정의/실무 관례가 다양), 최소한 현재처럼 “0 근처 분모”에 취약한 형태는 **보강 지표가 필요**합니다. ([Unger Academy][4])

**제안(코드/요약 지표 보강)**

1. `wfe_cagr = oos_cagr / is_cagr` (is_cagr≈0이면 None 처리)
2. `gap_calmar = median(oos_calmar - is_calmar)` (비율 대신 차이/중앙값)
3. 그리고 아래 “profit concentration” 지표를 반드시 추가

## 4) (추가 신뢰도 진단) Profit Concentration: TQQQ는 “한 구간 의존” 경고등

Stitched equity를 OOS 윈도우별로 분해해서 **각 OOS 구간의 순이익 기여도**를 계산해보면:

- **TQQQ Dynamic**: 2023-03 ~ 2025-02 OOS 한 구간이 **전체 순이익의 약 67%**를 차지
- **TQQQ Sell Fixed**: 동일 구간이 **약 67.5%** 차지
- **QQQ Fully Fixed**: 최대 기여 구간이 **약 47.6%** 수준(50% 미만)

TradeStation이 말하는 “특정 기간이 전체 순이익의 50% 이상을 차지하면 WFA 신뢰성에 경고”라는 휴리스틱에照해보면, **TQQQ는 아직 ‘레짐 의존/집중’ 리스크가 크다**고 보는 것이 안전합니다. ([TradeStation 도움말][3])
→ 이건 “전략이 나쁘다”가 아니라, **레버리지 상품의 본질(강한 상승장에서 복리 폭발)**이 그대로 드러난 것이고, 그래서 목표 MDD(-50)를 달성하려면 **급락/변동성 확대 구간 방어 장치(ATR 스탑/vol targeting 등)**가 핵심이라는 결론으로 이어집니다.

## 5) 다음 단계 제안: ATR 트레일링 스탑을 WFO 파이프라인에 통합(Phase 1)

목표가 “TQQQ stitched MDD -62 → -50 이하”이므로, 다음 실험은 **보유 중 조기 청산**을 넣어야 합니다. ATR 트레일링 스탑은 변동성 기반으로 스탑 레벨을 동적으로 두는 대표적 접근입니다. ([차트스쿨][5])

**권장 최소 설계(탐색폭 제한 버전)**

- ATR 계산: trade_df(TQQQ synthetic)의 가격 기준, `ATR(n)` (n=14 또는 20)
- 트레일링 스탑: `stop_price = highest_close_since_entry - k * ATR(n)`
- 조건: `close < stop_price`이면 다음 시가 청산(기존의 “신호-체결 분리” 규칙 유지)
- 파라미터 탐색은 처음엔 너무 넓히지 말고(다중검정↑), 예:
  - `n ∈ {14, 20}`, `k ∈ {3, 4, 5}` 정도(6조합)로 시작

- 검증: **같은 WFO(11윈도우/3-Mode) 파이프라인**으로 stitched MDD 개선 여부를 확인
  - 성공 기준(초안): TQQQ Dynamic(or Sell Fixed + ATR) stitched MDD ≤ -50 & Calmar 유지/상승

(추가로, 다중검정/선택편향이 다시 커지므로 “성과가 좋아졌을 때”는 DSR 같은 보정 관점으로 한 번 더 확인하는 걸 권장합니다. ([David H Bailey][2]))

---

참고 자료:

- Walk-forward optimization “gold standard” 개요: [https://en.wikipedia.org/wiki/Walk_forward_optimization](https://en.wikipedia.org/wiki/Walk_forward_optimization) ([위키피디아][1])
- TradeStation WFO OOS Summary (WFE 50% rule-of-thumb, profit concentration 경고): [https://help.tradestation.com/09_01/tswfo/topics/walk-forward_summary_out-of-sample.htm](https://help.tradestation.com/09_01/tswfo/topics/walk-forward_summary_out-of-sample.htm) ([TradeStation 도움말][3])
- Walk Forward Analysis 실무 해석/주의: [https://ungeracademy.com/posts/how-to-use-walk-forward-analysis-you-may-be-doing-it-wrong](https://ungeracademy.com/posts/how-to-use-walk-forward-analysis-you-may-be-doing-it-wrong) ([Unger Academy][4])
- ATR Trailing Stops 개념(변동성 기반 스탑): [https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-indicators/atr-trailing-stops](https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-indicators/atr-trailing-stops) ([차트스쿨][5])
- Deflated Sharpe Ratio(선택편향/다중검정 보정): [https://www.davidhbailey.com/dhbpapers/deflated-sharpe.pdf](https://www.davidhbailey.com/dhbpapers/deflated-sharpe.pdf) ([David H Bailey][2])

다음 모델에게:

1. **지표 보강 PR 제안**: `walkforward_summary.json`에 `profit_concentration_max_share`(최대 OOS 순이익 기여도)와 해당 `window_idx/date_range`를 추가해 주세요. TradeStation 휴리스틱(50%+) 기반으로 “경고 플래그”도 같이 있으면 좋습니다. ([TradeStation 도움말][3])
2. **WFE 재정의 보강**: 현재 `wfe_calmar` 유지하더라도, `wfe_cagr` 또는 `median(oos_calmar - is_calmar)` 같은 robust 지표를 같이 저장하도록 개선해 주세요. ([Unger Academy][4])
3. **ATR 스탑 Phase 1 설계 의견 요청**: (n,k) 후보를 최소 폭으로 잡았을 때, “TQQQ는 Sell Fixed + ATR”이 더 실전형인지, 아니면 “Dynamic + ATR”이 더 적절한지(복잡도/안정성 트레이드오프) 논의가 필요합니다.

[1]: https://en.wikipedia.org/wiki/Walk_forward_optimization?utm_source=chatgpt.com "Walk forward optimization"
[2]: https://www.davidhbailey.com/dhbpapers/deflated-sharpe.pdf?utm_source=chatgpt.com "THE DEFLATED SHARPE RATIO: CORRECTING FOR SELECTION BIAS, BACKTEST ... - David H. Bailey"
[3]: https://help.tradestation.com/09_01/tswfo/topics/walk-forward_summary_out-of-sample.htm?utm_source=chatgpt.com "Walk-Forward Summary (Out-Of-Sample) - TradeStation"
[4]: https://ungeracademy.com/posts/how-to-use-walk-forward-analysis-you-may-be-doing-it-wrong?utm_source=chatgpt.com "How to Use Walk Forward Analysis: You May Be Doing It Wrong! - Unger Academy"
[5]: https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-indicators/atr-trailing-stops?utm_source=chatgpt.com "ATR Trailing Stops | ChartSchool | StockCharts.com"

---

### 18. Session 12 [Claude Opus 4.6] — 2026-02-22 17:30 (KST)

주제: WFO 결과 독립 검토 + WFE/Profit Concentration 지표 보강 설계 + ATR 스탑 WFO 통합 아키텍처 + 2020-03 MDD 해부

#### 0. 이전 세션 질문 대응 범위

이 세션은 3개 세션(Session 9, Session 9 GPT-5.2 추가, Session 10 GPT-5.2)의 질문을 통합 대응합니다.

| 출처               | 질문                                               | 본 세션 대응 절 |
| ------------------ | -------------------------------------------------- | --------------- |
| Session 9 §Q1      | QQQ Fully Fixed > Dynamic은 "simple is better"인가 | §1              |
| Session 9 §Q2      | TQQQ Sell Fixed 실전 운용 — 거래비용/슬리피지 분석 | §2              |
| Session 9 §Q3      | ATR 트레일링 스탑 WFO 통합 설계                    | §5              |
| Session 9 §Q4      | 첫 IS 윈도우 sell_buffer=0.01 문제 해결            | §4              |
| Session 9 GPT §Q1  | sell_fixed=0.03, 0.01 추가 모드 실험               | §2.3            |
| Session 9 GPT §Q2  | WFE 지표 개선                                      | §3              |
| Session 9 GPT §Q3  | 2020-03-12 MDD 원인 해부                           | §6              |
| Session 10 GPT §Q1 | Profit Concentration 지표 설계                     | §4              |
| Session 10 GPT §Q2 | WFE 재정의 보강                                    | §3              |
| Session 10 GPT §Q3 | ATR Sell Fixed+ATR vs Dynamic+ATR                  | §5.3            |

---

#### 1. QQQ "Simple is Better" — 실증인가, 특수성인가

**결론: 둘 다 맞다. "simple is better"는 진짜이지만, QQQ 데이터의 특수성이 이를 극단적으로 강화한다.**

##### 1.1 학술적 근거: 단순 규칙의 구조적 우위

DeMiguel, Garlappi & Uppal(2009)의 "Optimal Versus Naive Diversification"은 14개의 최적화 포트폴리오 모델 중 **어느 것도 단순 1/N(동일 가중)을 일관되게 이기지 못했다**고 보고합니다. 핵심 통찰은 **bias-variance tradeoff**: 파라미터 수가 늘어날수록 추정 오차(variance)가 커져 OOS 성과가 악화됩니다.

25개 자산 기준, 표본 기반 평균-분산 전략이 1/N을 이기려면 **약 3,000개월(250년)**의 데이터가 필요하다는 정량 결과가 있습니다.

본 프로젝트의 27년(324개월) 데이터는 이 기준에 한참 미달하므로, **파라미터 5개(MA, buy_buf, sell_buf, hold, recent)의 동적 최적화가 고정 파라미터를 이기기 어려운 것은 이론적으로 자연스럽습니다.**

##### 1.2 QQQ 데이터의 특수성 — "추세 일관성"

코드 기반 사실 확인: QQQ Dynamic WFO에서 11개 윈도우의 파라미터 추적 결과:

- **MA=200**: 11/11 윈도우 고정
- **sell_buffer=0.05**: 11/11 윈도우 고정
- **buy_buffer**: 0.01(4개) → 0.03(7개), 한 번 전환 후 안정
- **hold_days**: 2(4개) → 3(7개), 한 번 전환 후 안정

이 수준의 파라미터 안정성은 **QQQ가 1999-2026년 동안 장기 우상향 추세를 일관되게 유지**했기 때문입니다. 나스닥 100은 닷컴버블/금융위기에서도 결국 회복하여 신고가를 갱신하는 패턴을 반복했고, 이 구조적 추세는 MA=200이라는 장기 이동평균에 자연스럽게 포착됩니다.

반면, TQQQ는 3배 레버리지로 변동성이 증폭되어 파라미터 민감도가 극도로 높아집니다. arXiv(2504.20116)의 최근 연구가 확인한 대로, 레버리지 ETF의 장기 성과는 수익률 자기상관(return autocorrelation)에 크게 좌우되므로, QQQ와 동일한 파라미터가 TQQQ에서는 불안정해지는 것입니다.

##### 1.3 실무적 시사점

| 전략     | 운용 방식                                                              | 근거                                              |
| -------- | ---------------------------------------------------------------------- | ------------------------------------------------- |
| **QQQ**  | **고정 파라미터 운용** (MA=200, buy=0.01, sell=0.05, hold=2, recent=8) | Fully Fixed가 Dynamic을 이김, WFE 양수(5.44)      |
| **TQQQ** | **주기적 재최적화** (sell=0.05 고정, 나머지 Dynamic)                   | Dynamic이 Fully Fixed의 3배 성과, 파라미터 불안정 |

**"AQR의 반론"에 대한 의견**: Kelly, Malamud, Zhou(2024)의 "Virtue of Complexity" 논문은 충분한 shrinkage와 관련성 높은 시그널이 있으면 복잡 모델이 유리하다고 주장합니다. 그러나 이는 대규모 데이터와 정교한 정규화가 전제입니다. 본 프로젝트의 16~29회 거래 데이터에서는 bias-variance tradeoff가 압도적으로 단순 모델 쪽에 유리합니다.

---

#### 2. TQQQ Sell Fixed 실전 운용 — 거래비용/슬리피지 분석

##### 2.1 거래비용 비교

코드 확인 결과, 현재 비용 모델은 `SLIPPAGE_RATE = 0.003` (0.3%, 슬리피지+수수료 통합)입니다.

| 모드        | OOS 총 거래수 | 거래당 비용 | 총 비용 추정 | Stitched CAGR |
| ----------- | ------------- | ----------- | ------------ | ------------- |
| Dynamic     | 18회          | 0.6% (왕복) | 10.8%        | 21.68%        |
| Sell Fixed  | 14회          | 0.6% (왕복) | 8.4%         | 20.77%        |
| Fully Fixed | 29회          | 0.6% (왕복) | 17.4%        | 6.97%         |

**Sell Fixed가 Dynamic보다 4회 적게 거래**하므로, 거래비용 절감은 약 2.4%p(총 비용 기준). 그러나 Stitched CAGR 차이가 0.91%p(21.68% vs 20.77%)이므로, 거래비용 절감만으로는 Sell Fixed의 약간 낮은 수익률을 보상하기 어렵습니다.

##### 2.2 실전 운용 관점에서의 진짜 우위

Sell Fixed의 실전 우위는 거래비용이 아니라 **운용 복잡도 감소**에 있습니다:

1. **탐색 공간 축소**: sell_buffer 3개 값 × 나머지 = 432 → 144 조합 (67% 감소). 다중검정 리스크도 비례하여 감소
2. **구현 단순성**: sell_buffer를 상수로 고정하면, 재최적화 시 변동 파라미터가 4개 → 3개 (plus MA window 고정 시 2개)
3. **MDD 관점 열위**: 그러나 Sell Fixed의 Stitched MDD(-70.06%)가 Dynamic(-62.09%)보다 8%p 나쁜 점은 간과할 수 없음

##### 2.3 sell_fixed=0.03, sell_fixed=0.01 추가 모드 실험에 대한 의견

GPT-5.2가 제안한 추가 sell_fixed 실험에 대해 **동의하되, 순서를 조정**합니다:

**실험 불필요 근거 — 이미 데이터에서 답이 보임:**

TQQQ Dynamic 윈도우별 sell_buffer 추적:

```
Win 0~1 (IS:~2007): sell=0.01 → OOS CAGR 모두 음수 (-7.68%, -18.27%)
Win 2~3 (IS:~2011): sell=0.03 → OOS 혼재 (+118.82%, -21.29%)
Win 4~10 (IS:~2026): sell=0.05 → OOS 대체로 양수 (92.81%, -14.84%, 15.79%, 58.62%, ...)
```

초기 윈도우(0-1)에서 sell=0.01이 선택된 구간의 OOS 성과가 모두 음수인 것은, **타이트한 청산이 3x 레버리지의 정상 변동에서 빈번한 휩소를 유발**했기 때문입니다. sell=0.03도 결과가 불안정합니다.

따라서 **sell_fixed=0.03이나 0.01로 전체 기간을 고정하면 Fully Fixed보다도 나빠질 가능성**이 높습니다. 현재 Fully Fixed가 이미 sell=0.01(첫 IS 최적)으로 운용하여 Stitched CAGR 6.97%라는 참담한 결과를 보여주고 있으므로, 추가 실험의 기대 가치가 낮습니다.

**대신 제안**: ATR 트레일링 스탑을 Sell Fixed(0.05) 모드에 추가하여, "sell=0.05의 MDD 열위(-70%)를 ATR 스탑으로 보완"하는 실험이 더 생산적입니다 (§5에서 상세 설계).

---

#### 3. WFE 지표 개선 — 코드레벨 설계

##### 3.1 현재 문제 진단

코드 확인 (`walkforward.py:282-286`):

```python
# 현재 구현
if abs(is_calmar) > EPSILON:
    wfe_calmar = oos_calmar / is_calmar
else:
    wfe_calmar = 0.0
```

Window 2의 실제 값: `is_calmar = -0.0017`, `oos_calmar = 3.162` → `wfe = 3.162 / -0.0017 = -1835.42`. EPSILON(`1e-10`)보다 크므로 나눗셈이 실행되어 폭주합니다.

##### 3.2 개선 제안: 3가지 보강 지표

`calculate_wfo_mode_summary()`에 다음 3개 지표를 추가합니다:

**(1) `wfe_cagr`: CAGR 기반 WFE**

```python
# 제안 로직 (window 단위)
if abs(is_cagr) > 0.01:  # 1% 미만이면 의미 없음
    wfe_cagr = oos_cagr / is_cagr
else:
    wfe_cagr = None  # 해당 윈도우 제외
```

Pardo(2008)의 원래 WFE 정의에 가장 가까운 형태입니다. IS CAGR이 1% 미만인 윈도우는 "학습이 의미 없는 구간"이므로 제외합니다.

**(2) `gap_calmar_median`: IS-OOS Calmar 차이의 중앙값**

```python
gaps = [wr["oos_calmar"] - wr["is_calmar"] for wr in window_results]
gap_calmar_median = median(gaps)
```

비율 대신 **차이**를 사용하여 분모 폭주 문제를 원천 차단합니다. 음수이면 "IS에서 잘 했지만 OOS에서 못 함(과최적화)", 양수이면 "OOS가 IS보다 나음(과소최적화 또는 행운)"을 의미합니다.

**(3) `wfe_calmar_robust`: IS Calmar 하한 클리핑**

```python
# IS Calmar가 0.05 미만이면 제외 후 중앙값
valid_wfes = [wfe for wfe, is_c in zip(wfe_calmars, is_calmars) if is_c >= 0.05]
wfe_calmar_robust = median(valid_wfes) if valid_wfes else None
```

기존 `wfe_calmar`를 유지하되, IS Calmar가 비정상적으로 작은 윈도우를 제거한 robust 버전을 추가합니다.

##### 3.3 WfoModeSummaryDict 확장

```python
# types.py에 추가할 필드
class WfoModeSummaryDict(TypedDict):
    # ... 기존 필드 유지 ...
    wfe_cagr_median: NotRequired[float | None]
    gap_calmar_median: NotRequired[float]
    wfe_calmar_robust: NotRequired[float | None]
    profit_concentration_max_share: NotRequired[float]
    profit_concentration_window_idx: NotRequired[int]
    profit_concentration_warning: NotRequired[bool]
```

---

#### 4. Profit Concentration 지표 설계

##### 4.1 정의 및 기준

TradeStation의 Pardo 휴리스틱: **"특정 기간이 전체 순이익의 50% 이상을 차지하면 WFA 무효화"**

##### 4.2 계산 방법

Stitched equity에서 각 OOS 윈도우의 시작/종료 equity를 추출하여 구간별 수익을 계산합니다:

```python
def calculate_profit_concentration(
    equity_df: pd.DataFrame,
    window_results: list[WfoWindowResultDict],
) -> tuple[float, int, bool]:
    """OOS 윈도우별 수익 집중도를 계산한다.

    Returns:
        (max_share, window_idx, warning)
        - max_share: 최대 기여 윈도우의 수익 비율 (0~1)
        - window_idx: 해당 윈도우 인덱스
        - warning: max_share > 0.5이면 True
    """
    window_profits = []
    for wr in window_results:
        oos_start = date.fromisoformat(wr["oos_start"])
        oos_end = date.fromisoformat(wr["oos_end"])
        mask = (equity_df[COL_DATE] >= oos_start) & (equity_df[COL_DATE] <= oos_end)
        window_eq = equity_df[mask]
        if len(window_eq) < 2:
            window_profits.append(0.0)
            continue
        start_eq = float(window_eq.iloc[0]["equity"])
        end_eq = float(window_eq.iloc[-1]["equity"])
        window_profits.append(end_eq - start_eq)

    total_profit = sum(p for p in window_profits if p > 0)
    if total_profit <= 0:
        return 0.0, 0, False

    shares = [max(0, p) / total_profit for p in window_profits]
    max_idx = shares.index(max(shares))
    max_share = shares[max_idx]
    return max_share, max_idx, max_share > 0.5
```

##### 4.3 현재 TQQQ 추정값

GPT-5.2의 분석(Session 10 §4)에서 TQQQ Dynamic의 최대 기여 구간이 전체 순이익의 약 67%를 차지한다고 추정했습니다. 이는 TradeStation 50% 기준을 초과하므로 **경고 플래그**에 해당합니다.

이것이 "전략이 나쁘다"는 뜻이 아니라, **3배 레버리지의 본질적 특성**(강한 상승장에서 복리 폭발)이 반영된 것입니다. 그러나 이 사실을 명시적으로 기록하여, 결과 해석 시 "특정 시장 레짐에의 의존도가 높다"는 점을 인식해야 합니다.

##### 4.4 TQQQ 첫 IS 윈도우 sell_buffer=0.01 문제 — 목적함수 변형 의견

Session 9 §Q4에서 **"Calmar + 최소 거래수 제약"** 목적함수 변형이 제안되었습니다.

**동의합니다.** 구체적 설계:

```python
def _calmar_with_trade_constraint(row: pd.Series, min_trades: int = 3) -> float:
    """최소 거래수 제약이 포함된 Calmar 점수."""
    trades = int(row["total_trades"])
    if trades < min_trades:
        return -1e10  # 최소 거래수 미달 시 최하 점수
    return _calmar(row)
```

**근거:**

- 첫 IS 윈도우(1999-2005, 6년)에서 sell=0.01이 Calmar 1위가 되는 이유: "조기 청산으로 MDD가 작아 보이지만 거래수도 매우 적음"
- 2회 이하 거래에서 MDD=0인 경우 `1e10 + CAGR`로 무조건 1위가 되는 현재 로직이 문제
- `min_trades=3` 제약을 추가하면, 최소한 통계적으로 의미 있는 거래 표본이 있는 파라미터만 선택됨
- Build Alpha/Bob Pardo의 견고성 테스트에서도 "충분한 거래수"는 핵심 기준

이 변경은 `select_best_calmar_params()` 함수의 `_calmar` 내부에 조건 하나를 추가하는 수준이므로 구현 비용이 매우 낮습니다.

---

#### 5. ATR 트레일링 스탑 — WFO 통합 아키텍처 설계

##### 5.1 설계 원칙

1. **기존 아키텍처 최소 침습**: `run_buffer_strategy()`의 매도 로직에 ATR 스탑 조건을 **OR**로 추가
2. **WFO 파이프라인 재사용**: ATR 파라미터(n, k)를 기존 그리드 서치 파라미터에 추가
3. **다중검정 리스크 최소화**: ATR 파라미터 탐색 범위를 의도적으로 좁게 설정

##### 5.2 구현 설계

```python
@dataclass
class BufferStrategyParams(BaseStrategyParams):
    # ... 기존 필드 유지 ...
    atr_period: int = 0      # 0이면 ATR 스탑 비활성
    atr_multiplier: float = 0.0  # k값

# run_buffer_strategy() 매도 로직 확장
# 기존: 하단 밴드 하향 돌파 시에만 청산
# 추가: close < highest_close_since_entry - (k * ATR(n)) 시에도 청산
```

청산 조건 의사코드:

```
기존 청산: signal_close < lower_band (하향 돌파 감지)
ATR 청산: trade_close < trailing_stop
         where trailing_stop = max_trade_close_since_entry - (k * ATR_n)

최종 청산 = 기존 청산 OR ATR 청산 (어느 것이든 먼저 충족되면 다음 시가 청산)
```

**핵심 설계 결정 — ATR을 trade_df(TQQQ)에서 계산:**

ATR은 `trade_df`(TQQQ 합성 데이터)의 가격으로 계산해야 합니다. 이유:

- 신호는 QQQ(signal_df) 기준이지만, 스탑 레벨은 실제 보유 자산(TQQQ)의 변동성에 기반해야 함
- TQQQ의 ATR은 QQQ ATR의 약 3배이므로, 자연스럽게 레버리지 효과가 반영됨
- 이렇게 하면 별도의 레버리지 보정이 불필요

##### 5.3 ATR 모드 — "Sell Fixed + ATR" vs "Dynamic + ATR"

**결론: "Sell Fixed (0.05) + ATR"을 1차 실험으로 권장합니다.**

| 기준            | Dynamic + ATR                  | Sell Fixed + ATR                         |
| --------------- | ------------------------------ | ---------------------------------------- |
| 탐색 공간       | 432 × ATR조합                  | 144 × ATR조합                            |
| 다중검정 리스크 | 높음                           | **낮음**                                 |
| MDD 개선 경로   | 복잡 (sell_buf + ATR 상호작용) | **명확** (sell=0.05 고정 + ATR만 최적화) |
| 기저 성과       | Stitched CAGR 21.68%, MDD -62% | Stitched CAGR 20.77%, MDD -70%           |
| ATR 기대 효과   | MDD -62% → -50% 목표           | **MDD -70% → -50% 목표** (개선폭 더 큼)  |

**근거:**

1. **독립 변수 분리**: sell_buffer를 고정하면, ATR 스탑의 순수 효과를 측정할 수 있음. Dynamic에서는 sell_buffer와 ATR이 동시에 변하므로 어떤 것이 MDD를 줄였는지 구분 불가
2. **Sell Fixed의 약점이 ATR의 강점과 정확히 대응**: Sell Fixed의 MDD가 -70.06%인 이유는 금융위기 바닥(2009-05-13)에서 sell=0.05가 너무 관대했기 때문. ATR 스탑이 이 구간을 정확히 겨냥
3. **계산 비용 절감**: 탐색 공간이 3배 작음

##### 5.4 ATR 파라미터 탐색 범위

웹 리서치 결과를 종합하면:

| 파라미터           | 범위            | 근거                                                                              |
| ------------------ | --------------- | --------------------------------------------------------------------------------- |
| **n (ATR Period)** | {14, 20}        | Wilder 표준(14) + 포지션 트레이딩(20). StockCharts/LuxAlgo 권장                   |
| **k (Multiplier)** | {3.0, 4.0, 5.0} | 변동성 높은 자산에 3.0-5.0 권장 (Chandelier Exit 기본값 3.0, 레버리지 ETF는 상향) |

총 6조합. **기존 Sell Fixed 144 조합 × 6 = 864 조합**으로, 현재 WFO의 432 조합보다 2배 정도. 계산 가능한 수준입니다.

**"k를 IS에서 최적화할지 고정할지"** (Session 9 §Q3):

**IS에서 최적화를 권장합니다.** 이유:

1. 6조합(2×3)은 다중검정 리스크가 매우 낮음
2. ATR multiplier는 시장 레짐(변동성 구조)에 따라 최적값이 달라질 수 있음
3. 고정 시, 어떤 값을 고정할지에 대한 근거가 부족 (첫 번째 IS에서 결정하면 다시 같은 문제)

##### 5.5 ATR 스탑 + WFO 3-Mode 비교

기존 3-Mode 패턴을 ATR 포함 버전으로 확장:

| 모드                           | 설명                                 | 진단 목적                |
| ------------------------------ | ------------------------------------ | ------------------------ |
| **Sell Fixed + ATR Dynamic**   | sell=0.05 고정, ATR(n,k)는 IS 최적화 | ATR 스탑의 MDD 개선 효과 |
| **Sell Fixed + ATR Fixed**     | sell=0.05, n=14, k=3.0 고정          | ATR 파라미터 안정성 확인 |
| **기존 Sell Fixed (ATR 없음)** | 대조군 (현재 결과 재사용)            | ATR의 순수 효과 비교     |

성공 기준: **Sell Fixed + ATR의 Stitched MDD ≤ -50% AND Calmar ≥ 0.35**

---

#### 6. 2020-03-12 MDD -62.09% 해부 — "왜 이 구간에서 못 피했는가"

##### 6.1 Equity 시계열 추적 (코드 확인)

`walkforward_equity_dynamic.csv`에서 2020년 1월~3월 구간:

| 날짜           | Equity      | Position      | 상태                             |
| -------------- | ----------- | ------------- | -------------------------------- |
| 2020-01-17     | 106.89M     | 8,947,043     | **전고점**                       |
| 2020-02-19     | **126.32M** | 8,947,043     | **절대 최고점**                  |
| 2020-02-21     | 115.71M     | 8,947,043     | 하락 시작 (-8.4%)                |
| 2020-02-24     | 102.37M     | 8,947,043     | **1일 -11.5% 급락**              |
| 2020-02-27     | 81.12M      | 8,947,043     | -35.8% (3일간)                   |
| 2020-03-09     | 65.51M      | 8,947,043     | -48.1%                           |
| **2020-03-12** | **47.89M**  | **8,947,043** | **-62.09% (MDD 최저점)**         |
| 2020-03-13     | 55.73M      | **0**         | **청산 완료**                    |
| 2020-03-16     | 55.73M      | 0             | buy_buffer 0.01→0.02 (동적 조정) |

##### 6.2 왜 못 피했는가

1. **2020-02-19 ~ 2020-03-12 (15 영업일 동안 -62%)**:
   - 이 시점의 파라미터: MA=200, buy_buffer=0.01, sell_buffer=0.05
   - QQQ 200일 EMA는 ~183~186 수준, lower_band = EMA × 0.95 ≈ 175~177
   - QQQ 종가는 2020-02-19에 ~216에서 2020-03-12에 ~248 수준... 아닙니다. 실제로 QQQ는 2020-02-19에 약 220에서 2020-03-23에 약 167까지 하락했습니다.

2. **핵심 문제 — 하단 밴드(lower_band)가 너무 낮았음**:
   - CSV에서 확인: 2020-03-12 시점 `lower_band = 184.87`
   - 이때 QQQ 종가는 이미 이 lower_band 아래로 내려가야 매도 신호가 발생
   - QQQ가 220 → 184 아래로 내려오는 동안 (-16% 이상), TQQQ는 이미 -48% ~ -62%를 경험
   - **3배 레버리지 특성**: QQQ -16%가 TQQQ에서는 대략 -40~50%로 증폭

3. **ATR 스탑이 이 구간을 어떻게 방어할 수 있는가**:
   - 2020-02-19 TQQQ 최고점 기준, ATR(14) × 3.0의 trailing stop이 있었다면:
   - TQQQ의 14일 ATR은 이 시점에서 약 0.5~1.0 수준 (합성 가격 기준)
   - 스탑 레벨: highest_close - 3.0 × ATR ≈ 최고점에서 약 -15~20%
   - 즉, **2020-02-27 전후에 스탑이 발동**하여, -35% 수준에서 청산이 가능했을 것
   - 실제 청산 시점(-62%) 대비 약 **27%p의 손실 방어** 효과

##### 6.3 구조적 결론

2020-03 MDD의 근본 원인은 Session 3에서 진단한 것과 동일합니다: **"하단 밴드 기반 청산만으로는 급락 구간에서 늦게 판다"**. sell_buffer=0.05(MA 아래 5%)는 정상 조정을 버티기에 적절하지만, 코로나 급락 같은 **극단적 급락**(QQQ 15 영업일간 -35%)에서는 TQQQ가 이미 -62%를 경험한 후에야 발동됩니다.

ATR 트레일링 스탑은 이 문제를 직접 해결합니다: 보유 자산(TQQQ)의 최근 변동성에 기반한 동적 스탑이므로, 급락 구간에서 하단 밴드보다 먼저 발동합니다.

---

#### 7. 우선순위 최종 재조정

**Session 9 대비 변경점**: WFE/Profit Concentration 지표 보강(1순위)을 ATR 스탑 구현 전에 선행. ATR 스탑은 Sell Fixed + ATR 조합으로 구체화. 목적함수에 min_trades 제약 추가.

| 순위  | 방법                                     | 근거                                              | 상태                 |
| ----- | ---------------------------------------- | ------------------------------------------------- | -------------------- |
| **1** | **WFO 구현**                             | 3-Mode 비교 완료                                  | **Done**             |
| **2** | **WFE/Profit Concentration 지표 보강**   | 현재 WFE Calmar 폭주 문제 해결 + 수익 집중도 진단 | 다음 진행            |
| **3** | **목적함수 변형 (min_trades 제약)**      | 첫 IS 윈도우 sell=0.01 문제 해결                  | 다음 진행            |
| **4** | **ATR 트레일링 스탑 (Sell Fixed + ATR)** | TQQQ MDD -70% → -50% 목표                         | 설계 완료, 구현 대기 |
| **5** | **PBO 분석 (TQQQ)**                      | TQQQ 과최적화 정량 검증                           | 대기                 |
| **6** | **TQQQ 초기 IS 기간 확장 (72→96개월)**   | min_trades 제약으로 우선 해결 시도 후 필요시      | 대기                 |

---

#### 8. 최신 결론 (TL;DR) 업데이트 제안

기존 상단 TL;DR을 아래로 교체할 것을 제안합니다:

```
## 최신 결론 (TL;DR) — 2026-02-22 기준

- **QQQ 전략**: WFO 검증 통과. Fully Fixed(MA=200, buy=0.01, sell=0.05, hold=2, recent=8)가 Dynamic보다 우수 → **파라미터 고정 운용 가능**. 학술적으로도 bias-variance tradeoff에서 단순 모델 우위 실증.
- **TQQQ 전략**: Dynamic WFO Stitched CAGR 21.68%, MDD **-62.09%** (기존 단일 백테스트 MDD -88% → 26%p 개선). **목표 MDD -50% 미달 → ATR 스탑이 핵심 과제**
- **공통 발견**: sell_buffer=0.05가 두 전략 모두에서 가장 안정적. Profit Concentration 경고: TQQQ 최대 기여 구간이 수익의 ~67% 차지
- **다음 실험**: WFE/Profit Concentration 지표 보강 → ATR 트레일링 스탑(Sell Fixed + ATR) → WFO 파이프라인에서 검증 (TQQQ MDD -70% → -50% 목표)
- **열린 질문**: ATR 파라미터(n={14,20}, k={3,4,5})를 IS에서 최적화 / 목적함수에 min_trades 제약 추가 / WFE를 CAGR 기반으로 교체
```

#### 9. 목차 업데이트 제안

기존 목차에 아래 항목 추가:

```
17. [Session 11 — WFE/Profit Concentration 보강 + ATR 스탑 설계 + 2020-03 MDD 해부](#claude-opus-46--2026-02-22-1730-kst)
```

참고 자료:

- DeMiguel, Garlappi & Uppal (2009). "Optimal Versus Naive Diversification." Review of Financial Studies. https://scientificportfolio.com/external-research-anthology/victor-demiguel-lorenzo-garlappi-raman-uppal-2009/optimal-versus-naive-diversification-how-inefficient-is-the-1-n-portfolio-strategy/
- Kelly, Malamud, Zhou (2024). "The Virtue of Complexity in Return Prediction." Journal of Finance. https://onlinelibrary.wiley.com/doi/abs/10.1111/jofi.13298
- Hsu & Kuan (2005). "Re-Examining the Profitability of Technical Analysis." SSRN. https://papers.ssrn.com/sol3/papers.cfm?abstract_id=685361
- Pardo, R.E. (2008). "The Evaluation and Optimization of Trading Strategies." Wiley.
- TradeStation WFO — OOS Summary (Profit Concentration 50% rule). https://help.tradestation.com/09_01/tswfo/topics/walk-forward_summary_out-of-sample.htm
- StockCharts — Chandelier Exit. https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit
- LuxAlgo — 5 ATR Stop Loss Strategies. https://www.luxalgo.com/blog/5-atr-stop-loss-strategies-for-risk-control/
- Build Alpha — Robustness Testing Guide. https://www.buildalpha.com/robustness-testing-guide/
- Zorro Manual — Objective Functions for WFO. https://manual.zorro-project.com/objective.htm
- arXiv (2504.20116) — Compounding Effects in Leveraged ETFs. https://arxiv.org/abs/2504.20116

다음 모델에게:

1. **WFE/Profit Concentration 보강 구현**: 본 세션 §3-§4의 설계를 `walkforward.py`와 `types.py`에 구현해 주세요. `calculate_wfo_mode_summary()`에 3개 WFE 지표 + profit concentration 필드를 추가하고, `walkforward_summary.json`에 반영하세요. 기존 테스트(`test_backtest_walkforward.py`)에 새 필드 검증 테스트를 추가해 주세요.
2. **목적함수 min_trades 제약 구현**: `select_best_calmar_params()`에 `min_trades=3` 파라미터를 추가하고, 해당 제약이 TQQQ 첫 IS 윈도우의 파라미터 선택을 어떻게 바꾸는지 확인해 주세요. WFO를 재실행하여 Stitched MDD 변화를 비교해 주세요.
3. **ATR 트레일링 스탑 Phase 1 구현**: 본 세션 §5의 설계대로 `BufferStrategyParams`에 `atr_period`, `atr_multiplier`를 추가하고, `run_buffer_strategy()`에 ATR 스탑 로직을 삽입해 주세요. 기존 동작(atr_period=0이면 비활성)과의 하위 호환성을 반드시 유지해야 합니다.

> **초보자 요약**: 이 세션은 "성적표를 읽고 다음 시험을 준비하는" 단계입니다. 핵심 발견 3가지:
> (1) QQQ는 "한 번 정한 규칙을 바꾸지 않는 것"이 최선 — 학술적으로도 "단순한 규칙이 복잡한 최적화를 이긴다"는 연구 결과와 일치
> (2) TQQQ의 2020년 3월 코로나 급락(-62%)은 "자동 브레이크(ATR 스탑)가 없어서" 발생 — 최고점에서 -15~20%에서 자동으로 팔았다면 -35% 수준에서 손실을 막을 수 있었음
> (3) TQQQ 수익의 67%가 한 구간(2023-2025)에 집중 — 마치 시험 성적이 한 과목에만 의존하는 것처럼, 특정 시장 상황에 크게 의존하는 리스크가 있음
> **ATR 트레일링 스탑**: 보유 중 자산 가격이 최고점에서 "최근 변동폭 × 배수"만큼 떨어지면 자동으로 파는 안전장치. 시장이 출렁일 때는 넓게, 잔잔할 때는 좁게 자동 조절됩니다.
> **Profit Concentration**: 전체 수익이 한 기간에 집중되는 정도. 50% 이상이면 "이 전략은 특정 시장 상황에서만 잘 작동할 수 있다"는 경고입니다.
> **min_trades 제약**: "최소 3번은 거래해야 그 파라미터를 믿을 수 있다"는 규칙. 거래가 1~2번뿐인데 성적이 좋은 것은 운일 수 있기 때문입니다.

---

### 19. Session 13 [GPT-5.2 Thinking] — 2026-02-22 18:10 (KST)

주제: **WFO 결과(3-Mode) 재검증 + Profit Concentration/WFE 지표 “정의 정확화” + ATR 스탑(Chandelier 스타일) Phase 1 설계 보강**

아래는 방금 공유된 Claude Opus 4.6의 Session(2026-02-22 17:30) 내용을 **프로젝트 산출물(각 mode의 `walkforward_*.csv`, `walkforward_equity_*.csv`, `walkforward_summary.json`)로 재검증**하고, 다음 단계(지표 보강 + ATR 스탑 WFO 통합)를 “정의/계산 방식까지” 더 단단하게 만드는 제안입니다.

---

## 1) Profit Concentration(수익 집중) — 수치 재검증 + 계산 방식(중요)

TradeStation의 WFO 가이드는 “특정 기간(또는 큰 승리/승리 구간)이 **전체 순이익(total net profit)의 50%를 초과**하면 WFA가 invalidate될 수 있다”는 휴리스틱을 명시합니다. ([TradeStation 도움말][1])
→ 따라서 이 프로젝트의 `profit_concentration`은 **분모를 ‘총 순이익(final_equity - initial_equity)’로 두는 정의가 가장 정합적**입니다.

### 1.1 재검증 결과(정확 수치)

Stitched equity 기준(각 OOS 윈도우의 “일별 equity 변화(Δequity)”를 해당 윈도우에 귀속하여 합산):

- **TQQQ Dynamic**: 최대 기여 윈도우 **2023-03-01~2025-02-28**이 **총 순이익의 0.673309(67.33%)**
- **TQQQ Sell Fixed**: 동일 구간이 **0.675226(67.52%)**
- **TQQQ Fully Fixed**: 최대 기여 구간이 **0.531713(53.17%)** _(이것도 50% 초과)_
- **QQQ Fully Fixed**: 최대 기여 구간이 **0.476001(47.60%)** _(50% 미만)_

즉, Claude가 말한 “TQQQ는 수익 집중 경고등(>50%)”은 **정량적으로 맞고**, 심지어 **TQQQ Fully Fixed도 50%를 넘습니다.**

### 1.2 구현/스펙 관점에서 “계산 실수”를 막는 공식(권장)

윈도우 수익을 `end_equity - start_equity`로 계산하면, **윈도우 첫 거래일의 수익(전일→당일)이 누락**되어 합이 안 맞는 함정이 있습니다(실제로 이 함정 때문에 합이 total net profit과 어긋나기 쉬움).
그래서 아래처럼 “일별 변화량을 윈도우에 귀속”시키는 방식이 안전합니다.

- `Δequity[t] = equity[t] - equity[t-1]`
- 윈도우 수익 = `sum_{t in window_dates} Δequity[t]`
- `profit_concentration_max_share = max( max(0, window_profit) / total_net_profit )`
- `warning = (profit_concentration_max_share > 0.5)` (TradeStation 휴리스틱 그대로) ([TradeStation 도움말][1])

---

## 2) WFE(Walk-Forward Efficiency) — “현재 구현(wfe_calmar)”을 보조지표로 내리고, TradeStation 정의에 맞춘 지표를 1급으로

TradeStation 문서에서 WFE는 **IS와 OOS의 ‘연환산 수익률(annualized rates of return)’을 비교한 통계**라고 설명합니다. ([TradeStation 도움말][1])
→ 즉, 프로젝트에서 가장 자연스러운 1급 WFE는 **CAGR 기반**입니다.

### 2.1 현재 `wfe_calmar`의 문제는 “정상 동작인데도 해석이 붕괴”

- `wfe_calmar = oos_calmar / is_calmar`는, **분모(is_calmar)가 0 근처/음수**면 폭주하거나 부호 반전이 발생합니다.
- 실제 TQQQ Dynamic에 `is_calmar=-0.0017`이 존재해 `wfe_calmar` 평균이 -161처럼 망가지는 현상이 재현됩니다(이건 계산 버그가 아니라 “지표 정의의 취약성” 문제).

### 2.2 권장: summary에 아래 2개를 “기본”으로 추가

1. `wfe_cagr` (window별): `oos_cagr / is_cagr`
2. `gap_calmar_median`: `median(oos_calmar - is_calmar)` (폭주 방지용)

그리고 `wfe_calmar`는 “레거시/참고값”으로 유지하되,

- `is_calmar >= 0.05` 같은 하한을 두고 median만 집계하는 `wfe_calmar_robust`를 보조로 두는 방향이 가장 깔끔합니다.

---

## 3) “QQQ는 Simple is Better” — 근거 강화(출처 퀄리티 업그레이드)

Claude가 든 논지는 방향이 타당하고, 특히 “추정오차(variance) 때문에 복잡/최적화가 OOS에서 불리해질 수 있다”는 고전 논거는 DeMiguel et al.(2009) 쪽이 대표 레퍼런스입니다. ([OUP Academic][2])
또한 “25자산 포트폴리오에서 1/N을 이기기 위해 필요한 추정 윈도우가 3000개월(250년) 수준”이라는 정량 문장도 동일 계열 문헌에서 확인됩니다. ([jstor.org][3])

다만, 이 프로젝트는 “자산배분 최적화”가 아니라 “룰 기반 트레이딩 파라미터 튜닝”이라 1:1 대응은 아니고, **bias–variance tradeoff의 직관적 근거로만** 두는 게 가장 안전합니다.

---

## 4) 2020-03 MDD(-62.09%)는 “하단 밴드 청산의 구조적 지연”이 맞고, ATR 스탑은 실제로 ‘트리거 타이밍’이 빠르다

WFO stitched(TQQQ Dynamic)에서 최악 MDD가 **2020-03-12**에 발생하고, 그날에도 **포지션이 유지**된 것이 데이터로 확인됩니다(다음날 2020-03-13에 청산).
그리고 같은 날 `lower_band ≈ 184.87`(QQQ 기준)이어서, **QQQ가 -16%대 이상 내려와야 청산 신호**가 뜨는 구조(→ TQQQ는 이미 -40~-60%대 손실 구간)가 명확합니다.

### 4.1 “ATR(14), multiplier k”의 백오브엔벨로프(단위/수치 일치 확인)

Chandelier Exit(ATR 기반 트레일링 스탑)의 전형적 형태는 “최고점(High/Close) - k×ATR” 구조입니다. ([차트스쿨][4])
TQQQ 합성 가격 기준으로 2020-02-19 전후 ATR(14)은 약 0.44~0.59 수준(가격 단위)이고, 최고 종가가 14.118 부근이므로:

- k=3이면 2020-02-24 종가(≈11.44)가 `highest_close - 3×ATR` 아래로 내려가 **이미 트리거 가능**(다음 시가 청산이면 -62%까지 끌고 가지 않을 여지가 큼)
- k=5면 2020-02-27 즈음에 트리거 쪽으로 이동(더 완만하지만 여전히 하단밴드보다 빠름)

→ 결론: **ATR 스탑을 붙이는 것이 “2020류 급락”을 직접 겨냥하는 최단 경로**라는 세션 결론은 매우 설득력 있습니다.

---

## 5) 다음 실험(Phase 1) 제안: “Sell Fixed(0.05) + ATR”을 1차로, 단 탐색폭은 작게

TradeStation 휴리스틱이 “한 기간이 순이익의 50%+면 invalidate 경고”를 주는 상황에서(현재 TQQQ가 67%), 탐색공간을 크게 늘리는 건 부담입니다. ([TradeStation 도움말][1])
따라서 Claude 제안대로 1차는 **Sell Fixed(0.05) + ATR**이 합리적입니다:

- 파라미터 상호작용( sell_buffer × ATR )을 분리해 “ATR의 순수 효과”를 측정
- 탐색공간이 Dynamic+ATR 대비 작아 다중검정 부담이 낮음

### 5.1 ATR 파라미터 후보(최소 폭)

Chandelier Exit 문헌/실무에서 multiplier 기본값이 3으로 자주 소개되며, 기간은 14가 표준으로 많이 쓰입니다. ([차트스쿨][4])
레버리지(TQQQ)의 변동성 증폭을 감안하면 k는 3만으론 타이트할 수 있어, **{3,4,5}** 정도가 1차 후보로 적절합니다.

- `atr_period ∈ {14, 20}`
- `atr_multiplier ∈ {3, 4, 5}`
  → 6조합 (작고 명확)

### 5.2 성공 기준(제안)

- TQQQ stitched MDD ≤ **-50%**
- stitched Calmar ≥ **0.35** (현재 Dynamic이 0.349로 거의 근접)

---

참고 자료:

- TradeStation WFO OOS Summary (WFE rule-of-thumb + “50% net profit concentration” 경고): [https://help.tradestation.com/10_00/eng/tswfo/topics/walk-forward_summary_out-of-sample.htm](https://help.tradestation.com/10_00/eng/tswfo/topics/walk-forward_summary_out-of-sample.htm) ([TradeStation 도움말][1])
- Walk-forward optimization “gold standard” 설명: [https://en.wikipedia.org/wiki/Walk_forward_optimization](https://en.wikipedia.org/wiki/Walk_forward_optimization) ([위키피디아][5])
- Chandelier Exit(ATR 트레일링 스탑): [https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit](https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit) ([차트스쿨][4])
- DeMiguel et al.(2009) 1/N vs 최적화(추정오차): [https://academic.oup.com/rfs/article-abstract/22/5/1915/1592901](https://academic.oup.com/rfs/article-abstract/22/5/1915/1592901) ([OUP Academic][2])
- (정량 문장 포함 스니펫) 3000개월 언급: [https://www.jstor.org/stable/30226017](https://www.jstor.org/stable/30226017) ([jstor.org][3])

다음 모델에게:

1. **Profit Concentration 구현 시 “일별 Δequity 합산 방식”으로 스펙을 고정**해 주세요(윈도우 경계 첫날 수익 누락 버그 방지). 그리고 TradeStation 정의대로 분모는 `total net profit`로 두는 게 정합적입니다. ([TradeStation 도움말][1])
2. **WFE는 `wfe_cagr`를 1급 지표로 추가**하고, 기존 `wfe_calmar`는 참고/보조(robust median 포함)로 내리는 방향이 좋습니다. TradeStation이 WFE를 “연환산 수익률 비교”로 설명합니다. ([TradeStation 도움말][1])
3. **ATR Phase 1은 Sell Fixed(0.05)+ATR로 먼저** 가고, (14/20)×(3/4/5)만 탐색한 뒤 stitched MDD가 -50을 넘는지 확인해 주세요. Chandelier Exit 정의/기본값 근거는 StockCharts 문서가 깔끔합니다. ([차트스쿨][4])

[1]: https://help.tradestation.com/10_00/eng/tswfo/topics/walk-forward_summary_out-of-sample.htm "https://help.tradestation.com/10_00/eng/tswfo/topics/walk-forward_summary_out-of-sample.htm"
[2]: https://academic.oup.com/rfs/article-abstract/22/5/1915/1592901 "https://academic.oup.com/rfs/article-abstract/22/5/1915/1592901"
[3]: https://www.jstor.org/stable/30226017 "https://www.jstor.org/stable/30226017"
[4]: https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit "https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit"
[5]: https://en.wikipedia.org/wiki/Walk_forward_optimization "https://en.wikipedia.org/wiki/Walk_forward_optimization"

---

### 20. Session 14 [Claude Opus 4.6] — 2026-02-22 21:40 (KST)

주제: **Profit Concentration/WFE 수치 재검증 + ATR 스탑 시그널 소스 설계 수정(Critical) + Chandelier Exit 파라미터 보정 + 구현 스펙 확정**

#### 0. 이전 세션 질문 대응 범위

이 세션은 GPT-5.2 Session 12(2026-02-22 18:10)의 3개 질문을 대응합니다.

| 출처               | 질문                                                    | 본 세션 대응 절 |
| ------------------ | ------------------------------------------------------- | --------------- |
| Session 12 GPT §Q1 | Profit Concentration "일별 Δequity 합산 방식" 스펙 고정 | §1              |
| Session 12 GPT §Q2 | WFE는 wfe_cagr를 1급, wfe_calmar를 보조로               | §2              |
| Session 12 GPT §Q3 | ATR Phase 1은 Sell Fixed+ATR, (14/20)×(3/4/5)           | §3, §4          |

---

#### 1. Profit Concentration — 수치 재검증 + 구현 방식 확정

##### 1.1 GPT 수치 검증: 정확함

Stitched equity CSV 파일에서 OOS 윈도우별 수익을 직접 계산하여 검증했습니다.

| 모드             | GPT 주장 | 실측값     | 일치 여부 | 최대 기여 윈도우       |
| ---------------- | -------- | ---------- | --------- | ---------------------- |
| TQQQ Dynamic     | 67.33%   | **67.33%** | 정확 일치 | W9 (2023-03 ~ 2025-02) |
| TQQQ Sell Fixed  | 67.52%   | **67.52%** | 정확 일치 | W9 (2023-03 ~ 2025-02) |
| TQQQ Fully Fixed | 53.17%   | **53.17%** | 정확 일치 | W7 (2019-03 ~ 2021-02) |
| QQQ Fully Fixed  | 47.60%   | **47.60%** | 정확 일치 | W9 (2023-03 ~ 2025-02) |

추가 발견: **QQQ의 모든 모드가 50% 미만** (Dynamic 43.88%, Sell Fixed 44.51%, Fully Fixed 47.60%). QQQ는 TradeStation 휴리스틱을 통과하지만, **TQQQ는 3개 모드 모두 50%를 초과**합니다.

##### 1.2 구현 방식 — "end - prev_end" vs "일별 Δequity 합산"

GPT가 제안한 "일별 Δequity 합산"이 이론적으로 가장 안전합니다. 그러나 실제 데이터 검증에서 **더 단순한 방식도 동일한 결과**를 줍니다:

**V2 방식 (end - prev_end)**: `window_profit[i] = equity_end[i] - equity_end[i-1]`

- 모든 윈도우 수익의 합 = total net profit **정확히 일치** (Dynamic: 601,812,009)
- 윈도우 경계에서 파라미터 변경으로 인한 equity 변화도 자연스럽게 다음 윈도우에 귀속

**V1 방식 (window 내 end - start)**: `window_profit[i] = equity_end_in_window[i] - equity_start_in_window[i]`

- 합계가 total net profit과 **불일치** (Dynamic: 626,957,510 vs 601,812,009 — 25M 차이)
- 윈도우 경계 점프가 누락됨

**결론**: V2 방식(end - prev_end)이 구현 단순성과 정확성 모두에서 우수합니다. 일별 Δequity 합산은 V2와 동치이므로, **구현은 V2 방식으로 확정**합니다.

```python
def calculate_profit_concentration(
    equity_df: pd.DataFrame,
    window_results: list[WfoWindowResultDict],
    initial_capital: float,
) -> tuple[float, int, bool]:
    """OOS 윈도우별 수익 집중도를 계산한다.

    V2 방식: window_profit = equity_end - prev_window_equity_end
    이 방식은 모든 윈도우 수익의 합이 total net profit과 정확히 일치한다.
    """
    window_profits: list[float] = []
    prev_end_equity = initial_capital

    for wr in window_results:
        oos_end = date.fromisoformat(wr["oos_end"])
        mask = equity_df[COL_DATE] <= oos_end
        window_eq = equity_df[mask]
        if len(window_eq) == 0:
            window_profits.append(0.0)
            continue
        end_eq = float(window_eq.iloc[-1]["equity"])
        window_profits.append(end_eq - prev_end_equity)
        prev_end_equity = end_eq

    total_profit = sum(p for p in window_profits if p > 0)
    if total_profit <= 0:
        return 0.0, 0, False

    shares = [max(0, p) / total_profit for p in window_profits]
    max_idx = int(pd.Series(shares).idxmax())
    return shares[max_idx], max_idx, shares[max_idx] > 0.5
```

##### 1.3 TQQQ Profit Concentration 상세 분해

| 윈도우 | OOS 기간            | 수익        | 기여도     |
| ------ | ------------------- | ----------- | ---------- |
| W0     | 2005-03 ~ 2007-02   | -1,474,841  | -0.25%     |
| W1     | 2007-03 ~ 2009-02   | -3,575,298  | -0.59%     |
| W2     | 2009-03 ~ 2011-02   | +12,035,605 | 2.00%      |
| W3     | 2011-03 ~ 2013-02   | -8,592,404  | -1.43%     |
| W4     | 2013-03 ~ 2015-02   | +24,944,884 | 4.14%      |
| W5     | 2015-03 ~ 2017-02   | +965,791    | 0.16%      |
| W6     | 2017-03 ~ 2019-02   | +20,268,099 | 3.37%      |
| W7     | 2019-03 ~ 2021-02   | +97,510,098 | 16.20%     |
| W8     | 2021-03 ~ 2023-02   | +10,559,063 | 1.75%      |
| **W9** | **2023-03~2025-02** | **+405.2M** | **67.33%** |
| W10    | 2025-03 ~ 2026-02   | +43,965,575 | 7.31%      |

**핵심 관찰**: W9 + W7 = 83.53%. 11개 윈도우 중 2개가 수익의 84%를 차지. 4개 윈도우(W0, W1, W3, W5)는 손실 또는 무의미한 수준. 이는 3x 레버리지의 복리 폭발이 강세장에 집중되는 구조적 특성을 정확히 반영합니다.

---

#### 2. WFE 지표 — 합의 확인 + 구현 스펙 확정

##### 2.1 TradeStation 원문 재확인 (웹 리서치)

TradeStation WFO 문서(v10.00/v9.01)의 원문:

> "calculates and compares **annualized rates of return** for the in-sample and out-of-sample results."
> "a Walk-Forward Efficiency of **50% or more** is considered a measure of a successful walk-forward analysis."

**핵심 발견**: TradeStation이 사용하는 WFE는 명시적으로 **"연환산 수익률(annualized rates of return)"** 비교입니다. Calmar 기반이 아닙니다. 따라서 GPT의 `wfe_cagr` 1급 지표 제안은 TradeStation의 공식 정의와 정확히 일치합니다.

##### 2.2 Pardo의 원래 정의 (문헌 조사)

Pardo(2008) "The Evaluation and Optimization of Trading Strategies"의 원래 WFE 정의는 **연환산 수익률 비율**입니다. IS와 OOS의 기간이 다르므로 연환산이 필수적입니다 (ProRealTime 구현 문서에서도 명시). 순이익(net profit) 비율은 동일 기간에서만 유효한 단순화 버전입니다.

**CAGR vs 단순 연환산**: 문헌에서 구분이 명확하지 않지만, 단기(2년 OOS)에서는 차이가 미미합니다. 본 프로젝트에서는 이미 CAGR을 표준으로 사용하므로, `wfe_cagr = oos_cagr / is_cagr`로 확정합니다.

##### 2.3 AmiBroker 참고: CAR/MDD는 최적화 목적함수이지 WFE가 아님

AmiBroker는 CAR/MDD(= Calmar)를 Walk-Forward **최적화 목적함수**로 사용합니다. 이는 "어떤 파라미터를 선택할지"의 기준이지, WFE(IS-OOS 효율성 비교)와는 다른 개념입니다. 본 프로젝트에서도 Calmar는 목적함수로 유지하고, WFE는 CAGR 비율로 분리합니다.

##### 2.4 Zorro 프로젝트의 WFE 비판 (주목할 만한 발견)

Zorro 프로젝트의 chief engineer(jcl)는 경험적 테스트에서 **WFE가 전략 견고성과 상관관계가 낮다**고 보고했습니다:

> "Robust strategies sometimes had low WFE values while unstable strategies produced high WFE readings."

이는 WFE를 단독 의사결정 지표로 사용하면 안 된다는 점을 확인합니다. `gap_calmar_median` (IS-OOS 차이)과 `profit_concentration`을 **함께** 봐야 의미 있는 진단이 가능합니다.

##### 2.5 최종 WFE 스펙 (3개 세션 합의 정리)

| 지표                   | 분류     | 정의                                           | 폭주 대응                  |
| ---------------------- | -------- | ---------------------------------------------- | -------------------------- |
| `wfe_cagr`             | **1급**  | `oos_cagr / is_cagr` (is_cagr < 0.01이면 None) | is_cagr 하한 클리핑        |
| `gap_calmar_median`    | **1급**  | `median(oos_calmar - is_calmar)`               | 비율 대신 차이 → 원천 차단 |
| `wfe_calmar`           | 참고     | 기존 유지 (레거시 호환)                        | 기존 EPSILON 방어          |
| `wfe_calmar_robust`    | 참고     | `median(wfe_calmar where is_calmar >= 0.05)`   | is_calmar 하한 필터        |
| `profit_concentration` | **경고** | `max(window_share)`, warning if > 0.5          | N/A                        |

---

#### 3. ATR 스탑 시그널 소스 — **Critical Design Revision**

##### 3.1 이전 세션(Session 11)의 설계: "ATR을 trade_df(TQQQ)에서 계산"

Session 11에서 나(Claude)는 다음과 같이 설계했습니다:

> ATR은 `trade_df`(TQQQ 합성 데이터)의 가격으로 계산해야 합니다.
> TQQQ의 ATR은 QQQ ATR의 약 3배이므로, 자연스럽게 레버리지 효과가 반영됨.

이 설계를 **수정해야 합니다**.

##### 3.2 웹 리서치 결과: ATR은 기초자산(QQQ)에서 계산해야 함

Lambros Petrou의 TQQQ 전략 연구에서 핵심 발견:

> "Signal detection should be performed on the underlying (QQQ), not the leveraged product (TQQQ), because doing technical analysis directly on leveraged ETFs leads to **noise and false positives for both entries and exits**."

추가 근거:

1. **노이즈 증폭**: TQQQ의 일간 변동성은 QQQ의 3배. ATR(14) on TQQQ는 3배 넓은 스탑 레벨을 생성하지만, 그 넓이가 "의미 있는 추세 반전"이 아니라 "일간 레버리지 노이즈"를 반영
2. **아키텍처 일관성**: 현재 전략의 모든 시그널(매수/매도 밴드 돌파)은 QQQ(signal_df) 기준. ATR 스탑만 TQQQ(trade_df)에서 계산하면 시그널 소스가 혼재
3. **Chandelier Exit의 원래 의도**: "최고점에서 변동성의 배수만큼 떨어지면 추세 반전"을 감지하는 것. 기초자산의 변동성이 더 깨끗한 추세 반전 신호를 제공

##### 3.3 수정된 ATR 스탑 설계

```
# 기존 설계 (Session 11) — 폐기
stop_price = highest_close_TQQQ - k * ATR(TQQQ, n)
trigger: trade_close < stop_price

# 수정 설계 — 채택
stop_price = highest_close_QQQ_since_entry - k * ATR(QQQ, n)
trigger: signal_close < stop_price → 다음 시가에 TQQQ 청산
```

**설계 근거**:

| 기준                 | TQQQ 기반 (기존)                    | QQQ 기반 (수정)              |
| -------------------- | ----------------------------------- | ---------------------------- |
| 시그널 일관성        | 혼재 (매수/매도는 QQQ, 스탑은 TQQQ) | **통일** (모든 시그널이 QQQ) |
| 노이즈 수준          | 3x 일간 변동 → 잦은 whipsaw         | **낮음** (기초자산 기준)     |
| 구현 복잡도          | trade_df에서 별도 ATR 계산 필요     | **signal_df 내에서 완결**    |
| 체결 타이밍          | 다음 시가 TQQQ 청산 (동일)          | 다음 시가 TQQQ 청산 (동일)   |
| Chandelier 원칙 부합 | 부분적                              | **완전 부합**                |

**반론 검토**: "TQQQ의 실제 손실을 반영하지 못한다"는 우려가 있을 수 있습니다. 그러나 ATR 스탑의 목적은 "실제 손실 측정"이 아니라 "추세 반전 감지"입니다. QQQ가 추세 반전을 보이면 TQQQ의 손실은 3배로 확대되므로, QQQ 기준 스탑이 TQQQ 손실 방어에 더 빠르게 반응합니다.

##### 3.4 구현 변경 사항

```python
@dataclass
class BufferStrategyParams(BaseStrategyParams):
    # ... 기존 필드 유지 ...
    atr_period: int = 0        # 0이면 ATR 스탑 비활성
    atr_multiplier: float = 0.0  # k값

# run_buffer_strategy() 내부 변경:
# 1. signal_df에서 ATR 계산 (atr_period > 0일 때만)
# 2. 포지션 보유 중 highest_signal_close_since_entry 추적
# 3. 매도 로직에 OR 조건 추가:
#    기존: signal_close < lower_band
#    추가: signal_close < highest_signal_close_since_entry - k * ATR(signal, n)
# 4. ATR 청산도 기존 "신호일-체결일 분리" 규칙 준수 (다음 시가 체결)
```

---

#### 4. Chandelier Exit 파라미터 — 표준값 보정

##### 4.1 표준 Chandelier Exit 파라미터 (웹 리서치 확인)

StockCharts ChartSchool 원문:

> "Using the **default setting of 22-periods** on a daily chart"
> "default settings will appear in the parameters box **(22, 3.0)**"
> "Chandelier Exit (long) = **22-day High - ATR(22) × 3**"

**핵심 발견**: Chandelier Exit의 표준은 **ATR(22), k=3**입니다. ATR(14)는 Wilder의 범용 ATR 표준이지 Chandelier Exit의 표준이 아닙니다. 22는 월간 영업일 수에서 유래합니다.

##### 4.2 파라미터 그리드 수정 제안

기존 제안 (Session 11/12):

- `atr_period ∈ {14, 20}`
- `atr_multiplier ∈ {3, 4, 5}`

수정 제안:

- `atr_period ∈ {14, 22}` (Wilder 표준 + Chandelier 표준)
- `atr_multiplier ∈ {3, 4, 5}`

**20 제거 근거**: 20은 "14와 22 사이의 임의 중간값"으로 근거가 약합니다. 14(Wilder)와 22(Chandelier/월간)는 각각 명확한 문헌 근거가 있습니다.

총 6조합 유지. 기존 Sell Fixed 144 조합 × 6 = **864 조합**, 여전히 계산 가능한 규모입니다.

##### 4.3 참고: "highest high" vs "highest close"

Chandelier Exit 원래 정의는 **22-day High** (고가)를 사용합니다. 그러나 본 프로젝트의 버퍼존 전략은 모든 시그널을 **종가(close)** 기준으로 판단합니다 (매수/매도 밴드 돌파 모두 close 기준). 일관성을 위해 **highest_close_since_entry**를 사용하는 것이 적절합니다.

이는 원래 Chandelier Exit보다 약간 타이트한 스탑을 생성합니다 (high > close이므로). 레버리지 ETF에서는 더 빠른 청산이 MDD 방어에 유리하므로, 이 변형은 오히려 바람직한 방향입니다.

---

#### 5. 레버리지 ETF + ATR 스탑의 알려진 함정 (웹 리서치)

##### 5.1 Whipsaw 증폭 문제

QQQ의 3.4% 움직임은 TQQQ에서 약 10.2%로 증폭됩니다. ATR을 TQQQ에서 직접 계산하면, 이 증폭된 노이즈가 ATR에 반영되어 스탑이 불필요하게 넓어지거나 (높은 k에서) 또는 정상 변동에서 빈번하게 발동됩니다 (낮은 k에서).

이것이 §3에서 ATR 소스를 QQQ로 수정한 핵심 이유입니다.

##### 5.2 Choppy Market 취약성

레버리지 ETF는 강한 추세장에서만 우수한 성과를 보입니다 (arXiv 2504.20116). 횡보장에서 ATR 스탑이 빈번하게 발동하면:

- 각 exit-reentry마다 슬리피지 0.6% (왕복)
- 레버리지 ETF의 변동성 감쇠(volatility decay)와 결합하여 손실 누적

이 리스크는 현재 `hold_days` 메커니즘이 부분적으로 완화합니다 (재진입에 확인 기간 요구). 그러나 ATR 스탑 도입 후 **총 거래수가 유의미하게 증가하는지** 반드시 모니터링해야 합니다.

##### 5.3 MDD 개선 기대치

일반 주식에서 ATR 스탑은 고정 스탑 대비 MDD를 약 32% 감소시킨다는 백테스트 결과가 있습니다 (LuxAlgo). 그러나 이는 레버리지 ETF 대상 연구가 아닙니다. 3x 레버리지의 비선형 복리 효과를 감안하면, 기대치를 보수적으로 잡아야 합니다.

**성공 기준 (GPT와 합의)**: Stitched MDD ≤ -50% AND Calmar ≥ 0.35

---

#### 6. 우선순위 및 구현 로드맵

Session 11의 우선순위 대비 변경: ATR 스탑 시그널 소스를 QQQ로 수정. Chandelier Exit 파라미터 22로 보정. 나머지 순서 동일.

| 순위  | 방법                                     | 상태                | 비고                   |
| ----- | ---------------------------------------- | ------------------- | ---------------------- |
| **1** | **WFO 구현**                             | **Done**            |                        |
| **2** | **WFE/Profit Concentration 지표 보강**   | 스펙 확정 (§1, §2)  | 3개 세션 합의 완료     |
| **3** | **목적함수 min_trades=3 제약**           | 스펙 확정           | 기존 설계 그대로       |
| **4** | **ATR 트레일링 스탑 (Sell Fixed + ATR)** | 스펙 수정 완료 (§3) | 시그널 소스 QQQ로 변경 |
| **5** | **PBO 분석 (TQQQ)**                      | 대기                |                        |
| **6** | **TQQQ 초기 IS 기간 확장 (72→96개월)**   | 대기                |                        |

---

#### 7. 목차/TL;DR 업데이트 제안

목차 추가:

```
18. [Session 12 — WFO 재검증 + WFE 정의 정확화 + ATR Phase 1 보강 (GPT-5.2)](#gpt-52-thinking--2026-02-22-1810-kst)
19. [Session 13 — Profit Concentration/WFE 확정 + ATR 시그널 소스 수정 + 구현 스펙](#claude-opus-46--2026-02-22-2140-kst)
```

TL;DR 수정 (열린 질문 업데이트):

```
- **열린 질문**: ATR 시그널 소스를 QQQ에서 계산 (확정) / ATR 파라미터 n={14,22}, k={3,4,5} / 목적함수 min_trades=3 제약 추가
```

---

참고 자료:

- TradeStation WFO Summary (WFE = annualized rates of return): https://help.tradestation.com/10_00/eng/tswfo/topics/walk-forward_summary_out-of-sample.htm
- TradeStation WFO FAQ (WFE > 100% cluster analysis): https://help.tradestation.com/10_00/eng/tswfo/topics/frequently_asked_questions.htm
- TradeStation Setup Test Criteria (50% profit concentration as configurable pass/fail): https://help.tradestation.com/09_01/tswfo/topics/setup_test_criteria.htm
- Pardo WFE 구현: TradeMaid Help — "annualized rates of return for OOS / IS": https://trademaid.info/gsbhelp/Walk-forwardefficiency.html
- ProRealTime WFE 연환산 근거: https://www.prorealcode.com/topic/walk-forward-efficiency-ratio/
- Zorro WFE 비판 (WFE와 견고성 상관관계 낮음): https://opserver.de/ubb7/ubbthreads.php?ubb=showflat&Number=446795
- AmiBroker WFO Guide (CAR/MDD = 목적함수, WFE와 별개): https://www.amibroker.com/guide/h_walkforward.html
- Chandelier Exit 표준 파라미터 (22, 3.0): https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit
- Chandelier Exit 정의 (22-day High, k=3): https://www.incrediblecharts.com/indicators/chandelier_exits.php
- Lambros Petrou — TQQQ signal source on underlying: https://www.lambrospetrou.com/articles/investing-leveraged-qqq-macd/
- LuxAlgo — ATR stop MDD reduction ~32%: https://www.luxalgo.com/blog/how-to-use-atr-for-volatility-based-stop-losses/
- LuxAlgo — ATR strategies for high volatility: https://www.luxalgo.com/blog/5-atr-stop-loss-strategies-for-risk-control/
- arXiv (2504.20116) — Compounding effects in leveraged ETFs: https://arxiv.org/html/2504.20116v1

다음 모델에게:

1. **ATR 시그널 소스 QQQ vs TQQQ에 대해 의견을 주세요.** 본 세션에서 QQQ 기반으로 수정했지만, 이에 대한 반론이 있을 수 있습니다. 특히 "스탑 레벨이 보유 자산(TQQQ)의 실제 가격과 괴리된다"는 문제를 어떻게 볼지, 또는 "QQQ에서 ATR을 계산하되 TQQQ의 highest_close를 기준으로 스탑을 설정하는 하이브리드"가 가능한지 검토해 주세요.
2. **Chandelier Exit 표준 파라미터 22를 수용할지** 의견을 주세요. 14(Wilder)와 22(Chandelier)는 각각 근거가 있으나, 본 프로젝트의 EMA 기반 전략에서 어떤 것이 더 적합한지 논의가 필요합니다. 또한 k={3,4,5} 범위에서 3이 Chandelier 기본값이므로 충분한지, 아니면 {2,3,4}로 좁혀야 하는지도 검토해 주세요.
3. **3개 구현 과제(WFE/PC, min_trades, ATR)의 구현 순서와 커밋 단위**에 대해 의견을 주세요. 본 세션 §6의 순서(WFE/PC → min_trades → ATR)는 "진단 도구 먼저, 변경 후에" 원칙이지만, min_trades가 WFO 결과 자체를 변경하므로 WFE/PC와 동시 구현이 효율적일 수 있습니다.

> **초보자 요약**: 이 세션의 핵심 발견 3가지:
> (1) **수치 검증 완료**: TQQQ의 수익이 한 구간(2023-2025)에 67% 집중된다는 이전 분석이 정확함을 확인했습니다. 11개 시험 기간 중 2개가 수익의 84%를 차지합니다 — 이는 3배 레버리지의 본질적 특성이지만, "특정 시장에 의존한다"는 경고입니다.
> (2) **ATR 스탑을 어디서 계산할지 수정**: 이전에는 "실제 보유 자산(TQQQ)의 가격"으로 계산하자고 했지만, 연구 결과 "기초 자산(QQQ)의 가격"이 더 깨끗한 신호를 준다는 것을 발견했습니다. 비유하자면: 자동차의 속도를 측정할 때, 흔들리는 바퀴(TQQQ)보다 안정적인 엔진 회전수(QQQ)를 보는 것이 더 정확합니다.
> (3) **표준 파라미터 보정**: Chandelier Exit의 표준 설정이 "22일, 3배"인 것을 확인. 이전에 제안했던 "14일"은 다른 지표(Wilder ATR)의 기본값이었습니다. 올바른 파라미터로 실험하면 결과가 달라질 수 있습니다.
> **WFE(Walk-Forward Efficiency)**: "연습(IS)에서 80점인데 본시험(OOS)에서 40점이면 WFE=50%". 50% 이상이면 "연습이 실전에서도 통한다"는 의미입니다. 이전 구현은 계산 방식이 깨져서 -1835 같은 엉뚱한 수가 나왔고, 이제 올바른 방식(CAGR 기반)으로 교체합니다.

---

### 21. 토론 합의 현황 (Session 9-14 기준)

> 아래는 Claude Opus 4.6 / GPT-5.2 간 6회 교대 토론(Session 9-14)에서 도출된 합의사항과 미합의 사항을 **구현 우선순위** 순으로 정리한 것입니다.

---

#### Phase 1: WFE / Profit Concentration 지표 보강 — 합의 완료

구현 대상: `walkforward.py`, `types.py`, `test_backtest_walkforward.py`

| #   | 합의 사항                      | 상세                                                                                              |
| --- | ------------------------------ | ------------------------------------------------------------------------------------------------- |
| 1   | **wfe_calmar 폭주 문제 확인**  | IS Calmar가 0 근처일 때 WFE 폭주 (예: -1835). EPSILON 방어로는 불충분                             |
| 2   | **wfe_cagr를 1급 지표로 추가** | TradeStation 원래 정의("annualized rates of return")와 정합. `is_cagr < 0.01`이면 None            |
| 3   | **gap_calmar_median 추가**     | `median(oos_calmar - is_calmar)`. 비율 대신 차이로 폭주 원천 차단                                 |
| 4   | **wfe_calmar_robust 추가**     | `is_calmar >= 0.05`인 윈도우만 필터 후 median. 기존 wfe_calmar는 레거시 유지                      |
| 5   | **Profit Concentration 추가**  | V2 방식: `window_profit = equity_end - prev_window_equity_end`. 합계 = total net profit 정확 일치 |
| 6   | **PC 50% 경고 기준**           | TradeStation Pardo 휴리스틱. `max_share > 0.5`이면 warning = True                                 |
| 7   | **PC 수치 검증 완료**          | TQQQ Dynamic 67.33%, Sell Fixed 67.52%, Fully Fixed 53.17%, QQQ 전 모드 50% 미만                  |

#### Phase 2: 목적함수 min_trades=3 제약 — 합의 완료

구현 대상: `walkforward.py`의 `select_best_calmar_params()`

| #   | 합의 사항                                 | 상세                                                                        |
| --- | ----------------------------------------- | --------------------------------------------------------------------------- |
| 8   | **min_trades=3 제약 추가**                | 거래수 < 3이면 Calmar 점수 = -1e10 (최하). 첫 IS 윈도우 sell=0.01 문제 해결 |
| 9   | **sell_fixed=0.03/0.01 추가 실험 불필요** | sell=0.01 OOS 결과가 모두 음수. ATR 스탑이 더 생산적                        |
| 10  | **WFO 재실행 후 Stitched MDD 비교**       | min_trades 적용 전후 결과 비교 필요                                         |

#### Phase 3: ATR 트레일링 스탑 (Sell Fixed + ATR) — 부분 합의

구현 대상: `buffer_zone_helpers.py`, `walkforward.py`, `constants.py`

**합의 완료 (구현 가능):**

| #   | 합의 사항                              | 상세                                                                |
| --- | -------------------------------------- | ------------------------------------------------------------------- |
| 11  | **ATR 스탑 필요성**                    | TQQQ MDD -62% → -50% 목표 달성의 핵심 수단                          |
| 12  | **Sell Fixed(0.05) + ATR을 Phase 1로** | 독립 변수 분리 + 탐색 공간 축소 (144 × 6 = 864 조합)                |
| 13  | **ATR multiplier k ∈ {3, 4, 5}**       | Chandelier 기본값 3 + 레버리지 변동성 상향                          |
| 14  | **IS에서 ATR 파라미터 최적화**         | 6조합이므로 다중검정 리스크 미미                                    |
| 15  | **기존 청산과 OR 조건**                | 하단밴드 청산 OR ATR 스탑, 먼저 충족되면 다음 시가 청산             |
| 16  | **성공 기준**                          | Stitched MDD ≤ -50% AND Calmar ≥ 0.35                               |
| 17  | **BufferStrategyParams 확장**          | `atr_period: int = 0` (0이면 비활성), `atr_multiplier: float = 0.0` |
| 18  | **하위 호환성 유지**                   | `atr_period=0`이면 기존 동작과 완전 동일                            |

**미합의 (GPT 응답 대기):**

| #   | 주제                | Claude 입장 (S14)                                                                                         | GPT 입장 (S10/S13)                                                       | 비고                                                                  |
| --- | ------------------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------- |
| A   | **ATR 시그널 소스** | **QQQ(signal_df)** — 레버리지 ETF에 직접 TA 적용 시 노이즈 증가. 아키텍처 일관성 (모든 시그널이 QQQ 기준) | **TQQQ(trade_df)** — 보유 자산의 변동성에 기반해야. 레버리지 보정 불필요 | 가장 중요한 미합의. Claude가 자기 이전 입장(S12: TQQQ)을 S14에서 철회 |
| B   | **ATR period**      | **{14, 22}** — Chandelier Exit 표준 = ATR(22). 20은 근거 약함                                             | **{14, 20}** — 포지션 트레이딩 관례                                      | Chandelier 원문 StockCharts 확인: "(22, 3.0)"                         |
| C   | **기준가**          | **highest_close** — 전략의 모든 시그널이 close 기준                                                       | 명시적 언급 없음 (Chandelier 원래 = highest_high)                        | 새 제안, 미논의                                                       |

#### 후순위 / 보류 사항

| #   | 주제                          | 상태            | 비고                                  |
| --- | ----------------------------- | --------------- | ------------------------------------- |
| D   | PBO 분석 (TQQQ)               | **보류 합의**   | 양측 모두 우선순위 5로 하향           |
| E   | TQQQ IS 기간 확장 (72→96개월) | **보류 합의**   | min_trades로 우선 해결 시도 후 필요시 |
| F   | DSR(Deflated Sharpe Ratio)    | **미논의**      | GPT만 2회 언급, Claude 미대응         |
| G   | MDD 제약형 목적함수           | **사실상 폐기** | GPT S10 제안 → min_trades로 대체      |

---

### 22. Session 15 [GPT-5.2 Thinking] — 2026-02-22 22:35 (KST)

> **주제**: Phase 1~3 합의안 vs 내 입장 점검(특히 ATR 미합의 3건 A/B/C) + 코드 기반 팩트체크 + "미합의 해소" 실험 설계

---

#### 1. 질문에 대한 직답: "Phase 1~3 중 내 의견이 다른 부분?"

**결론부터:**

- **Phase 1** (WFE/Profit Concentration 보강): **동의** (단, `wfe_cagr`의 분모가 음수/0 근처일 때 해석이 깨지는 문제를 막기 위해 *"양수 IS만 집계한 보조값"*을 추가하자는 제안은 있음)
- **Phase 2** (min_trades=3 제약): **동의**
- **Phase 3** (ATR 스탑): 공유문서의 "미합의 3건(A/B/C)" 중
  - **B**(ATR period {14,22} vs {14,20}): **{14,22} 쪽으로 동의**(Chandelier Exit 표준이 (22,3.0) 근거가 명확)
  - **C**(기준가 highest_close vs highest_high): **highest_close 기본에 동의**(전략의 모든 신호가 close 기반이라 "시그널 일관성"이 더 중요)
  - **A**(ATR 시그널 소스: QQQ vs TQQQ): 단정 동의/반대가 아니라 **"둘 다 합리적"**이라서, 코드 레벨로 옵션화 후 1회 A/B 테스트로 종결이 최선이라고 봅니다.

> 즉, 지금 시점 내 입장 = "QQQ-only로 고정 확정"에도, "TQQQ-only로 고정 확정"에도 100% 동의하지 않음(따라서 **Phase 3-A는 현재 내 관점에선 아직 미합의 유지가 타당**).

---

#### 2. 코드 기반 팩트체크: Phase 1~2는 아직 "미구현" 상태

`quant.tar.gz` 기준으로 확인한 현재 상태:

**`src/qbt/backtest/walkforward.py`**

- WFE가 **`wfe_calmar = oos_calmar / is_calmar`**만 존재(폭주 가능)
- `wfe_cagr`, `gap_calmar_median`, `wfe_calmar_robust`, `profit_concentration_*` 아직 없음
- `select_best_calmar_params()`에 `min_trades` 제약 없음

**`src/qbt/backtest/strategies/buffer_zone_helpers.py`**

- `BufferStrategyParams`에 `atr_period`, `atr_multiplier` 아직 없음
- 매도 로직은 하단밴드 하향 돌파만 사용(ATR 스탑 OR 조건 없음)

> 즉, 공유문서의 Phase 1~3는 "합의 스펙"으로 정리되어 있고, **코드에는 아직 반영 전**입니다.

---

#### 3. 결과 데이터 기반 팩트체크: Profit Concentration 수치는 문서가 맞음

로컬 산출물(`walkforward_equity_*.csv`, `walkforward_*.csv`)로 직접 재계산해 확인했습니다.

**Profit Concentration** (분모=total net profit, V2 방식 `end - prev_end`)

| 전략/모드        | max_share | max_window_idx |
| ---------------- | --------- | -------------- |
| TQQQ Dynamic     | 0.673309  | 9              |
| TQQQ Sell Fixed  | 0.675226  | 9              |
| TQQQ Fully Fixed | 0.531713  | 7              |
| QQQ Dynamic      | 0.438821  | 9              |
| QQQ Sell Fixed   | 0.445069  | 9              |
| QQQ Fully Fixed  | 0.476001  | 9              |

TradeStation 문서가 말하는 "특정 구간이 total net profit의 50% 이상이면 경고/실격 가능" 휴리스틱과 정합하게, **TQQQ는 전 모드에서 경고(>0.5)**, **QQQ는 미경고(<0.5)**입니다.

---

#### 4. (중요) 문서 vs 코드 불일치 1건: "매도에 hold_days 적용" 예시는 코드와 다름

공유문서 §3.2의 예시에서 매도도 hold_days를 타는 것처럼 서술된 부분이 있는데, 코드상:

- **매수만** `hold_state`(`hold_days`) 상태머신 적용
- **매도는** 즉시 `pending sell` 생성 → 다음 거래일 시가에 체결

`run_buffer_strategy()`의 흐름을 보면 sell은 `_detect_sell_signal()` 발생 시점에 `pending_order = sell(next_open)`로 들어갑니다.

> (이건 결론 자체를 바꾸진 않지만, "체결 타이밍 규칙" 설명 정확도를 위해 **문서에서 정정 필요**)

---

#### 5. Phase 3-A(ATR 시그널 소스) — "서로 타당한 근거"가 있어 단정이 위험 → 옵션화 + 1회 A/B로 종결 제안

왜 A가 단정 결론 내리기 어렵냐면: **근거가 양쪽으로 존재**합니다.

**QQQ(`signal_df`) 기반 주장** (Claude S14 방향)

- 레버리지 ETF는 일간 레버리지/복리 구조로 단기 노이즈가 커서 "기초자산으로 신호를 잡는 게 낫다"는 실무 조언이 흔함(특히 진입/추세 신호에서).

**TQQQ(`trade_df`) 기반 주장** (내 S11 방향 + Petrou의 'stop은 traded symbol' 뉘앙스)

- 우리는 TQQQ로 손익이 난다 → "스탑(리스크 관리)은 traded symbol에서 계산"이 더 자연스럽다는 관점도 강함.

**그래서 제 결론은:**

1. ATR 소스는 하이퍼파라미터로 그리드에 넣지 말고(다중검정↑),
2. 코드에서 `atr_source` 옵션(예: `"signal"` vs `"trade"`)만 제공하고,
3. Sell Fixed(0.05)+ATR Phase 1을 **"2회"만** 돌려서(동일 n,k 그리드) stitched MDD/Calmar를 비교한 뒤,
4. **승자만 채택하고 이후 고정**이 가장 깔끔합니다.

---

#### 6. Phase 3-B(ATR period) — {14,22}에 동의

- Chandelier Exit의 표준 파라미터가 **(22, 3.0)**이고 공식 정의가 "22-day High − ATR(22)×3"로 안내됩니다.
- 반면 14는 Wilder ATR의 전통적 기본값으로 널리 쓰이는 표준입니다. (따라서 14와 22를 함께 시험하는 게 합리적)

> 따라서 **`atr_period ∈ {14,22}`**는 근거가 명확합니다.

---

#### 7. Phase 3-C(기준가) — highest_close 기본 동의 + "highest_high 옵션은 2차"

공유문서가 지적한 대로 Chandelier는 원래 `highest_high`를 쓰지만, 현재 전략의 모든 신호가 close 기반입니다.

- **기본값**: `highest_close_since_entry`
- **옵션(2차)**: `highest_high_since_entry`

> 다만 이건 추가 옵션을 넣는 순간 실험 분기가 늘고(다중검정↑), 지금 목표가 "MDD -50 달성"이므로 **우선 `highest_close`로 고정하고 1차 결과를 보는 게 더 낫다**고 봅니다.

---

#### 8. 구현 순서/커밋 단위 제안(= "다음 모델에게" Q3 답변)

Claude S14의 질문(구현 순서/커밋 단위)에 대한 제 답은:

| 커밋                   | 범위                                         | 행동 변화                         |
| ---------------------- | -------------------------------------------- | --------------------------------- |
| **Commit 1** (Phase 1) | WFE/PC 지표 보강만                           | 없음                              |
| **Commit 2** (Phase 2) | `min_trades=3` 반영 + WFO 재실행 산출물 갱신 | 파라미터 선택이 바뀌므로 **있음** |
| **Commit 3** (Phase 3) | ATR 스탑 도입 + WFO 재실행                   | 행동 변화 **큼**                  |

- 여기서 `atr_source`는 옵션으로만 제공하고, 실험은 "signal vs trade" 2회로 제한(그리드에 포함 X)

> 이 순서가 **"진단 도구 먼저 → 선택 규칙 수정 → 리스크 관리 추가"**라서 회귀/원인추적이 가장 쉽습니다.

---

#### 9. 우선순위 테이블 업데이트

| 순위 | 방법                                           | 근거                                                                            | 상태          |
| ---- | ---------------------------------------------- | ------------------------------------------------------------------------------- | ------------- |
| 1    | Phase 1: WFE/PC 지표 보강                      | TradeStation WFE 정의(연환산 수익률 비교) 및 profit concentration 휴리스틱 정합 | **다음 진행** |
| 2    | Phase 2: min_trades=3                          | "거래 거의 없는 파라미터가 Calmar로 1등 먹는" 구조적 결함 제거                  | **다음 진행** |
| 3    | Phase 3: Sell Fixed(0.05)+ATR                  | TQQQ MDD -62 → -50 갭 직접 타격, 탐색공간 제한(864)                             | 대기          |
| 4    | Phase 3-A 미합의 해소: atr_source A/B 2회 실험 | QQQ vs TQQQ 근거가 양쪽에 있어 단정 위험 → 최소 실험으로 종결                   | 대기          |
| 5    | PBO/DSR(후순위)                                | 탐색공간/선택편향 점검(특히 기능 추가 후)                                       | 대기          |

> §14(합의현황) 대비 변경점: Phase 3-A를 "미합의 유지"로 두되, 그리드가 아니라 **'2회 A/B 실험'**으로 빠르게 종결하는 실행안을 추가했습니다.

---

#### 10. TL;DR / 목차 업데이트 제안

이번 세션의 핵심이 **"미합의 A를 실험으로 닫자"**이므로, 상단 갱신이 필요하다면 아래처럼 수정 제안합니다.

**TL;DR 수정(열린 질문만 업데이트)**

> **열린 질문**: ATR 시그널 소스(QQQ vs TQQQ)는 옵션화 후 2회 A/B로 결정, ATR period는 {14,22}, 기준가는 highest_close(1차 고정)

---

#### 참고 자료

- TradeStation Help. (WFE는 IS/OOS annualized rates of return 비교 + profit concentration 경고). https://help.tradestation.com/09_01/tswfo/topics/walk-forward_summary_out-of-sample.htm
- StockCharts ChartSchool. (Chandelier Exit 기본 파라미터 (22, 3.0) 및 공식). https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit
- IncredibleCharts. (Chandelier Exit 정의/구성 요소 설명). https://www.incrediblecharts.com/indicators/chandelier_exits.php
- Lambros Petrou. (레버리지 ETF 전략에서 underlying로 신호 vs traded symbol로 stop을 두는 실무 관점). https://www.lambrospetrou.com/articles/investing-leveraged-qqq-macd/
- David H. Bailey papers / pbo package docs. (선택편향·백테스트 과최적화 경고 프레임). https://www.davidhbailey.com/dhbpapers/ , https://cran.csiro.au/web/packages/pbo/pbo.pdf

---

#### 다음 모델에게

1. **Phase 1 구현**: `walkforward.py`/`types.py`/`tests`에 합의된 필드(`wfe_cagr`, `gap_calmar_median`, `wfe_calmar_robust`, `profit_concentration_*`)를 추가하고, `walkforward_summary.json`에 반영해 주세요. (PC는 V2 방식 유지)

2. **Phase 2 구현**: `select_best_calmar_params()`에 `min_trades=3`를 넣고, 적용 전/후로 TQQQ Dynamic 첫 2개 윈도우의 선택 파라미터가 어떻게 바뀌는지와 stitched MDD 변화를 리포트해 주세요.

3. **Phase 3-A 종결 실험 설계(중요)**: ATR 구현 시 `atr_source = "signal" | "trade"` 옵션만 코드로 열어두고, 그리드에 포함시키지 말고 Sell Fixed+ATR을 "signal 1회 / trade 1회"만 실행해서 stitched MDD/Calmar/거래수 차이를 비교해 주세요(승자 채택 후 고정).

---

> **초보자 요약**: 지금 논쟁은 **"브레이크(ATR 스탑)를 엔진(QQQ) 기준으로 달까, 바퀴(TQQQ) 기준으로 달까?"**입니다. 둘 다 그럴듯해서 말로 결론 내리기보다, 딱 2번만 실험해서 더 안전한 쪽을 채택하는 게 가장 빠릅니다.
>
> - **WFE**: "연습(IS) 성적 대비 실전(OOS) 성적이 얼마나 유지됐나"를 보는 지표(TradeStation은 연환산 수익률 비교).
> - **Profit Concentration**: "전체 이익이 특정 기간에 얼마나 몰렸나"를 보는 경고등(50% 넘으면 특정 장세 의존 가능성).
> - **Chandelier Exit**: ATR(변동성)로 만든 트레일링 스탑의 대표 형태(기본 (22,3.0)).

---

### 23. Session 16 [Claude Sonnet 4.6] — 2026-02-23 16:16 (KST)

주제: Phase 1~3 구현 완료 보고 + ATR 전략 WFO 결과 분석: Stitched MDD -52.95%, ATR(14, 3.0) 전윈도우 수렴

#### 1. Session 15 질문 응답: Phase 1~3 구현 완료 팩트체크

Session 15 (GPT)의 "다음 모델에게" 3개 과제 이행 상태를 코드로 직접 확인:

| 과제                                                  | Session 15 요청                                                                     | 실제 구현 상태                                                   |
| ----------------------------------------------------- | ----------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| Phase 1: WFE/PC 지표 보강                             | `wfe_cagr`, `gap_calmar_median`, `wfe_calmar_robust`, `profit_concentration_*` 추가 | **Done** — PLAN_wfo_wfe_pc_metrics, passed=347, failed=0         |
| Phase 2: min_trades=3 제약                            | `select_best_calmar_params()`에 min_trades=3 필터링                                 | **Done** — PLAN_wfo_min_trades, passed=350, failed=0             |
| Phase 3-A: ATR source QQQ vs TQQQ 2회 실험            | 2회 실험 후 승자 채택                                                               | **미실행 — 사용자가 QQQ 고정으로 결정**                          |
| Phase 3-B/C: ATR `{14,22}×{2.5,3.0}`, `highest_close` | 그리드 4종, ATR 스탑 OR 조건                                                        | **Done** — PLAN_atr_trailing_stop_strategy, passed=358, failed=0 |

**코드 확인 근거**: PLAN_atr_trailing_stop_strategy.md §8 Notes에 "ATR 시그널 소스 합의: QQQ 고정 (Session 15에서 GPT는 A/B 테스트 제안했으나, 사용자가 QQQ 고정으로 결정)"이라고 명시. Phase 3-A는 사용자 결정으로 종결됨.

구현 순서는 Session 15 제안(Phase 1 → 2 → 3)을 정확히 따랐으며, 각 Phase 완료 후 검증을 통과했음을 확인.

---

#### 2. ATR 전략 WFO 결과: 3-Mode Stitched 성과 비교

**코드 확인 출처**: `storage/results/backtest/buffer_zone_atr_tqqq/walkforward_summary.json`, `storage/results/backtest/buffer_zone_tqqq/walkforward_summary.json`

| Mode        | 기존 TQQQ CAGR | ATR TQQQ CAGR | 차이    | 기존 MDD | ATR MDD     | MDD 개선 |
| ----------- | -------------- | ------------- | ------- | -------- | ----------- | -------- |
| Dynamic     | 21.68%         | 16.09%        | -5.59pp | -62.09%  | **-52.95%** | +9.14pp  |
| Sell Fixed  | 20.77%         | 11.32%        | -9.45pp | -70.06%  | -54.31%     | +15.75pp |
| Fully Fixed | 6.97%          | 8.40%         | +1.43pp | -61.10%  | **-51.75%** | +9.35pp  |

**목표 달성 여부**: Stitched MDD -50% 목표는 모든 모드에서 아직 미달. Dynamic은 2.95pp, Fully Fixed는 1.75pp 차이.

**주목할 결과**: Fully Fixed 모드에서 CAGR이 유일하게 개선(+1.43pp)되면서 MDD도 -9.35pp 개선됨. 기존 Fully Fixed의 낮은 IS Calmar 구조가 ATR 스탑 추가로 더 나은 파라미터를 선택하게 된 것으로 추정.

---

#### 3. 진단 지표 비교: WFE 폭주 해소 + Profit Concentration 경고 해제

**코드 확인 출처**: walkforward_summary.json (Dynamic 모드 기준)

| 지표              | 기존 TQQQ Dynamic  | ATR TQQQ Dynamic       | 변화                |
| ----------------- | ------------------ | ---------------------- | ------------------- |
| WFE Calmar Mean   | -161.66 (**폭주**) | 5.37                   | **폭주 완전 해소**  |
| WFE Calmar Median | -0.40              | 2.39                   | 개선                |
| WFE Calmar Robust | 0.94               | 2.39                   | 개선                |
| WFE CAGR Mean     | -72.19 (**폭주**)  | 1.92                   | **폭주 해소**       |
| WFE CAGR Median   | -0.22              | 0.95                   | 개선                |
| Gap Calmar Median | 0.20               | 0.22                   | 유사                |
| **PC Max**        | 0.6733 (**경고**)  | **0.4799 (경고 해제)** | 경고 기준(0.5) 하회 |
| OOS 총 거래       | 18회               | 51회                   | +33회               |
| OOS 평균 승률     | 32.58%             | 50.2%                  | +17.62pp            |

WFE 폭주의 원인: 기존 TQQQ Dynamic Window 2에서 IS Calmar=-0.0017(거의 0)이었기 때문에 `wfe_calmar = oos_calmar / is_calmar` 계산 시 분모가 0에 수렴 → -1835 극단값 발생. ATR 전략에서는 같은 Window 2의 IS Calmar=0.0814로 정상화됨.

**발견 1**: Profit Concentration 경고 해제가 가장 주목할 개선. 기존 0.6733(수익의 67%가 Window 9에 집중)에서 0.4799(48%)로 개선. TradeStation 휴리스틱(50% 초과 경고) 기준을 하회.

**발견 2**: OOS 거래 18 → 51회 증가는 ATR 스탑이 실제로 발동하여 보유 기간을 단축한 결과. 승률 32.58% → 50.2% 개선은 ATR 스탑이 큰 손실 거래를 중도 청산하는 효과를 실증.

---

#### 4. 팩트체크: ATR(14, 3.0) 전윈도우 수렴 현상

**코드 확인 출처**: `walkforward_dynamic.csv`, `walkforward_sell_fixed.csv`, `walkforward_fully_fixed.csv` (각 파일의 `best_atr_period`, `best_atr_multiplier` 컬럼 직접 확인)

그리드 설정: `{14, 22} × {2.5, 3.0}` (4개 조합)

| 모드        | 윈도우 0~10 ATR 선택 결과 |
| ----------- | ------------------------- |
| Dynamic     | **전부 (14, 3.0)**        |
| Sell Fixed  | **전부 (14, 3.0)**        |
| Fully Fixed | **전부 (14, 3.0)**        |

Session 15에서 GPT와 Claude 양측 모두 "(22, 3.0)이 Chandelier Exit 표준"이라고 언급했으나, IS Calmar 최적화 결과는 11개 윈도우, 3개 모드, **33개 데이터 포인트 전부에서 예외 없이 (14, 3.0) 선택**됨.

**해석**: ATR 14일은 ATR 22일보다 더 빠르게 변동성을 반영함. IS 구간(닷컴버블, 금융위기 포함 확장 기간)에서 더 빠른 청산이 IS Calmar를 높이는 방향으로 작동한 것으로 판단됨. 단, IS 최적화 결과가 OOS에서도 동일하게 유효한지는 추가 검증이 필요.

**Chandelier 표준 (22, 3.0)의 재평가**: 웹 리서치(StockCharts ChartSchool, QuantifiedStrategies.com)에 따르면 22일은 "월간 거래일 기준"에서 유래. 그러나 3배 레버리지 ETF는 일반 주식보다 변동성이 크기 때문에 더 짧은 ATR 기간(14일)이 더 타이트하고 빠른 스탑을 제공하여 IS에서 유리했을 가능성이 있음. 이 가설은 OOS 독립 구간 실험으로 검증 가능.

**과최적화 시각**: 4개 조합 중 33개 데이터 포인트 전부 동일 파라미터는 안정성 신호로 볼 수 있음. 단, IS 성과(Calmar)만으로 선택했으므로 OOS에서의 일반화 가능성은 별도 검증 권장.

---

#### 5. OOS 윈도우별 손익 분포 (Dynamic 모드) — 과최적화 리스크 평가

| 윈도우 | OOS 기간  | OOS CAGR   | OOS MDD     | OOS 거래 | 판정            |
| ------ | --------- | ---------- | ----------- | -------- | --------------- |
| 0      | 2005-2007 | -5.58%     | -20.45%     | 3        | 손실            |
| 1      | 2007-2009 | -9.88%     | -58.94%     | 6        | 손실 (금융위기) |
| 2      | 2009-2011 | **65.54%** | -37.67%     | 5        | 이익            |
| 3      | 2011-2013 | -20.88%    | **-65.64%** | 9        | 손실            |
| 4      | 2013-2015 | **51.13%** | -17.20%     | 3        | 이익            |
| 5      | 2015-2017 | -17.46%    | -42.94%     | 8        | 손실            |
| 6      | 2017-2019 | 9.35%      | -24.35%     | 5        | 이익            |
| 7      | 2019-2021 | **36.78%** | -30.32%     | 4        | 이익            |
| 8      | 2021-2023 | -0.09%     | -22.13%     | 3        | 손실            |
| 9      | 2023-2025 | **44.49%** | -21.23%     | 4        | 이익            |
| 10     | 2025-2026 | **30.14%** | -24.25%     | 1        | 이익            |

11개 OOS 윈도우 중 5개 손실(45%), 6개 이익(55%). Stitched 기준에서 이익 윈도우의 이익이 손실 윈도우의 손실을 크게 상회하여 Stitched CAGR 16.09% 달성.

**ATR 스탑이 MDD 관리에 기여한 구간**: Window 3 OOS MDD -65.64%는 여전히 높음. 이는 2011~2013 구간에서 ATR 스탑이 발동하더라도 TQQQ 합성 특성상 낙폭이 컸음을 의미. Window 1(금융위기) OOS MDD -58.94%도 유사.

**기존 TQQQ Dynamic과의 비교 (OOS 총 거래)**:

- 기존: 18회 → ATR: 51회 (+33회). 기존 Dynamic에서 OOS 거래 0~1회인 윈도우가 다수였던 것 대비, ATR 전략에서는 모든 윈도우에서 최소 3회 이상 거래 발생.

**다중검정 리스크**: IS 탐색공간 1,728개 조합(Dynamic 모드), 11개 OOS 윈도우. WFO의 OOS 검증이 이 리스크를 완화하는 역할을 하지만, 완전 제거는 불가. PBO(Probability of Backtest Overfitting)/DSR 분석은 추후 검토 권장.

---

#### 6. 상단 업데이트 제안

사용자가 직접 공유 문서 상단 섹션을 아래 내용으로 갱신하기를 권장합니다.

**목차에 추가**:

```
23. [Session 16 (Claude) — Phase 1~3 구현 완료 + ATR WFO 결과: Stitched MDD -52.95%, ATR(14,3.0) 전윈도우 수렴](#session-16-claude-sonnet-46--2026-02-23-1616-kst)
```

**최신 결론 (TL;DR) 업데이트 제안 — 2026-02-23 기준**:

```
- **QQQ 전략**: WFO 검증 통과. Fully Fixed(MA=200, buy=0.01, sell=0.05, hold=2, recent=8)가 Dynamic보다 우수 → 파라미터 고정 운용 가능
- **TQQQ ATR 전략**: Phase 1~3 구현 완료. ATR TQQQ Dynamic WFO Stitched CAGR 16.09%, MDD -52.95% (기존 -62.09% → 9.14pp 개선). 목표 MDD -50%에 2.95pp 미달.
- **ATR 파라미터**: IS Calmar 최적화 결과 모든 윈도우에서 (ATR period=14, multiplier=3.0) 수렴. Chandelier 표준(22, 3.0) 불채택.
- **WFE/PC 개선**: WFE 폭주 해소 (-161 → 5.37), Profit Concentration 경고 해제 (0.67 → 0.48).
- **Phase 3-A 종결**: ATR 소스 QQQ 고정 (사용자 결정).
- **다음 실험**: ATR multiplier 2.5 재실험 (MDD -50% 목표 달성 도전) / Fully Fixed (MA=150, ATR=14, mult=3.0) 단일 백테스트 검증
```

---

#### 7. 우선순위 테이블 업데이트

| 순위 | 방법                                | 근거                                                                             | 상태                   |
| ---- | ----------------------------------- | -------------------------------------------------------------------------------- | ---------------------- |
| 1    | Phase 1: WFE/PC 지표 보강           | WFE 폭주 해소 + PC 진단 기반 마련                                                | **Done**               |
| 2    | Phase 2: min_trades=3 제약          | IS 거래 부족 파라미터 탈락 안전장치                                              | **Done**               |
| 3    | Phase 3: ATR 스탑 (QQQ 고정)        | Stitched MDD -62% → -53% (+9.14pp), PC 경고 해제                                 | **Done**               |
| 4    | ATR multiplier 하향 실험 (2.5 단일) | 현재 (14,3.0) 수렴 확인. multiplier 낮추면 더 타이트한 스탑 → MDD -50% 달성 도전 | **다음 진행**          |
| 5    | Fully Fixed 단일 백테스트 검증      | ATR TQQQ Fully Fixed MDD -51.75% — 목표 근접. 파라미터 고정 운용 가능성 검토     | **다음 진행**          |
| 6    | Phase 3-A: ATR source 비교          | 사용자가 QQQ 고정으로 결정                                                       | **종결 (사용자 결정)** |
| 7    | PBO/DSR 분석                        | 탐색공간 1,728개 → 다중검정 점검                                                 | 대기                   |

Session 15 대비 변경점:

- Phase 1, 2, 3 모두 Done으로 전환
- Phase 3-A 종결 (사용자 결정)
- 순위 4에 "ATR multiplier 2.5 단일 재실험" 신규 추가 (목표 MDD -50% 달성 도전)
- 순위 5에 "Fully Fixed 단일 백테스트" 신규 추가 (목표 근접 모드 실용성 검토)

---

참고 자료:

- ATR Trailing Stops. StockCharts ChartSchool. https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-indicators/atr-trailing-stops
- Chandelier Exit. StockCharts ChartSchool. https://chartschool.stockcharts.com/table-of-contents/technical-indicators-and-overlays/technical-overlays/chandelier-exit
- Chandelier Exit Strategy. QuantifiedStrategies.com. https://www.quantifiedstrategies.com/chandelier-exit-strategy/
- ATR Trailing Stop. QuantifiedStrategies.com. https://www.quantifiedstrategies.com/atr-trailing-stop/
- Compounding Effects in Leveraged ETFs: Beyond the Volatility Drag Paradigm. arXiv:2504.20116v1. https://arxiv.org/html/2504.20116v1
- Dynamic ATR Trailing Stop Trading Strategy. Medium (Sword Red). https://medium.com/@redsword_23261/dynamic-atr-trailing-stop-trading-strategy-market-volatility-adaptive-system-2c2df9f778f2

---

다음 모델에게:

1. **ATR multiplier 2.5 재실험**: 현재 모든 윈도우에서 (14, 3.0) 선택됨. multiplier를 2.5로 단일 고정하여 `run_walkforward.py --strategy buffer_zone_atr_tqqq`를 재실행하면 Stitched MDD -50% 달성 가능한지 확인해 주세요. 코드상 `DEFAULT_WFO_ATR_MULTIPLIER_LIST = [2.5]`로 임시 변경하거나, 전략 파일의 OVERRIDE에 `atr_multiplier=2.5` 고정하는 방식 검토. 결과를 (14,3.0) 기준과 비교 테이블로 제시해 주세요.
2. **ATR TQQQ Fully Fixed 단일 백테스트**: `walkforward_fully_fixed.csv` 기준 고정 파라미터 (MA=150, buy=0.05, sell=0.05, hold=5, recent=8, ATR=14, mult=3.0)로 `run_single_backtest.py --strategy buffer_zone_atr_tqqq`를 실행하고, 전체 기간(1999~2026) 단일 백테스트 결과와 WFO Stitched 결과를 비교해 주세요. 과최적화 갭이 얼마나 되는지 확인이 목적.
3. **ATR(14, 3.0) vs (22, 3.0) OOS 비교**: IS 최적화 없이 (14, 3.0) 고정 vs (22, 3.0) 고정으로 각각 walk-forward를 1회 실행하여 OOS 성과를 직접 비교해 주세요. IS 최적화 편향 없이 파라미터 일반화 가능성을 검증하는 것이 목적.

---

> 초보자 요약: ATR(자동 손절) 기능을 추가하니 최대 손실이 -62%에서 -53%로 줄었습니다. 목표인 -50%에는 아직 3% 부족하지만, 전략이 자동으로 선택한 파라미터가 항상 같은 값(14일, 3배)이었다는 점이 흥미롭습니다. 이는 3배 레버리지 상품에서 빠른 손절이 유리하다는 것을 보여줍니다. 다음 단계는 손절 기준을 조금 더 빠르게(3배 → 2.5배) 조정해서 목표에 더 가까이 가는 것입니다.
>
> - **ATR(Average True Range)**: 주식이 하루에 보통 얼마나 오르내리는지를 측정하는 지표.
> - **트레일링 스탑**: "최고점에서 일정 폭 이상 떨어지면 자동으로 파는" 규칙.
> - **Stitched CAGR/MDD**: 여러 구간을 연결해 만든 가상 포트폴리오의 연간 수익률/최대 낙폭.
> - **Profit Concentration**: 전체 수익이 특정 기간에 얼마나 몰렸는지. 48%로 개선(기존 67%).

---

_이 문서는 지속적으로 업데이트됩니다. 새로운 세션마다 하단에 섹션을 추가하세요._
