# QBT 프로젝트 가이드라인

> **🚨 CRITICAL**: 특정 패키지 또는 폴더의 파일을 분석하거나 작업할 때는
> **반드시 해당 폴더에 위치한 `CLAUDE.md`를 먼저 읽고 참고**해야 합니다.
> 이는 필수 요구사항입니다. 루트 문서는 프로젝트 전반의 공통 규칙을 제공하며,
> 각 패키지 문서는 해당 도메인의 구체적인 맥락과 핵심 개념을 제공합니다.

## 문서 목적

이 문서는 AI 모델(Sonnet)이 QBT 프로젝트를 정확히 이해하고, 일관성 있는 응답을 생성하도록 돕습니다.
사람을 위한 상세 문서가 아닌, AI 모델의 판단 기준과 프로젝트 맥락을 제공합니다.

---

## 프로젝트 개요

QBT(Quant BackTest)는 주식 백테스팅 CLI 도구입니다.

**핵심 기능 도메인**:

- 시계열 데이터 수집 및 검증
- 이동평균 기반 거래 전략 백테스트
- 레버리지 상품 시뮬레이션 및 최적화
- 대화형 시각화 대시보드

**기술 환경**:

- Python 3.10+ (`str | None` 문법 사용)
- 의존성 관리: Poetry
- 코드 품질: Black, Ruff
- 주요 라이브러리: pandas, yfinance, Plotly, Streamlit

---

## 디렉토리 구조

```
quant/
├── scripts/           # CLI 스크립트 (도메인별 분리)
│   ├── data/          # 데이터 다운로드
│   ├── backtest/      # 백테스트 실행
│   └── tqqq/          # 레버리지 ETF 관련
├── src/qbt/           # 비즈니스 로직
│   ├── common_constants.py  # 공통 상수 (경로, 컬럼명, 연간 영업일 등)
│   ├── backtest/      # 백테스트 도메인
│   │   ├── constants.py  # 백테스트 전용 상수
│   │   ├── data.py
│   │   ├── strategy.py
│   │   └── metrics.py
│   ├── tqqq/          # 레버리지 ETF 시뮬레이션
│   │   ├── constants.py  # 시뮬레이션 전용 상수
│   │   ├── leveraged_etf.py
│   │   └── dashboard.py
│   └── utils/         # 공통 유틸리티
│       ├── logger.py
│       ├── formatting.py
│       ├── data_loader.py       # CSV 로딩 통합
│       ├── cli_helpers.py       # 예외 처리 데코레이터
│       └── parallel_executor.py # 병렬 처리
├── data/raw/          # CSV 저장소
└── results/           # 분석 결과
```

---

## 아키텍처 원칙

### 1. 계층 분리 원칙

프로젝트는 명확한 2계층 구조를 따릅니다:

**CLI 계층** (`scripts/`):

- 사용자 인터페이스 제공
- argparse로 명령행 인자 파싱
- 로거 초기화
- `@cli_exception_handler` 데코레이터로 예외 처리
- 비즈니스 로직 호출
- 종료 코드 반환 (0=성공, 1=실패)

**비즈니스 로직 계층** (`src/qbt/`):

- 핵심 도메인 로직 구현
- 데이터 검증 및 변환
- **ERROR 로그 금지** (CLI에서만 로깅)
- 예외는 `raise`로 전파

### 2. 상수 관리 (2계층)

**공통 상수** (`common_constants.py`): 모든 도메인에서 공유하는 공통 상수

- 경로 상수 (디렉토리, 데이터 파일, 결과 파일)
- 데이터 상수 (컬럼명, 연간 영업일 수 등)

**도메인 상수** (`도메인/constants.py`): 각 도메인 전용 비즈니스 로직 상수

- 백테스트 파라미터 (초기 자본, 슬리피지, 그리드 서치 범위 등)
- 시뮬레이션 기본값 (레버리지 배율, 비용 모델 파라미터 등)

**원칙**: 상수 중복 금지 - 계층 간 중복 정의 시 즉시 통합

### 3. 핵심 패턴

#### CSV 데이터 로딩

- **중앙 집중식**: `utils/data_loader.py`에서 모든 CSV 로딩
- 로딩 시 자동 전처리 (날짜 파싱, 정렬, 중복 제거)
- 순환 임포트 방지

#### CLI 예외 처리

- **데코레이터 패턴**: `@cli_exception_handler` 사용
- 자동 로거 감지
- 스택 트레이스 포함
- try-except 블록 불필요

#### 데이터 검증

- 다운로드 시 엄격한 검증 (결측치, 0값, 음수, 급등락)
- **보간 금지**: 이상 발견 시 즉시 예외
- 검증 통과 후에만 저장

#### 병렬 처리

- **중앙 집중식**: `utils/parallel_executor.py` 모듈 사용
- ProcessPoolExecutor 기반 CPU 집약적 작업 병렬화
- 입력 순서 보장된 결과 반환
- 단일 인자 함수용, 키워드 인자 함수용 두 가지 제공
- Windows 환경 대응 (pickle 가능한 함수만 사용)

---

## 코딩 표준

### 필수 규칙

**타입 안정성**:

- 모든 함수에 타입 힌트 필수
- Optional 타입은 `|` 문법 사용 (예: `str | None`, `int | None`)
- 여러 타입 허용 시에도 `|` 사용 (예: `int | float`, `Path | str`)

**파일 처리**:

- Path 객체만 사용 (문자열 경로 금지)

**문서화**:

- Google 스타일 Docstring
- 한글 작성
- 복잡한 로직은 넘버링 주석

**네이밍**:

- 함수/변수: `snake_case`
- 클래스: `PascalCase`
- 상수: `UPPER_SNAKE_CASE`

**포맷팅**:

- Black 자동 포맷팅 (에디터 설정)
- 수동 실행 금지

### 로깅 정책

**레벨 사용**:

- DEBUG: 실행 흐름, 데이터 처리 상태
- WARNING: 잠재적 문제 상황
- ERROR: CLI 계층에서만 사용

**금지 사항**:

- INFO 레벨 사용 금지 (일반 정보는 DEBUG 사용)
- 이모지 사용 금지
- 함수명 중복 기재 금지 (로그 포맷에 자동 포함)

**테이블 출력**:

- 한글/영문 혼용 시 터미널 폭 정확 계산 (한글=2칸)
- `TableLogger` 클래스 사용
- 컬럼 정의 (이름, 폭, 정렬) → 인스턴스 생성 → 데이터 출력

### 테스트

- AI는 테스트 작성만 가능, 실행은 불가
- 사용자가 직접 실행
- 테스트 코드도 동일한 품질 기준 적용

---

## 데이터 처리 규칙

### CSV 파일명 규칙

- `{TICKER}_max.csv`: 전체 기간
- `{TICKER}_{START}_{END}.csv`: 기간 지정
- `{TICKER}_{START}_latest.csv`: 시작일만
- `{TICKER}_synthetic_max.csv`: 합성 데이터

### 데이터 로딩 (utils/data_loader.py)

모든 CSV 로딩은 이 모듈을 통해 수행:

1. 파일 존재 확인
2. CSV 읽기
3. 필수 컬럼 검증
4. 날짜 파싱
5. 정렬
6. 중복 제거
7. DataFrame 반환

### 데이터 검증 (다운로드 시)

- 결측치, 0값, 음수값, 급등락 검사
- 보간 금지
- 즉시 커스텀 예외 발생
- 검증 통과 시에만 저장

### 데이터 정제

- 최근 일정 기간 제외 (데이터 소스 안정성 고려)
- 날짜는 `date` 객체로 통일
- 가격 정밀도는 소수점 자리 통일

---

## 도메인별 개요

> 이 섹션은 각 도메인의 간략한 소개입니다.
> **특정 도메인의 파일을 작업할 때만** 해당 도메인의 CLAUDE.md를 참고하세요.

### 백테스트 도메인 (`src/qbt/backtest/`)

**핵심 개념**:

- 이동평균 기반 거래 전략 실행
- 버퍼존을 활용한 신호 생성
- 동적 파라미터 조정
- 벤치마크 비교

**주요 특징**:

- 단방향 포지션 (롱 온리)
- 익일 시가 체결
- 거래 비용 반영
- 그리드 서치 기반 최적화

**이 도메인 작업 시**: [`src/qbt/backtest/CLAUDE.md`](src/qbt/backtest/CLAUDE.md) 참고

### 레버리지 ETF 시뮬레이션 도메인 (`src/qbt/tqqq/`)

**핵심 개념**:

- 일일 리밸런싱 시뮬레이션
- 동적 비용 모델 (시장 금리 기반)
- 복리 효과 반영
- 실제 데이터 검증

**주요 특징**:

- 기초 자산 기반 합성 데이터 생성
- 비용 파라미터 최적화
- 실제 vs 시뮬레이션 비교
- 대화형 대시보드

**이 도메인 작업 시**: [`src/qbt/tqqq/CLAUDE.md`](src/qbt/tqqq/CLAUDE.md) 참고

### CLI 스크립트 계층 (`scripts/`)

**핵심 책임**:

- 사용자 인터페이스 제공
- 실행 환경 설정
- 예외 처리 및 로깅
- 결과 표시

**이 계층 작업 시**: [`scripts/CLAUDE.md`](scripts/CLAUDE.md) 참고

### 유틸리티 패키지 (`src/qbt/utils/`)

**핵심 기능**:

- 공통 로깅 인프라
- CSV 데이터 로딩 통합
- 병렬 처리 프레임워크
- 터미널 출력 포맷팅

**이 패키지 작업 시**: [`src/qbt/utils/CLAUDE.md`](src/qbt/utils/CLAUDE.md) 참고

---

## 개발 원칙

1. **YAGNI**: 필요성이 확인될 때 구현
2. **간결성**: 불필요한 추상화 지양
3. **확장성**: 도메인별 모듈 독립성 유지
4. **사용자 중심**: 한글 메시지, 명확한 오류 정보
