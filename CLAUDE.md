# Claude Code Guidelines for QBT Project

## 문서 작성 가이드

이 문서(CLAUDE.md) 자체를 업데이트할 때 지켜야 할 규칙입니다.

### 업데이트 원칙

- **소스코드 직접 언급 금지**: 특정 파일명, 함수명, 클래스명 등을 직접 언급하지 않습니다
  - 잘못된 예: "`download_stock_data()` 함수는..."
  - 올바른 예: "데이터 다운로드 함수는..."
- **일반적 표현 사용**: 구체적 수치나 구현 세부사항 대신 일반적 표현을 사용합니다
  - 잘못된 예: "5회 재시도 후..."
  - 올바른 예: "임계값 초과 시 재시도..."
- **예시 제공 권장**: 추상적인 규칙은 구체적인 예시와 함께 설명합니다
- **간결성 유지**: 불필요한 반복이나 장황한 설명을 피합니다

## 프로젝트 개요

QBT(Quant BackTest)는 주식 데이터 다운로드 및 백테스팅을 위한 Python CLI 도구입니다.

**주요 기능**:
- Yahoo Finance에서 주식 데이터 다운로드
- 이동평균선 교차 전략 백테스트 (SMA/EMA)
- 파라미터 그리드 서치
- 워킹 포워드 테스트

### 핵심 디렉토리 구조

```
quant/
├── scripts/                 # CLI 실행 스크립트
│   ├── download_data.py     # 데이터 다운로드
│   ├── run_single_backtest.py  # 단일 백테스트
│   ├── run_grid_search.py   # 그리드 서치
│   └── run_walkforward.py   # 워킹 포워드 테스트
├── src/qbt/                 # 비즈니스 로직 패키지
│   ├── backtest/           # 백테스트 도메인
│   │   ├── config.py       # 설정 상수
│   │   ├── data.py         # 데이터 로딩/검증
│   │   ├── strategy.py     # 전략 실행 로직
│   │   ├── metrics.py      # 성과 지표 계산
│   │   └── report.py       # 리포트 생성
│   └── utils/              # 유틸리티
│       ├── logger.py       # 로깅 설정
│       └── cli.py          # CLI 공통 함수
├── data/raw/               # CSV 데이터 저장소
└── pyproject.toml          # Poetry 프로젝트 설정
```

### 기술 스택

- **Python**: 3.10 이상 (Union 타입 구문 `str | None` 사용)
- **패키지 관리**: Poetry
- **데이터 처리**: pandas
- **데이터 소스**: Yahoo Finance (yfinance)
- **코드 품질**: Black (포맷터), Ruff (린터)

## 아키텍처 설계

### CLI 계층 구조

QBT는 단순한 2계층 구조를 사용합니다:

#### CLI Layer (scripts/)
- **로거 초기화**: 환경 변수를 읽어 로거 설정
- **커맨드 파싱**: argparse로 사용자 입력 처리
- **비즈니스 로직 호출**: 공통 유틸리티를 통해 데이터 로딩 및 검증
- **최종 예외 처리**: try-except로 모든 예외를 캐치하여 사용자 친화적 에러 메시지 출력
- **종료 코드 반환**: 성공 시 0, 실패 시 1

#### Business Logic Layer (src/qbt/)
- **핵심 기능 수행**: 데이터 로딩, 전략 실행, 지표 계산 등
- **데이터 검증**: 입력값 유효성 검사
- **예외 재발생**: 에러 발생 시 로깅 없이 `raise`로 호출자에게 예외 전파
- **명시적 예외**: 가능한 경우 구체적인 예외 타입 사용

**중요**: 비즈니스 로직에서는 ERROR 레벨 로그를 남기지 않습니다. 에러 로깅은 CLI Layer에서만 수행하여 중복을 방지합니다.

### 패키지 구조

- **패키지 형식**: `src/qbt/domain/module.py`로 도메인별 구분
- **모듈 분리**: 기능별로 모듈 분리 (데이터, 전략, 지표, 리포트)
- **CLI 로직**: `scripts/` 디렉토리에 독립 스크립트로 위치
- **비즈니스 로직**: `src/qbt/` 패키지 내부에 위치

### 백테스트 모듈 구조

- **data.py**: 데이터 로딩 및 검증 함수
- **strategy.py**: 전략 실행 (이동평균, 그리드 서치, 워킹 포워드)
- **metrics.py**: 성과 지표 계산 (수익률, CAGR, MDD 등)
- **config.py**: 공용 상수 및 기본값 정의
- **report.py**: 결과 저장 및 HTML 리포트 생성

## 코딩 규칙

### 코드 포맷팅

- **코드 포맷터**: Black 사용. 모든 Python 코드는 Black 스타일을 따릅니다
  - **별도로 `black` 명령어를 실행하지 마세요**
- **린터**: Ruff 사용 (pycodestyle, pyflakes, isort, flake8-bugbear, pyupgrade 포함)
- **라인 길이**: 88자 (Black 기본값)
- **타겟 버전**: Python 3.10+

### 네이밍 컨벤션

- **함수**: `snake_case`
- **클래스**: `PascalCase`
- **상수**: `UPPER_SNAKE_CASE`
- **Private 멤버**: `_leading_underscore`

### 타입 힌트

- **필수 적용**: 모든 함수 시그니처에 타입 힌트 작성
- **Python 3.10+ 문법 사용**: `str | None` (Union 타입)

### 문서화

- **Docstring**: 모든 public 함수와 클래스에 Google 스타일 docstring 작성
- **언어**: 한글로 작성 (사용자 대상 프로젝트)
- **필수 항목**: Args, Returns, Raises (해당하는 경우)
- **이모지 금지**: 코드, 주석, 문서 등 모든 곳에서 이모지 사용을 피합니다

### 주석 작성 규칙

- **복잡한 로직**: 여러 단계의 처리 흐름이 있을 경우 넘버링 주석으로 단계별 설명
- **주석 업데이트**: 코드 수정 시 관련 주석도 함께 업데이트하여 불일치 방지
- **일반적 표현 사용**: 구체적 수치 대신 일반적 표현 사용 (예: "5회 재시도" → "임계값 초과 시 재시도")

### 파일 경로 처리

- **pathlib.Path 필수**: 모든 파일 작업에 `pathlib.Path` 사용, 문자열 경로 금지
- **하드코딩 금지**: 프로젝트 루트 기준 상대 경로 사용

## 도메인별 규칙

### 로깅 정책

#### 로그 레벨

QBT 프로젝트는 **세 가지 로그 레벨만** 사용합니다:

- **DEBUG**: 개발 중 상세 정보 및 디버깅 메시지
  - 데이터 처리 과정
  - 변수 값 확인
  - 함수 실행 흐름
- **WARNING**: 경고성 메시지
  - 잠재적 문제 상황
  - 권장하지 않는 사용법
- **ERROR**: 에러 발생 시 (CLI Layer에서만 사용)
  - 예외 처리
  - 치명적 오류

**INFO 레벨은 사용하지 않습니다.** 일반 정보는 DEBUG로 처리합니다.

#### 로깅 가이드라인

- **메시지는 한글로 작성**: 사용자 대상 프로젝트이므로 한글 사용
- **이모지 사용 금지**: 로그 메시지에 이모지 포함하지 않음
- **간결하고 명확하게**: 불필요한 장황한 설명 지양
- **함수명 자동 포함**: 로그 포맷에 `funcName`이 포함되므로 메시지에 중복 기재 불필요

### 데이터 처리

#### CSV 데이터 저장

- **위치**: `data/raw/` 디렉토리
- **파일명 규칙**:
  - `{TICKER}_max.csv` (전체 기간)
  - `{TICKER}_{START}_{END}.csv` (기간 지정)
  - `{TICKER}_{START}_latest.csv` (시작일만 지정)
- **저장 컬럼**: Date, Open, High, Low, Close, Volume

#### 데이터 정제

- **최근 데이터 제외**: 오늘 기준 2일 전까지만 포함 (Yahoo Finance 데이터 안정성 확보)
- **날짜 형식**: Python `date` 객체로 변환
- **데이터 검증**: 결측치, 0값, 음수값, 급등락 체크

### 백테스트

#### 전략 규칙

- **롱 온리**: 매수만 가능, 공매도 불가
- **최대 1 포지션**: 한 번에 하나의 포지션만 보유
- **익일 시가 진입/청산**: 신호 발생 다음 날 시가에 거래 실행
- **거래 비용**: 슬리피지만 적용, 수수료는 매수 가능 수량 계산 시에만 감안

#### 손절 규칙

- **하드 스톱**: 진입가 대비 고정 비율 손절
- **트레일링 스톱**: 최근 저점 기반 손절
- **손절 가격**: 두 값 중 높은 값 적용

## 개발 철학

QBT 프로젝트는 다음 철학을 따릅니다:

### 1. YAGNI (You Aren't Gonna Need It)

- **사용하지 않는 코드는 미리 만들지 말 것**
- **필요할 때 추가**: 기능은 실제 필요성이 확인된 후에만 구현
- **향후 계획**: 주석으로 임시 처리 가능

### 2. 간결성과 단순성

- **간결한 코드베이스 유지**: 불필요한 추상화 지양
- **명확한 의도**: 복잡한 패턴보다 읽기 쉬운 코드 우선
- **점진적 발전**: 작은 단위로 기능 추가 및 리팩토링

### 3. 확장성

- 도메인별 모듈 분리로 기능 추가 용이
- 새로운 도메인은 `src/qbt/` 아래에 패키지 생성

### 4. 사용자 중심

- 한글 메시지 제공
- 직관적인 CLI 인터페이스
- 명확한 에러 메시지
