````md
# TQQQ 시뮬레이션 검증 CSV 리팩토링 요구사항

## 1. 전체 목표

- QQQ 기반 TQQQ 시뮬레이션 결과를 **최소한의 핵심 지표**로 정리한 CSV를 만든다.
- **`strategy_score`는 제거**하고,  
  **`누적수익률_상대차이_pct` 기준 오름차순 정렬**로 “좋은 전략 → 나쁜 전략” 순서를 만든다.
- **`누적수익률_상대차이_pct`로 컷(필터링)은 하지 않는다.**  
  → 모든 전략을 남기고 **정렬만** 한다.
- **서로 거의 일직선 상관관계인(강하게 중복되는) 지표들은 제거**하고,  
  각 영역(일일수익률 / 가격 / 누적수익률)에서 **평균·최대치 중심의 대표 지표만** 남긴다.

---

## 2. 입력 / 출력 정의

### 2.1 입력

- 입력 CSV: 기존 `tqqq_validation.csv`
- 주요 가정:
  - 컬럼 이름은 현재 CSV와 동일하게 사용:
    - 예: `누적수익률_상대차이_pct`, `일별가격_평균차이_pct`, `일일수익률_RMSE_pct` 등

### 2.2 출력

- 출력 CSV: 예) `tqqq_validation_refined.csv`
- 역할:
  - **핵심 메타 정보 + 핵심 지표만 남긴 버전**
  - **정렬 기준:** `누적수익률_상대차이_pct` 오름차순
  - 필요 시 상단에 `rank` 컬럼을 재계산해서 1부터 부여

---

## 3. 처리 순서(알고리즘 개요)

1. **CSV 로드**
   - 기존 `tqqq_validation.csv`를 읽는다.

2. **불필요 / 중복 지표 제거**
   - 아래 “제거할 컬럼 리스트”에 있는 컬럼들을 데이터에서 제거한다.
   - 이 단계에서 **중복 의미의 지표(상관관계가 거의 일직선인 지표)**를 정리한다.

3. **정렬 기준 적용**
   - `누적수익률_상대차이_pct` 기준으로 **오름차순 정렬**한다.
   - **주의:**  
     - **어떤 행도 필터링하지 않는다.**  
       (예: “3% 이하만 남긴다” 같은 컷을 하지 않는다.)
     - 단지 정렬만 수행한다.

4. **순위(rank) 재계산 (선택 사항이지만 권장)**
   - 정렬된 순서대로 **1부터 시작하는 정수 rank**를 재부여한다.
   - 기존 `rank`가 있다면 덮어쓰거나,  
     필요하다면 `old_rank`로 복사해두고 새로운 `rank`를 만든다.

5. **최종 CSV 저장**
   - 아래 “최종적으로 포함할 컬럼 리스트” 순서대로 컬럼을 정리해 CSV로 저장한다.

---

## 4. 지표 선택 원칙(설계 철학)

1. **정렬 기준 지표**
   - `누적수익률_상대차이_pct`  
     → “전체 검증 기간이 끝났을 때 시뮬 누적수익률이 실제 TQQQ와 얼마나 비슷한지”를 보여주는 핵심 지표  
     → **정렬에만 사용**, 컷 필터는 하지 않는다.

2. **누적수익률/성과 계열**
   - 남길 지표:
     - `누적수익률_실제_pct`  
       → 실제 TQQQ의 검증 기간 동안 누적수익률
     - `누적수익률_시뮬레이션_pct`  
       → 시뮬레이션 TQQQ의 누적수익률
     - `누적수익률_상대차이_pct`  
       → 최종 결과의 상대 오차 (%). **정렬 기준**
     - `누적수익률_RMSE_pct`  
       → 기간 전체에서 누적수익률 경로의 평균 오차 (root mean squared error)
     - `누적수익률_최대오차_pct`  
       → 기간 전체에서 누적수익률 경로의 최악의 오차(최대 절대값)
   - 제거할 지표:
     - `누적수익률_차이_pct`  
       → 상대차이와 거의 같은 정보를 담고 있어 중복
     - `최종가격_차이_pct`  
       → 최종 성과 측면에서 `누적수익률` 관련 지표들과 강하게 중복

3. **일별 가격(레벨) 계열**
   - 남길 지표:
     - `일별가격_평균차이_pct`  
       → 전체 기간 동안 일별 가격의 평균 오차 (%)
     - `일별가격_최대차이_pct`  
       → 전체 기간 동안 일별 가격의 최대 오차 (%)
   - 제거할 지표:
     - `로그가격_RMSE`  
       → `일별가격_평균차이_pct`와 매우 높은 상관관계, 의미가 거의 겹치므로 제거
     - `로그가격_최대오차`  
       → `일별가격_최대차이_pct`와 의미가 강하게 중복되므로 제거

4. **일일 수익률 계열**
   - 남길 지표:
     - `일일수익률_RMSE_pct`  
       → 일일 수익률 오차의 대표적인 평균 지표 (RMSE)
     - `일일수익률_최대오차_pct`  
       → 일일 수익률이 가장 많이 어긋난 하루의 오차 (최대 절대값)
   - 제거할 지표:
     - `일일수익률_상관계수`  
       → 거의 값이 고정 수준이며, 다른 지표와 실질적인 변별력을 주지 못하므로 제거
     - `일일수익률_평균차이_pct`, `일일수익률_MAE_pct`  
       → `일일수익률_RMSE_pct`와 매우 유사한 의미의 평균 오차 지표들 → 대표 지표(RMSE)만 남기고 제거
     - `일일수익률_표준편차차이_pct`  
       → 변동성 스케일 차이만 보는 지표로, 현재 목적(레버리지/비용 구조 캘리브레이션)에서는 우선순위가 낮으므로 제거

5. **전략 스코어 계열**
   - 제거할 지표:
     - `strategy_score`  
       - 내부적으로 여러 지표를 가중 합한 값으로,  
         현재 설계에서는 **직접 지표들을 보고 판단**하므로 필요 없음.
       - `누적수익률_상대차이_pct` 등과 거의 일직선 상관관계 → 중복.

6. **메타 정보**
   - 남길 메타 컬럼:
     - `rank` (재계산된 최종 순위)
     - `검증기간_시작`
     - `검증기간_종료`
     - `총일수`
     - `leverage`
     - `funding_spread`
     - `expense_ratio`

---

## 5. 최종적으로 포함할 컬럼 리스트 (예시)

아래 컬럼들만 남겨서 최종 CSV를 생성한다.  
(순서는 필요에 따라 약간 조정 가능하지만, 기본적으로 다음 순서를 권장)

1. 메타 정보
   - `rank`  
   - `검증기간_시작`  
   - `검증기간_종료`  
   - `총일수`  
   - `leverage`  
   - `funding_spread`  
   - `expense_ratio`  

2. 누적수익률 / 최종 성과 관련
   - `누적수익률_실제_pct`  
   - `누적수익률_시뮬레이션_pct`  
   - `누적수익률_상대차이_pct`  ← **정렬 기준 컬럼**  
   - `누적수익률_RMSE_pct`  
   - `누적수익률_최대오차_pct`  

3. 일별 가격(레벨) 관련
   - `일별가격_평균차이_pct`  
   - `일별가격_최대차이_pct`  

4. 일일 수익률 관련
   - `일일수익률_RMSE_pct`  
   - `일일수익률_최대오차_pct`  

### 5.1 최종 CSV 헤더 예시

> 실제 구현 시 참고용 예시이며, 컬럼 구분자는 상황에 맞게 사용  
> (쉼표 기준 예시)

```text
rank,
검증기간_시작,
검증기간_종료,
총일수,
leverage,
funding_spread,
expense_ratio,
누적수익률_실제_pct,
누적수익률_시뮬레이션_pct,
누적수익률_상대차이_pct,
누적수익률_RMSE_pct,
누적수익률_최대오차_pct,
일별가격_평균차이_pct,
일별가격_최대차이_pct,
일일수익률_RMSE_pct,
일일수익률_최대오차_pct
````

---

## 6. CSV에서 제거할 컬럼 리스트 (참고용)

아래 컬럼들은 **새로운 CSV에서는 포함하지 않는다.**

* `strategy_score`
* `일일수익률_상관계수`
* `일일수익률_평균차이_pct`
* `일일수익률_표준편차차이_pct`
* `일일수익률_MAE_pct`
* `로그가격_RMSE`
* `로그가격_최대오차`
* `누적수익률_차이_pct`
* `최종가격_차이_pct`
* `검증일`

---

## 7. 구현 시 핵심 체크 포인트

* **정렬만** `누적수익률_상대차이_pct` 기준으로 수행하고,
  **컷/필터링은 하지 않는다.**
* `strategy_score` 및 중복 지표는 **계산·사용·출력 모두 하지 않는다.**
* 최종 CSV만 보면,

  * “최종 성과가 얼마나 비슷한가” (`누적수익률_상대차이_pct`)
  * “누적 경로 오차(평균/최대)” (`누적수익률_RMSE_pct`, `누적수익률_최대오차_pct`)
  * “가격 경로 오차(평균/최대)” (`일별가격_평균차이_pct`, `일별가격_최대차이_pct`)
  * “일일 수익률 오차(평균/최대)” (`일일수익률_RMSE_pct`, `일일수익률_최대오차_pct`)
    를 한눈에 비교할 수 있도록 설계한다.

