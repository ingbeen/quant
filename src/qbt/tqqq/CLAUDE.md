# 레버리지 ETF 시뮬레이션 도메인 가이드

> 이 문서는 `src/qbt/tqqq/` 패키지의 레버리지 ETF 시뮬레이션 도메인에 대한 상세 가이드입니다.
> 프로젝트 전반의 공통 규칙은 [루트 CLAUDE.md](../../../CLAUDE.md)를 참고하세요.

## 도메인 목적

레버리지 ETF 시뮬레이션 도메인은 기초 자산 데이터로부터 레버리지 상품의 가격을 모델링하고,
실제 데이터와 비교하여 비용 모델의 정확도를 검증합니다.

---

## 스크립트 실행 순서

TQQQ 시뮬레이션 관련 스크립트는 다음 순서로 실행합니다:

1. **validate_tqqq_simulation.py**: 최적 비용 모델 파라미터 탐색
2. **generate_tqqq_daily_comparison.py**: 일별 비교 데이터 생성
3. **generate_synthetic_tqqq.py**: 합성 데이터 생성 (QQQ 전체 기간)

**중요**:

- `generate_synthetic_tqqq.py`는 QQQ의 가장 빠른 시작일부터 자동으로 데이터를 생성
- `generate_tqqq_daily_comparison.py`는 실제 TQQQ와 겹치는 기간만 비교
- 모든 파라미터는 `constants.py`에서 상수로 정의됨

---

## 모듈 구성

### 1. simulation.py

레버리지 ETF 시뮬레이션 엔진을 제공합니다.

**일일 리밸런싱 모델**:

- 매일 목표 레버리지 배율로 포지션 재조정
- 기초 자산의 수익률에 배율 적용
- 복리 효과 반영

**동적 비용 모델**:

- 시장 금리 기반 자금 조달 비용
- 운용 비용 (expense ratio)
- 일별 비용 계산 및 누적 반영

**비용 모델 최적화**:

- 그리드 탐색: 다차원 파라미터 공간 탐색
- 병렬 처리로 성능 최적화
- 실제 데이터와의 오차 기반 평가

**정확도 검증**:

- 일별 비교: 실제 가격 vs 시뮬레이션 가격
- 일일 수익률 차이
- 누적배수 로그차이 (스케일 무관 추적오차)

**오차 분석**:

- 누적배수 로그차이: 첫날 기준 누적 자산배수의 로그 비율
- 스케일 무관성: 금액과 무관하게 비율 동일
- 금융 표준: 연속 복리 수익률 차이 개념
- 평균, RMSE, 최댓값으로 정확도 평가

### 2. streamlit_app.py (scripts/tqqq/)

대시보드는 별도 스크립트로 분리되어 `scripts/tqqq/streamlit_app.py`에 위치합니다.

**가격 비교 차트**:

- 시계열 라인 차트
- 실제 vs 시뮬레이션 겹쳐 표시
- 인터랙티브 호버 정보

**오차 분석 차트**:

- 히스토그램
- 시계열 오차 추이
- 통계 요약

---

## 도메인 규칙

### 시뮬레이션 규칙

**레버리지 배율**:

- 목표 레버리지 배율 적용 (TQQQ는 3배)
- 일일 수익률에 배율 적용
- 구체적 값은 `constants.py`의 `DEFAULT_LEVERAGE_MULTIPLIER` 참고

**비용 구조**:

- 자금 조달 비용 = (기준 금리 + 스프레드) × 레버리지 차입 비율
- 운용 비용 = 연간 비율을 일별로 환산 (연간 거래일 수 기준)
- 총 비용 = 자금 조달 비용 + 운용 비용
- 기본 스프레드와 비용 비율은 `constants.py` 참고

**가격 계산**:

- 전일 종가 기준
- 기초 자산 일일 수익률 계산
- 레버리지 배율 적용
- 일일 비용 차감
- 신규 종가 산출

### 데이터 요구사항

**기초 자산 데이터**:

- OHLCV (시가, 고가, 저가, 종가, 거래량)
- 날짜순 정렬
- 결측치 없음

**금리 데이터**:

- 월별 기준 금리 (Federal Funds Rate)
- 최근 데이터와의 시간 차이 검증
- 허용 가능한 갭은 `constants.py`의 `MAX_FFR_MONTHS_DIFF` 참고

**실제 레버리지 상품 데이터**:

- 검증을 위한 실제 가격 (예: TQQQ)
- 기초 자산과 기간 일치 필요

### 검증 임계값

**비용 파라미터 범위**:

- 운용 비용 상한선 존재
- 그리드 서치 스프레드 범위 정의
- 구체적 범위는 `constants.py` 참고

**금리 데이터 갭**:

- 허용 가능한 최대 월 차이 검증
- 초과 시 즉시 예외 발생
- `MAX_FFR_MONTHS_DIFF` 상수 사용

---

## 핵심 계산 로직

### 누적배수 로그차이 계산

**목적**: 스케일에 무관한 추적오차 측정

**수식**:

```
M_actual(t) = actual_close(t) / actual_close(0)  # 누적 자산배수
M_sim(t) = simul_close(t) / simul_close(0)
로그차이(%) = |ln(M_actual(t) / M_sim(t))| × 100
```

**특징**:

- 첫날 가격 기준 누적배수 사용
- 로그 비율로 스케일 무관성 확보
- 롤링 윈도우 미사용 (안정성 향상)
- 금융 표준 방법 (연속 복리 수익률 차이)

**구현 세부사항**:

- 수치 안정성: `EPSILON = 1e-12` 사용
- `np.maximum(ratio, EPSILON)`으로 분모 0 방지
- `pd.Series` 타입 보장 (인덱스 보존)

**함수**: `_calculate_cumul_multiple_log_diff()` (simulation.py)

---

## 구현 원칙

### 합성 데이터 생성

**초기화**:

- 기초 자산의 시작 가격으로부터 역산
- 초기 레버리지 상품 가격 설정

**일별 갱신**:

- 기초 자산 수익률 계산
- 레버리지 적용
- 비용 차감
- 가격 업데이트

**OHLCV 추정**:

- 종가 기준으로 시가/고가/저가 생성
- 거래량은 기초 자산 비율 적용

### 파라미터 탐색

**그리드 생성**:

- 범위와 증분으로 격자 생성
- 모든 조합 탐색

**병렬 처리**:

- 독립적인 시뮬레이션을 병렬 실행
- 입력 순서 보장
- 결과 정렬 및 필터링

**최적 전략 선택**:

- 오차 기반 순위 결정
- 상위 전략만 반환

### 대시보드 구현 (streamlit_app.py)

대시보드는 비즈니스 로직이 아닌 CLI 계층으로 분리되어 `scripts/tqqq/streamlit_app.py`에 위치합니다.

**데이터 캐싱**:

- Streamlit 캐시 데코레이터로 반복 로딩 방지
- 성능 최적화

**차트 생성**:

- Plotly 기반 인터랙티브 차트
- 상태 비저장 함수 방식

**검증**:

- 필수 컬럼 확인
- 결측치 처리

---

## 출력 형식

### 합성 데이터

- 기초 자산과 동일한 OHLCV 형식
- 날짜 정렬
- CSV 저장

### 일별 비교 데이터

- 날짜별 실제/시뮬 가격
- 일일 수익률 및 차이
- 누적 수익률
- 누적배수 로그차이 (스케일 무관 추적오차)
- 한글 컬럼명

### 검증 결과

- 통계 요약 (평균, 표준편차, 최대/최소 오차)
- 시각화 차트

### 최적화 결과

- 파라미터 조합별 오차
- 상위 전략 리스트
- CSV 저장

---

## CSV 파일 형식

### tqqq_daily_comparison.csv (일별 비교)

**경로**: `storage/results/tqqq_daily_comparison.csv`

**컬럼** (9개):

1. `날짜`: 거래일
2. `종가_실제`: 실제 TQQQ 종가
3. `종가_시뮬`: 시뮬레이션 종가
4. `일일수익률_실제`: 실제 일일 수익률 (%)
5. `일일수익률_시뮬`: 시뮬레이션 일일 수익률 (%)
6. `일일수익률_절대차이`: 일일 수익률 차이 절댓값
7. `누적수익률_실제(%)`: 실제 누적 수익률
8. `누적수익률_시뮬레이션(%)`: 시뮬레이션 누적 수익률
9. `누적배수_로그차이(%)`: **스케일 무관 추적오차 지표**

**용도**: 대시보드 시각화, 일별 성과 분석

### tqqq_validation.csv (그리드 서치 결과)

**경로**: `storage/results/tqqq_validation.csv`

**컬럼** (10개):

1. `funding_spread`: 자금 조달 스프레드 (소수, 예: 0.004 = 0.4%)
2. `expense_ratio`: 연간 운용 비용 비율 (소수, 예: 0.008 = 0.8%)
3. `종가_실제`: 실제 TQQQ 마지막 날 종가
4. `종가_시뮬`: 시뮬레이션 마지막 날 종가
5. `누적수익률_실제(%)`: 실제 TQQQ 전체 기간 누적 수익률
6. `누적수익률_시뮬레이션(%)`: 시뮬레이션 전체 기간 누적 수익률
7. `누적수익률_상대차이(%)`: 누적수익률 상대차이 (실제 기준, `= ((누적수익률_시뮬 - 누적수익률_실제) / 누적수익률_실제) × 100`)
8. `누적배수로그차이_RMSE(%)`: **RMSE 로그 추적오차** (최적화 기준, 낮을수록 우수)
9. `누적배수로그차이_평균(%)`: 평균 로그 추적오차 (보조 지표)
10. `누적배수로그차이_최대(%)`: 최대 로그 추적오차 (최악 시점 이탈 정도)

**메타 정보** (터미널 헤더에만 표시, CSV에는 미포함):

- 검증 기간 (시작일 ~ 종료일)
- 총 거래일 수
- 레버리지 배율 (고정: 3.0)

**용도**: 최적 비용 모델 파라미터 선정, 성능 벤치마킹

**정렬 기준**: `누적배수로그차이_RMSE(%)` 오름차순 (낮을수록 경로 전체 추적이 우수)

**삭제된 컬럼**:

- `rank`: 정렬 순서로 충분 (첫 행이 최적 파라미터)
- `종가_상대차이(%)`: 단일 시점 지표로 경로 추적에 부적합
