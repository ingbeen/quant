# Implementation Plan: 테스트 Expense 값 수정 (0.95% 통일)

> 작성/운영 규칙(SoT): 반드시 [docs/CLAUDE.md](../CLAUDE.md)를 참고하세요.
> (이 템플릿을 수정하거나 새로운 양식의 계획서를 만들 때도 [docs/CLAUDE.md](../CLAUDE.md)를 포인터로 두고 준수합니다.)

**상태**: ✅ Done

---

🚫 **이 영역은 삭제/수정 금지** 🚫

**상태 옵션**: 🟡 Draft / 🔄 In Progress / ✅ Done

**Done 처리 규칙**:

- ✅ Done 조건: DoD 모두 [x] + `skipped=0` + `failed=0`
- ⚠️ **스킵이 1개라도 존재하면 Done 처리 금지 + DoD 테스트 항목 체크 금지**
- 상세: [docs/CLAUDE.md](../CLAUDE.md) 섹션 3, 5 참고

---

**작성일**: 2025-12-29 21:07
**마지막 업데이트**: 2025-12-29 21:12
**관련 범위**: tests
**관련 문서**:
- tests/CLAUDE.md
- src/qbt/tqqq/CLAUDE.md

---

## 0) 고정 규칙 (이 plan은 반드시 아래 규칙을 따른다)

> 🚫 **이 영역은 삭제/수정 금지** 🚫
> 이 섹션(0)은 지워지면 안 될 뿐만 아니라 **문구가 수정되면 안 됩니다.**
> 규칙의 상세 정의/예외는 반드시 [docs/CLAUDE.md](../CLAUDE.md)를 따릅니다.

- Validation에서 `poetry run ruff check .` 또는 `./run_tests.sh`가 실패하면 **해당 Phase에서 즉시 수정 후 재검증**한다.
- Phase 0은 "레드(의도적 실패 테스트)" 허용, Phase 1부터는 **그린 유지**를 원칙으로 한다.
- 이미 생성된 plan은 **체크리스트 업데이트 외 수정 금지**한다.
- 스킵은 가능하면 **Phase 분해로 제거**한다.

---

## 1) 목표(Goal)

- [x] 목표 1: `test_tqqq_simulation.py`의 모든 Expense 값을 실제 TQQQ 수준인 `0.0095` (0.95%)로 통일
- [x] 목표 2: 부동소수점 과학적 표기법(`8.999999999999999e-05`) 제거, 명확한 소수 표기로 변경
- [x] 목표 3: 관련 주석 및 예상 결과값 재계산하여 정확성 보장

## 2) 비목표(Non-Goals)

- 프로덕션 코드 수정 (비즈니스 로직 변경 없음)
- `conftest.py`의 픽스처 수정 (이미 `0.0095`로 올바르게 설정됨)
- 새로운 테스트 추가

## 3) 배경/맥락(Context)

### 현재 문제점 / 동기

**문제 1: 부정확한 Expense 값**
- 현재 `test_tqqq_simulation.py`에서 `0.00009` (0.009%) 사용
- 실제 TQQQ의 expense ratio는 약 0.95%
- `conftest.py`의 `sample_expense_df` 픽스처는 이미 `0.0095` (0.95%) 사용
- 테스트 데이터가 픽스처와 불일치하여 혼란 발생

**문제 2: 부동소수점 표기 문제**
- `8.999999999999999e-05`와 같은 과학적 표기법 사용 (12개 위치)
- 이는 `0.00009`의 부동소수점 표현
- 가독성 저하 및 의도 불명확

**문제 발생 배경**:
- `PLAN_csv_value_to_decimal.md` 실행 중 퍼센트 값을 소수로 변환하는 과정에서 발생
- 테스트에서 임의의 작은 값(`0.00009`)을 사용했으나, 실제와 차이가 큼

### 영향받는 규칙(반드시 읽고 전체 숙지)

> 아래 문서에 기재된 규칙을 **모두 숙지**하고 준수합니다.

- `CLAUDE.md` (루트)
- `tests/CLAUDE.md`
- `src/qbt/tqqq/CLAUDE.md`

## 4) 완료 조건(Definition of Done)

> Done은 "서술"이 아니라 "체크리스트 상태"로만 판단합니다. (정의/예외는 docs/CLAUDE.md)

- [x] 모든 Expense 값이 `0.0095` (0.95%)로 통일
- [x] 부동소수점 과학적 표기법 제거 완료
- [x] 관련 주석 수정 완료 (0.009% → 0.95%)
- [x] 예상 결과값 재계산 및 검증 완료
- [x] `./run_tests.sh` 통과 (failed=0, skipped=0; passed=154, failed=0, skipped=0)
- [x] `poetry run ruff check .` 통과
- [x] `poetry run black .` 실행 완료 (마지막 Phase에서 자동 포맷 적용)
- [x] plan 체크박스 최신화(Phase/DoD/Validation 모두 반영)

## 5) 변경 범위(Scope)

### 변경 대상 파일(예상)

**테스트 파일**:
- `tests/test_tqqq_simulation.py`
  - Line 46, 58: `test_normal_cost_calculation` - Expense 값 및 주석
  - Line 95, 129: fallback/empty 테스트 - 부동소수점 표기
  - Line 166, 217: leverage 2배/4배 테스트 - Expense 값 및 주석
  - Line 184, 235: 예상 결과 계산 주석
  - Line 273, 356, 522, 564, 625, 662, 693, 728, 764, 788: 기타 테스트 - 부동소수점 표기

### 데이터/결과 영향

- 테스트 예상값 변경: Expense가 `0.00009` → `0.0095`로 증가
  - 일일 비용 증가 (약 100배)
  - 테스트 검증 로직의 예상값 재계산 필요
- 테스트 로직 자체는 변경 없음 (비용 계산 공식 동일)

## 6) 단계별 계획(Phases)

### Phase 1 — Expense 값 및 주석 수정(그린 유지)

**작업 내용**:

- [x] `0.00009` (6개 위치) → `0.0095`로 수정
  - Line 46: 주석 `expense_ratio=0.00009 (0.009%)` → `expense_ratio=0.0095 (0.95%)`
  - Line 58: `"VALUE": [0.00009, 0.00009]` → `"VALUE": [0.0095, 0.0095]`
  - Line 166: `expense_ratio = 0.00009  # 0.009%` → `expense_ratio = 0.0095  # 0.95%`
  - Line 217: `expense_ratio = 0.00009  # 0.009%` → `expense_ratio = 0.0095  # 0.95%`

- [x] 부동소수점 과학적 표기법 (10개 위치) → `0.0095`로 수정
  - Line 95, 129, 273, 356, 522, 564, 625, 662, 693, 728, 764, 788
  - `8.999999999999999e-05` → `0.0095`

- [x] 관련 주석 수정
  - Line 46: `expense_ratio=0.00009 (0.009%)` → `expense_ratio=0.0095 (0.95%)`
  - Line 154: `expense_ratio=0.009 (0.9%)` → `expense_ratio=0.0095 (0.95%)`
  - Line 159: `총 연간 비용 = 0.051 + 0.009 = 0.06` → `총 연간 비용 = 0.051 + 0.0095 = 0.0605`
  - Line 160: `일일 비용 = 0.06 / 252` → `일일 비용 = 0.0605 / 252`
  - Line 184: `총 연간 비용 = 0.051 + 0.00009 = 0.05109` → `총 연간 비용 = 0.051 + 0.0095 = 0.0605`
  - Line 185: `일일 비용 = 0.05109 / 252 ≈ 0.0002027` → `일일 비용 = 0.0605 / 252 ≈ 0.0002401`
  - Line 205: `expense_ratio=0.009 (0.9%)` → `expense_ratio=0.0095 (0.95%)`
  - Line 210: `총 연간 비용 = 0.153 + 0.009 = 0.162` → `총 연간 비용 = 0.153 + 0.0095 = 0.1625`
  - Line 211: `일일 비용 = 0.162 / 252` → `일일 비용 = 0.1625 / 252`
  - Line 235: `총 연간 비용 = 0.153 + 0.00009 = 0.15309` → `총 연간 비용 = 0.153 + 0.0095 = 0.1625`
  - Line 236: `일일 비용 = 0.15309 / 252 ≈ 0.0006075` → `일일 비용 = 0.1625 / 252 ≈ 0.0006449`
  - Line 273: 주석 `0.9%` → `0.95%`

**Validation**:

- [x] `poetry run ruff check .`
- [x] `./run_tests.sh` (passed=154, failed=0, skipped=0)

---

### 마지막 Phase — 문서 정리 및 최종 검증

**작업 내용**:

- [x] `poetry run black .` 실행(자동 포맷 적용)
- [x] 변경 기능 및 전체 플로우 최종 검증
- [x] DoD 체크리스트 최종 업데이트 및 체크 완료
- [x] 전체 Phase 체크리스트 최종 업데이트 및 상태 확정

**Validation**:

- [x] `poetry run ruff check .`
- [x] `./run_tests.sh` (passed=154, failed=0, skipped=0)

#### Commit Messages (Final candidates) — 5개 중 1개 선택

1. 테스트 / Expense 값 현실화 (0.009% → 0.95%, TQQQ 실제 비율 반영)
2. 테스트 / TQQQ 시뮬레이션 테스트 데이터 정확성 개선
3. 테스트 / Expense 테스트 값 통일 및 부동소수점 표기 정리
4. 테스트 / TQQQ 비용 테스트 픽스처 일관성 확보
5. 테스트 / 운용비율 테스트 데이터 수정 (conftest 픽스처와 통일)

## 7) 리스크(Risks)

**리스크 1: 테스트 실패 가능성**
- Expense 값이 100배 증가하면서 일부 테스트의 예상값 범위 초과 가능
- 완화책: 각 테스트의 예상값을 정확히 재계산하고, 테스트 실행으로 검증

**리스크 2: 놓친 위치 존재 가능성**
- Grep으로 찾지 못한 Expense 관련 주석이나 값이 있을 수 있음
- 완화책: 전체 테스트 실행으로 검증, Ruff 검사로 이상 코드 탐지

## 8) 메모(Notes)

### 주요 결정 사항

1. **Expense 값 결정**: `0.0095` (0.95%)
   - 근거: `conftest.py`의 `sample_expense_df` 픽스처 기준
   - 근거: 실제 TQQQ의 expense ratio와 유사

2. **부동소수점 표기 정리**:
   - `8.999999999999999e-05` → `0.0095`로 통일
   - 이는 단순 표기법 변경이 아니라 값 자체도 수정 (`0.00009` → `0.0095`)

3. **영향 범위**:
   - 총 18개 위치 수정 예상 (값 6개 + 과학적 표기 12개)
   - 관련 주석 약 8개 수정

### 진행 로그 (KST)

- 2025-12-29 21:07: 계획서 작성 완료
- 2025-12-29 21:08: Phase 1 시작 (Expense 값 수정)
- 2025-12-29 21:09: Phase 1 완료 (모든 값 수정 완료, 테스트 통과)
- 2025-12-29 21:10: 마지막 Phase 시작 (Black 포맷 적용)
- 2025-12-29 21:12: 최종 검증 완료, 계획서 Done 처리

---
