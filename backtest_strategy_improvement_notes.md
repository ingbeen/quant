# 버퍼존 전략 개선 방안 분석

> 이 문서는 QQQ 시그널 + TQQQ 매매 버퍼존 전략의 2000~2010년 구간 손실 원인을 분석하고,
> 개선 방안 3가지를 초보자 관점에서 정리한 것입니다.

---

## 1. 용어 정리

### 기본 용어

| 용어 | 설명 |
|------|------|
| **SMA (Simple Moving Average)** | 단순이동평균. 최근 N일간 종가의 산술 평균. 예: SMA150은 최근 150일 종가의 평균 |
| **버퍼존 (Buffer Zone)** | 이동평균 위/아래에 두는 완충 구간. 예: 4% 버퍼면 MA*1.04 위에서 매수, MA*0.96 아래에서 매도. 노이즈로 인한 잦은 매매를 줄이기 위한 장치 |
| **Whipsaw (휩소)** | 매수 직후 하락 → 매도, 매도 직후 상승하는 반복 손실 패턴. 횡보장에서 자주 발생 |
| **CAGR (Compound Annual Growth Rate)** | 연평균 복합 성장률. "매년 평균 몇 % 벌었는가"를 나타내는 지표 |
| **MDD (Maximum Drawdown)** | 최대낙폭. 고점 대비 최대 하락 폭. "최악의 경우 얼마나 깨질 수 있는가"를 나타냄 |
| **베어마켓 랠리 (Bear Market Rally)** | 하락장 중간에 일시적으로 강하게 반등하는 구간. 추세 전환처럼 보이지만 다시 하락하는 "속임수 반등" |

### 개선안 관련 용어

| 용어 | 설명 |
|------|------|
| **ATR (Average True Range)** | 평균 진정 범위. 최근 N일간 가격이 하루에 평균적으로 얼마나 크게 움직였는지를 나타내는 변동성 지표. 방향(상승/하락)은 구분하지 않음 |
| **True Range (진정 범위)** | 하루의 실제 변동폭. 다음 3가지 중 가장 큰 값: (1) 당일 고가-저가, (2) 당일 고가-전일 종가, (3) 전일 종가-당일 저가. 갭(전일 종가와 당일 시가의 차이)도 반영하기 위한 방법 |
| **ADX (Average Directional Index)** | 평균 방향성 지수. 현재 시장의 추세가 강한지 약한지를 0~100 사이 숫자로 나타냄. 방향(상승/하락)은 구분하지 않고 오직 "추세의 강도"만 측정 |
| **+DI / -DI** | ADX를 계산할 때 함께 나오는 보조 지표. +DI는 상승 방향의 힘, -DI는 하락 방향의 힘. ADX 자체는 이 둘의 차이의 크기를 평균낸 것 |
| **Stop Loss (손절)** | 손실이 일정 수준에 도달하면 자동으로 매도하여 추가 손실을 차단하는 규칙. 예: 진입가 대비 -20% 도달 시 매도 |
| **적응형 (Adaptive)** | 시장 상황에 따라 파라미터가 자동으로 조절되는 방식. 고정 값 대신 시장 변동성 등에 연동 |
| **RSI (Relative Strength Index)** | 상대강도지수. 최근 N일간 상승폭과 하락폭의 비율로 0~100 사이 값을 산출. 70 이상이면 과매수(overbought), 30 이하면 과매도(oversold)로 판단 |
| **Trailing Stop** | 추적 손절. 가격이 올라가면 손절선도 따라 올라가는 방식. 고점 대비 N% 하락하면 매도. 수익을 보호하면서 추세를 따라가는 장치 |
| **부분 익절 (Partial Take Profit)** | 전체 물량을 한 번에 매도하지 않고, 일부만 먼저 수익 확정하는 방식. 고점 반납 위험을 줄이면서 나머지 물량으로 추가 상승을 노림 |

---

## 2. 현재 전략의 문제 진단

### 현재 전략 구조

```
매수 조건: QQQ 종가 > MA(N) * (1 + buffer_zone_pct)
매도 조건: QQQ 종가 < MA(N) * (1 - buffer_zone_pct)
체결 시점: 다음 거래일 시가
```

### 핵심 문제: 고정 버퍼가 시장 상황을 반영하지 못함

현재 버퍼존은 항상 동일한 비율(예: 4%)을 사용한다.
하지만 시장의 변동성은 시기마다 크게 다르다.

```
안정기 (2004~2006):
- QQQ 하루 변동폭: 약 0.5~1.0%
- 버퍼 4%: 충분히 넓음 → 노이즈를 잘 걸러냄

폭락 후 회복기 (2001~2002):
- QQQ 하루 변동폭: 약 2.0~4.0%
- 버퍼 4%: 하루 변동폭보다 작음 → 노이즈에 속아서 진입
```

비유하면, **신발 사이즈를 하나만 정해놓고 모든 사람에게 신기는 것**과 같다.
발이 큰 사람(변동성 큰 시장)에게는 너무 작고,
발이 작은 사람(변동성 작은 시장)에게는 너무 크다.

### 실제 사례: 2002-01-09 매수 → -39.38% 손실

```
배경:
  2001-09-21  QQQ 23.81 (9/11 저점)
       ↓  +52% 베어마켓 랠리 (약 2.5개월)
  2001-12-05  QQQ 36.19 (반등 고점)
       ↓  하락 재개
  2002-01-09  QQQ 34.72  ← 여기서 매수 신호 발생
  2002-02-07  QQQ 29.72  ← 매도 (TQQQ 기준 -39.38% 손실)
       ↓  하락 계속
  2002-10-09  QQQ 16.94 (최종 저점)
```

원인:
- 9/11 이후 강한 반등이 MA150 * 1.04를 돌파할 만큼 충분했음
- 하지만 MA150 자체는 여전히 하락 중 (추세 전환이 아님)
- 고정 4% 버퍼로는 이 "속임수 반등"을 구별할 수 없었음

---

## 3. 개선 방안

### 방안 1: ATR 적응형 버퍼 (고정 % → 변동성 연동)

#### 개념

고정 비율 버퍼를 ATR(변동성 지표) 기반으로 교체한다.
시장이 크게 흔들릴 때는 버퍼가 자동으로 넓어지고,
시장이 조용할 때는 버퍼가 자동으로 좁아진다.

#### 현재 방식 vs 개선 방식

```
현재:
  매수 = 종가 > MA(N) + MA(N) * 0.04        (항상 4%)
  매도 = 종가 < MA(N) - MA(N) * 0.04        (항상 4%)

개선:
  매수 = 종가 > MA(N) + k * ATR(20)          (변동성에 비례)
  매도 = 종가 < MA(N) - k * ATR(20)          (변동성에 비례)

  k = ATR 배수 (시작값으로 1.5 권장)
```

#### ATR 계산 방법

```
1단계: 매일 True Range를 구한다
  TR = max(당일고가 - 당일저가,
           |당일고가 - 전일종가|,
           |당일저가 - 전일종가|)

2단계: 최근 20일간 TR의 평균을 구한다
  ATR(20) = 최근 20일 TR의 단순 평균

예시:
  QQQ가 하루에 보통 1.5포인트 움직이면 → ATR(20) ≈ 1.5
  QQQ가 하루에 보통 3.0포인트 움직이면 → ATR(20) ≈ 3.0
```

#### 2002-01-09에 적용하면?

```
당시 상황 (추정):
  MA150 ≈ 33.5
  ATR(20) ≈ 1.5 ~ 2.0 (닷컴 이후 변동성 극심)
  k = 1.5

매수 조건: 종가 > 33.5 + 1.5 * 1.75 = 33.5 + 2.625 = 36.125
실제 종가: 34.72

→ 34.72 < 36.125 이므로 매수 신호가 발생하지 않음
→ -39.38% 손실을 완전히 회피
```

비교:

```
고정 4% 버퍼:  33.5 * 1.04 = 34.84  → 34.72로 거의 도달 (며칠 뒤 돌파)
ATR 버퍼:      33.5 + 2.63 = 36.13  → 34.72로는 도달 불가능
```

#### 장단점

| 장점 | 단점 |
|------|------|
| 변동성 큰 시기에 자동으로 보수적 | k값 선택이 필요 (과최적화 주의) |
| 변동성 작은 시기에 적절히 민감 | ATR 계산을 위한 고가/저가 데이터 필요 |
| 고정 버퍼의 근본 한계 해결 | |

---

### 방안 2: ADX 모드 스위치 (추세 약하면 거래 금지)

#### 개념

ADX는 "지금 시장에 추세가 있는가?"를 숫자로 알려주는 지표다.
ADX가 낮으면 횡보장이므로 아예 매매를 하지 않는다.

```
ADX 값의 의미 (일반적 해석):

  0 ─────── 10 ─────── 20 ─────── 25 ─────── 40+
  |  추세 없음(횡보)  |   약한 추세   |   강한 추세    |
                      ↑
              이 지점을 기준으로 거래 ON/OFF
```

#### 현재 방식 vs 개선 방식

```
현재:
  MA 돌파 신호가 나오면 무조건 매매

개선:
  ADX(14) >= 20 일 때만 매매 허용
  ADX(14) < 20 이면 신호가 나와도 무시 (현금/대기자산 보유)
```

#### ADX 계산 방법 (개념)

```
1단계: +DM과 -DM을 구한다 (방향성 움직임)
  +DM = 당일고가 - 전일고가  (양수일 때만, 아니면 0)
  -DM = 전일저가 - 당일저가  (양수일 때만, 아니면 0)
  둘 다 양수면 큰 쪽만 남기고 작은 쪽은 0

2단계: +DI와 -DI를 구한다 (방향성 지수)
  +DI = (+DM의 14일 평균) / ATR(14) * 100
  -DI = (-DM의 14일 평균) / ATR(14) * 100

3단계: DX를 구한다 (방향성 지수의 차이)
  DX = |+DI - -DI| / (+DI + -DI) * 100

4단계: ADX = DX의 14일 평균

쉽게 말하면:
  +DI와 -DI의 차이가 크면 → 한쪽 방향으로 강하게 밀리는 중 → ADX 높음
  +DI와 -DI의 차이가 작으면 → 양쪽이 팽팽 → ADX 낮음 (횡보)
```

#### 2002-01-09에 적용하면?

```
당시 상황:
  2001-09 ~ 2002-01: 급락 → 급반등 → 재하락
  가격이 양방향으로 크게 왔다갔다
  → +DI와 -DI가 번갈아 우세
  → ADX는 낮은 상태 (추세 없음)

ADX(14) < 20 (추정) → 매매 금지 → 진입하지 않음
```

#### MA 기울기 필터와의 비교

```
MA 기울기 필터 (우리가 앞서 제안):
  "MA가 상승 중인가?" → 방향만 봄
  문제: MA가 아주 미세하게 상승하는 횡보에서는 속을 수 있음

ADX 모드 스위치 (전략 노트):
  "추세가 강한가?" → 강도를 봄
  장점: 방향 무관하게 추세 없으면 거래 안 함
  → 완만한 횡보에서 MA 기울기보다 효과적
```

#### 장단점

| 장점 | 단점 |
|------|------|
| 횡보 구간 거래를 구조적으로 차단 | 추세 초입을 놓칠 수 있음 (ADX는 후행 지표) |
| 구현이 단순 (ON/OFF 스위치) | 임계값(20 vs 25) 선택 필요 |
| MA 기울기보다 정교 | ADX 계산을 위한 고가/저가 데이터 필요 |

---

### 방안 3: Stop Loss (최대 손실 제한)

#### 개념

현재 전략은 MA 하향 돌파 시에만 매도한다.
매수 후 가격이 아무리 떨어져도, MA를 깨기 전까지는 계속 보유한다.
이 때문에 한 번의 거래에서 -39%까지 손실이 커질 수 있다.

Stop Loss는 "진입가 대비 N% 하락하면 MA 신호와 무관하게 즉시 매도"하는 규칙이다.

#### 현재 방식 vs 개선 방식

```
현재:
  매도 조건: QQQ 종가 < MA * (1 - buffer)  (MA 기준으로만 판단)

개선 (Stop Loss 추가):
  매도 조건 1: QQQ 종가 < MA * (1 - buffer)  (기존 MA 기반 매도)
  매도 조건 2: TQQQ 현재가 < 진입가 * (1 - stop_loss_pct)  (손절)
  → 둘 중 하나라도 충족되면 매도
```

#### 2002-01-09에 적용하면?

```
진입가: TQQQ 1.65 (2002-01-09)
stop_loss_pct = 0.20 (20%)
손절선: 1.65 * 0.80 = 1.32

실제 가격 흐름:
  01-09: 1.65 (매수)
  01-14: 1.47
  01-16: 1.36
  01-22: 1.30 ← 손절선(1.32) 도달, 다음날 시가에 매도

손실: 약 -20% (실제 -39%에서 절반으로 감소)
```

#### 주의사항: TQQQ의 높은 변동성

```
TQQQ는 QQQ의 3배 레버리지이므로 일일 변동이 매우 크다.

예: QQQ가 하루 -3% → TQQQ는 약 -9%

stop_loss를 너무 좁게 잡으면:
  -10%: 정상적인 조정에서도 빈번하게 손절됨 (과다 매매)
  -15%: 여전히 잦은 손절 가능성
  -20%: TQQQ 기준으로 적당한 수준 (QQQ 약 -7% 수준에 해당)
  -25%: 보수적 (큰 손실은 허용하되 치명적 손실만 방지)
```

#### 장단점

| 장점 | 단점 |
|------|------|
| 단일 거래의 최대 손실을 제한 | TQQQ 변동성으로 정상 조정에서도 손절 가능 |
| 구현이 가장 단순 | 손절 후 재진입 타이밍 문제 |
| 다른 방안과 독립적으로 결합 가능 | 손절 비율 결정이 필요 |

---

### 방안 4: ATR Trailing 부분 익절 (수익 중 고점 반납 방지)

#### 배경: MDD는 손실 거래만의 문제가 아니다

실제 백테스트 데이터를 분석하면, MDD의 주요 원인은 **수익 거래 내 고점 반납**이다.
전체 16개 거래 중 11개가 수익으로 끝났지만, 보유 중 고점 대비 -30% ~ -74%까지 하락한 구간이 존재한다.

```
실제 데이터 (수익 거래 내 중간 drawdown):

  거래               최종 손익     중간 최대 DD   설명
  ─────────────────────────────────────────────────────────
  2020-04 ~ 2022-01   +228%        -39%          3배로 불었다가 고점 대비 39% 반납
  2019-03 ~ 2020-03   +22%         -48%          코로나 직격탄 (수익이 한때 +73%)
  2013-03 ~ 2015-08   +148%        -41%          중국발 폭락으로 고점 반납
  1999-04 ~ 2000-04   +45%         -74%          닷컴 고점에서 급락 (한때 +461%)
```

현재 전략의 구조적 한계:

```
100% 매수 → 장기 보유 → 100% 매도 (MA 하향돌파 시)

문제:
  - MA 하향돌파 시점은 이미 고점 대비 상당히 떨어진 후
  - 그 사이 고점 수익의 30~70%를 반납
  - all-or-nothing 구조이므로 중간에 수익을 확보할 방법이 없음
```

#### 개념

보유 중 일정 수익에 도달하면 ATR 기반 trailing stop을 활성화하여 부분 익절한다.
나머지 물량은 기존 MA 시그널로 매도한다.

#### RSI 대신 ATR Trailing Stop을 선택한 이유

```
RSI 방식의 문제:
  RSI > 70~80이면 과매수 → 익절

  실제 문제:
  - TQQQ는 강한 상승 추세에서 RSI가 70~80 이상을 수 주~수 개월 유지
  - RSI 70에서 익절했다면 2020-04 거래에서 +30% 부근에 절반을 팔게 됨
  - 실제로 +228%까지 갈 수 있었던 수익을 크게 깎음
  - 즉, 추세추종 전략에서 RSI는 조기 익절의 위험이 큼

ATR Trailing Stop 방식의 장점:
  - 강한 추세에서는 stop이 계속 올라감 → 조기 익절 안 함
  - 변동성이 커지면 stop이 넓어짐 → 정상 조정에 걸리지 않음
  - 변동성이 줄면 stop이 좁아짐 → 반전 시 빠르게 반응
  - 추세추종 전략과 철학적으로 일치 (추세를 따라가되, 반전 시 보호)
```

#### 현재 방식 vs 개선 방식

```
현재:
  매수: 100% 물량 매수
  보유: MA 하향돌파 전까지 전량 보유
  매도: MA 하향돌파 시 100% 매도

개선 (ATR Trailing 부분 익절):
  매수: 100% 물량 매수
  보유 중:
    1단계: 진입가 대비 +50% 도달 → trailing stop 활성화
    2단계: 고점 - k * ATR(20) 이탈 시 → 50% 물량 익절
    3단계: 나머지 50%는 기존 MA 시그널로 매도
  매도: 기존 MA 하향돌파 OR trailing stop
```

#### ATR Trailing Stop 동작 방식

```
1단계: trailing stop 비활성 상태 (기존과 동일)
  - 매수 후 수익률이 activate_pct(50%) 미만이면 trailing stop 미작동
  - 기존 전략 그대로 동작

2단계: trailing stop 활성화
  - 수익률 >= activate_pct 달성 시 trailing stop 활성화
  - 매일 고점(highest close)을 갱신
  - trailing_stop_line = highest_close - k * ATR(20)

3단계: 부분 익절 실행
  - 종가 < trailing_stop_line 이탈 시
  - 보유 물량의 partial_sell_ratio(50%)를 다음 날 시가에 매도
  - 나머지 물량은 기존 MA 시그널로 계속 보유

파라미터:
  activate_pct = 0.50      # trailing stop 활성화 수익률 (0.50 = 50%)
  atr_multiplier = 3.0     # ATR 배수 (높을수록 느슨한 stop)
  partial_sell_ratio = 0.50 # 부분 매도 비율 (0.50 = 50%)
```

#### 2020-04 ~ 2022-01 거래에 적용하면? (추정)

```
실제 흐름:
  2020-04-20: TQQQ 매수 (진입가 7.82)
  2020-08경:  +50% 도달 → trailing stop 활성화
  2021-11-19: 고점 도달 (TQQQ 약 25.7)
  2021-12~:   고점에서 하락 시작
  2022-01:    trailing stop 이탈 → 50% 익절

결과:
  현재: +228%에서 전량 매도 (고점 +260%에서 32%p 반납)
  개선: 50%를 고점 근처(-ATR*3)에서 먼저 익절
       → 부분 익절분은 약 +200~220% 수준에서 확보
       → 나머지 50%는 기존대로 +228%에서 매도
       → 전체 MDD가 줄어듦 (노출 금액이 절반)
```

#### 장단점

| 장점 | 단점 |
|------|------|
| 수익 거래의 고점 반납을 구조적으로 방지 | 파라미터 3개 (activate_pct, atr_multiplier, partial_sell_ratio) |
| 추세추종 철학과 일치 (추세를 따라가되 반전 시 보호) | 부분 매도 후 잔여 포지션 관리 복잡성 |
| RSI보다 TQQQ 특성에 적합 (강한 추세에서 조기 익절 방지) | 부분 매도 후 재상승 시 기회비용 |
| 다른 매수 개선 방안과 독립적으로 결합 가능 | |

---

## 4. 방안 조합 시 기대 효과

### 주요 거래에 각 방안 적용 결과 (추정)

방안 1~3은 매수 진입 개선 (나쁜 진입 차단 또는 손실 제한), 방안 4는 매도 개선 (수익 보호).

| 거래 | 손익률 | 중간 최대 DD | ATR 버퍼 | ADX 스위치 | Stop Loss | 부분 익절 |
|------|--------|-------------|----------|-----------|-----------|----------|
| 2000-06 ~ 2000-09 | -32.5% | -44% | 차단 가능 | 차단 가능 | -20% 제한 | 해당 없음 (손실) |
| 2004-11 ~ 2005-04 | -20.9% | -26% | 효과 제한적 | 차단 가능 | -20% 제한 | 해당 없음 (손실) |
| 2008-05 ~ 2008-07 | -25.5% | -28% | 차단 가능 | 효과 제한적 | -20% 제한 | 해당 없음 (손실) |
| 2015-10 ~ 2016-01 | -22.8% | -26% | 효과 제한적 | 차단 가능 | -20% 제한 | 해당 없음 (손실) |
| 1999-04 ~ 2000-04 | **+45%** | **-74%** | - | - | - | **고점 +461%에서 절반 보호** |
| 2013-03 ~ 2015-08 | **+148%** | **-41%** | - | - | - | **고점 +195%에서 절반 보호** |
| 2019-03 ~ 2020-03 | **+22%** | **-48%** | - | - | - | **고점 +73%에서 절반 보호** |
| 2020-04 ~ 2022-01 | **+228%** | **-39%** | - | - | - | **고점 +260%에서 절반 보호** |

- **ATR 버퍼** (매수 개선): 변동성 극심한 시기의 나쁜 진입 차단
- **ADX 스위치** (매수 개선): 횡보 구간의 whipsaw 차단
- **Stop Loss** (매도 개선): 손실 거래의 최대 손실 제한
- **부분 익절** (매도 개선): 수익 거래의 고점 반납 방지 → **MDD에 가장 직접적인 영향**

### 방안 분류

```
매수 개선 (진입 품질 향상):
  방안 1: ATR 적응형 버퍼 → 나쁜 진입 자체를 차단
  방안 2: ADX 모드 스위치 → 횡보장에서 진입 차단

매도 개선 (보유 중 손실 관리):
  방안 3: Stop Loss → 손실 거래의 하한선 설정
  방안 4: ATR Trailing 부분 익절 → 수익 거래의 고점 반납 방지
```

---

## 5. 참고: 전략 노트에서 추가로 언급된 개념

이 프로젝트에 당장 적용하지는 않지만, 알아두면 좋은 개념들이다.

### KAMA (Kaufman's Adaptive Moving Average)

적응형 이동평균. 시장이 횡보하면 둔감하게, 추세가 나오면 민감하게 반응하도록
자동 조절되는 이동평균. 현재 사용 중인 고정 SMA/EMA의 상위 호환 개념.

### 대기자산 (초단기채 ETF)

비보유 기간에 현금 대신 초단기 국채 ETF(예: SGOV)를 보유하여 이자 수익을 얻는 방법.
2000~2007년처럼 금리가 높은 시기에는 연 2~5%의 추가 수익이 가능했을 것.
현재 백테스트에서는 비보유 기간 수익이 0%로 계산되고 있음.

### 듀얼 엔진 (추세추종 + 횡보 엔진)

추세장에서는 추세추종 전략을 실행하고,
횡보장에서는 별도의 횡보 전략(평균회귀, 커버드콜 등)을 실행하는 방식.
ADX를 모드 스위치로 사용하여 두 엔진을 전환한다.

### 멀티 자산 분산

한 시장(예: QQQ)만 거래하면 해당 시장의 장기 횡보에 취약하다.
여러 자산군(주식, 채권, 원자재 등)에 동일한 추세추종을 적용하면
한 시장의 횡보 위험을 분산할 수 있다.
