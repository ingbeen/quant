# 유틸리티 패키지 가이드

> 이 문서는 `src/qbt/utils/` 패키지의 공통 유틸리티에 대한 상세 가이드입니다.
> 프로젝트 전반의 공통 규칙은 [루트 CLAUDE.md](../../../CLAUDE.md)를 참고하세요.

## 패키지 목적

유틸리티 패키지는 프로젝트 전반에서 공통으로 사용되는 횡단 관심사(cross-cutting concerns)를 제공합니다.
도메인 로직과 독립적인 기술적 기능을 담당합니다.

---

## 핵심 책임

### 1. 로깅 인프라

**로거 설정**:

- 프로젝트 전역 로거 생성 및 관리
- 레벨별 필터링
- 포맷 표준화

**클릭 가능한 경로**:

- VSCode 통합을 위한 상대 경로 포맷
- 프로젝트 루트 자동 감지
- 파일:줄번호 형식

**동적 레벨 조정**:

- 런타임 로그 레벨 변경
- 모듈별 독립적 설정

### 2. 데이터 로딩 통합

**중앙 집중식 CSV 로딩**:

- 모든 CSV 파일 로딩을 단일 인터페이스로 제공
- 타입별 로더 (주식 데이터, 금리 데이터, 비교 데이터)
- 자동 전처리 적용

**전처리 단계**:

- 파일 존재 확인
- 필수 컬럼 검증
- 날짜 파싱 및 통일
- 시간순 정렬
- 중복 제거

**순환 임포트 방지**:

- 도메인 모듈들이 서로 임포트할 필요 없이 utils를 통해 로딩

### 3. CLI 예외 처리

**데코레이터 패턴** (`cli_helpers.py`):

- 일관된 예외 처리 로직 제공
- 스택 트레이스 자동 기록
- 종료 코드 자동 반환 (성공 0, 실패 1)

**로거 자동 감지**:

- 데코레이팅된 함수의 모듈에서 `logger` 변수 검색
- 폴백 로거 지원

**표준 예외 핸들링**:

- FileNotFoundError, ValueError 등 표준 예외
- 도메인 커스텀 예외
- 일반 예외 (Exception)

### 4. 병렬 처리

**프로세스 풀 관리** (`parallel_executor.py`):

- CPU 집약적 작업을 여러 프로세스로 분산
- 최적 워커 수 자동 결정 (CPU 코어 수 기반)
- 입력 순서 보장된 결과 반환

**두 가지 실행 모드**:

- `execute_parallel`: 단일 인자 함수 병렬 실행
- `execute_parallel_with_kwargs`: 키워드 인자 함수 병렬 실행

**진행도 추적**:

- 완료 작업 수 로깅 (DEBUG 레벨)
- 백분율 계산 및 출력

**플랫폼 호환성**:

- Windows pickle 제약 고려 (람다 함수 불가)
- 모듈 레벨 헬퍼 함수 사용 (`_unwrap_kwargs`)

### 5. 터미널 출력 포맷팅

**문자폭 계산** (`formatting.py`):

- 다국어 문자 인코딩별 폭 계산
- 동아시아 문자 처리 (한글 = 2칸, 영문 = 1칸)
- `unicodedata.east_asian_width` 활용

**셀 정렬**:

- 좌/우/중앙 정렬 지원
- 패딩 계산
- 목표 폭 맞추기

**테이블 출력** (`TableLogger` 클래스):

- 컬럼 정의 기반 테이블 생성
- 헤더/데이터/푸터 구조
- 로거 통합 (DEBUG 레벨)

### 6. 실행 메타데이터 관리

**메타데이터 저장** (`meta_manager.py`):

- CSV 결과 파일의 생성 정보를 JSON으로 관리
- 실행 시각, 파라미터, 통계 등 메타 정보 저장
- 최근 N개 이력만 순환 저장 (디스크 사용량 제한)

**지원 타입**:

- `grid_results`: 백테스트 그리드 서치 메타데이터
- `tqqq_validation`: TQQQ 검증 메타데이터
- `tqqq_daily_comparison`: TQQQ 일별 비교 메타데이터

**주요 함수**:

- `save_metadata()`: 메타데이터를 meta.json에 저장 (자동 타임스탬프 추가)
- `load_metadata()`: 전체 또는 특정 타입의 메타데이터 조회

---

## 설계 원칙

### 도메인 독립성

- 특정 도메인 로직에 의존하지 않음
- 재사용 가능한 일반 기능만 제공

### 최소 의존성

- 외부 라이브러리 최소화
- 표준 라이브러리 우선 사용

### 명확한 책임

- 각 모듈은 하나의 관심사만 담당
- 모듈 간 의존성 최소화

### 오류 투명성

- 예외를 숨기거나 변환하지 않음
- 명확한 에러 메시지

---

## 사용 패턴

### 로깅 초기화 (CLI 계층)

CLI 스크립트 시작 시:

1. 로거 설정
2. 레벨 지정 (기본 DEBUG)
3. 모듈 전역 변수로 저장

### 데이터 로딩 (모든 계층)

데이터 필요 시:

1. 적절한 로더 함수 호출
2. 경로만 전달
3. 전처리된 DataFrame 수령

### CLI 예외 처리 (CLI 계층)

main 함수 정의 시:

1. 데코레이터 적용
2. 로거 변수 정의
3. 비즈니스 로직 호출
4. 종료 코드 반환

### 병렬 처리 (비즈니스 로직)

CPU 집약 작업 시:

1. pickle 가능한 함수 정의
2. 입력 리스트 준비
3. 병렬 실행 함수 호출
4. 순서 보장된 결과 수령

### 테이블 출력 (CLI 계층)

테이블 형식 로그 시:

1. 컬럼 정의 (이름, 폭, 정 렬)
2. 테이블 로거 인스턴스 생성
3. 헤더 출력
4. 행 반복 출력
5. 푸터 출력

### 메타데이터 저장 (CLI 계층)

CSV 결과 저장 후:

1. 메타데이터 딕셔너리 구성 (파라미터, 통계 등)
2. `save_metadata()` 호출 (타입과 메타데이터 전달)
3. 자동 타임스탬프 추가 및 순환 저장

---

## 제약사항

### 로깅

- INFO 레벨 사용 금지
- 로그 메시지는 한글, 이모지 금지
- 함수명은 자동 포함되므로 중복 기재 금지

### 병렬 처리

- 함수는 pickle 가능해야 함 (람다 불가)
- 전역 상태 공유 불가
- Windows 환경에서는 `if __name__ == "__main__"` 보호 필요

### 테이블 출력

- 컬럼 수와 데이터 수 일치 필수
- 폭 부족 시 원본 문자열 반환 (잘림 없음)

---

## 확장 가이드

### 새로운 로더 추가

- 타입별 전처리 로직 캡슐화
- 필수 컬럼 검증
- 일관된 반환 타입 (DataFrame)

### 새로운 예외 타입 추가

- 핸들러 목록에 등록
- 구체적 타입부터 나열 (상속 고려)

### 병렬 처리 확장

- 새로운 실행 모드는 기존 패턴 재사용
- 입력 순서 보장 유지
