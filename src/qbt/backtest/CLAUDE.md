# 백테스트 도메인 가이드

> 이 문서는 `src/qbt/backtest/` 패키지의 백테스트 도메인에 대한 상세 가이드입니다.
> 프로젝트 전반의 공통 규칙은 [루트 CLAUDE.md](../../../CLAUDE.md)를 참고하세요.

## 도메인 목적

백테스트 도메인은 과거 데이터를 기반으로 거래 전략을 시뮬레이션하고 성과를 측정합니다.

---

## 모듈 구성

### 1. analysis.py

이동평균 계산 및 성과 지표 계산 기능을 제공합니다.

**주요 함수**:

- `add_single_moving_average()`: 단일 이동평균 계산 및 컬럼 추가
- `calculate_summary()`: 거래 내역과 자본 곡선으로부터 요약 지표 계산

**계산 지표**:

- 수익률 지표: 절대 수익률, 총 수익률 (%), 연평균 복리 수익률 (CAGR)
- 리스크 지표: 최대 낙폭 (MDD), 자본 곡선 추적
- 거래 통계: 총 거래 횟수, 승률, 수익/손실 거래 분포

### 2. strategy.py

전략 실행 엔진을 제공합니다.

**버퍼존 전략**:

- 이동평균선 주변에 허용 범위를 설정
- 가격이 범위를 벗어날 때 거래 신호 생성
- 최근 거래 빈도에 따라 파라미터를 동적으로 조정

**벤치마크 전략**:

- 매수 후 보유 전략 구현
- 전략 성과 비교 기준 제공

**실행 규칙**:

- 단방향 포지션만 허용 (공매도 없음)
- 한 번에 하나의 포지션만 보유
- 거래 비용 적용

**체결 타이밍 규칙** (신호 발생과 체결 실행의 분리):

- **신호 발생**: T일 종가 기준으로 상단/하단 밴드 돌파 감지
- **유지조건 확인**: T+1일 ~ T+hold_days일 종가가 밴드 내부에 유지되는지 체크
- **체결 실행**: T+hold_days+1일 시가에 실제 매수/매도
  - hold_days=0인 경우 T+1일 시가에 체결
- **슬리피지 적용**:
  - 매수: 시가 × (1 + 0.003) = 시가 × 1.003
  - 매도: 시가 × (1 - 0.003) = 시가 × 0.997
- **에쿼티 기록**: 각 날짜의 에쿼티는 해당일에 실행된 주문 이후 상태를 반영
  - 신호 발생일에는 아직 포지션이 없으므로 position=0
  - 체결일부터 포지션이 반영됨

**파라미터 최적화**:

- 그리드 탐색: 다차원 파라미터 조합 탐색
- 병렬 처리로 성능 최적화
- 동적 조정: 최근 거래 빈도 분석 및 자동 조정

---

## 도메인 규칙

### 전략 파라미터

**이동평균 기간**:

- 추세 판단의 기준 기간
- 장기/단기 전략 구분
- 범위는 `constants.py`에서 정의

**버퍼존**:

- 이동평균선 주변 허용 범위 (비율)
- 거래 빈도 조절 수단
- 최소값 이상 유지

**유지 조건**:

- 신호 확정까지 대기 기간
- 잦은 거래 방지
- 버퍼존만 사용하는 모드 지원

**조정 기간**:

- 최근 거래를 분석할 기간
- 동적 파라미터 조정 범위

### 비용 모델

**거래 비용**:

- 매수/매도 시 일정 비율 적용
- 수수료와 슬리피지 통합
- 비용 비율은 `constants.py`에서 정의

### 검증 규칙

**최소 데이터 요구사항**:

- 백테스트에 필요한 최소 데이터 행 수 검증
- 유효하지 않은 경우 즉시 예외 발생

**필수 컬럼**:

- Date, Open, Close 등 필수 필드 검증
- `common_constants.py`의 `REQUIRED_COLUMNS` 사용

---

## 구현 원칙

### 데이터 불변성

- 원본 DataFrame을 변경하지 않음
- 계산 시 복사본 사용

### 명시적 검증

- 파라미터 유효성 즉시 검증
- 유효하지 않은 입력 시 즉시 예외

### 상태 비저장

- 함수는 상태를 유지하지 않음
- 모든 입력을 파라미터로 전달

### 병렬 처리 지원

- 독립적인 백테스트는 병렬 실행 가능
- 순서 보장 필요 시 중앙 병렬 처리 모듈 사용

---

## 출력 형식

### 거래 내역

- 거래 일자, 방향, 가격, 수량, 손익

### 자본 곡선

- 시간에 따른 자본 변화 추적
- 포지션 상태 기록

### 요약 지표

- 수익률, 리스크, 거래 통계를 포함한 딕셔너리

### 그리드 탐색 결과

- 파라미터 조합별 성과 지표
- 한글 컬럼명으로 변환하여 저장
